# Cursor Rules для vovaipetrova-core

## Режим работы с блоками задач

**ВАЖНО**: Пользователь работает с блоками задач, а не с отдельными PR. Агент должен самостоятельно доводить задачи до мерджа, проверяя отчеты ботов и исправляя ошибки.

### Процесс работы с блоком задач:

1. **Получение блока задач**: Пользователь дает блок задач (например, "Блок A — RAG: подготовка данных")
2. **Выполнение задач**: Агент выполняет задачи последовательно или параллельно, создавая PR для каждой задачи или группы задач
3. **Автоматическая проверка перед мерджем**: Перед каждым мерджем PR агент ОБЯЗАН проверить отчеты ботов
4. **Исправление ошибок**: Агент самостоятельно исправляет ошибки, если они не требуют решения пользователя
5. **Мердж PR**: После успешных проверок агент мерджит PR самостоятельно

### Правила проверки ботов перед мерджем:

**ОБЯЗАТЕЛЬНО перед каждым `gh pr merge`:**

1. Проверить статус всех проверок:
   ```bash
   gh pr checks <номер>
   ```

2. Проверить комментарии ботов на наличие ошибок:
   ```bash
   gh pr view <номер> --json comments | jq '.comments[] | select(.author.is_bot == true) | .body' | grep -i "error\|fail\|regression"
   ```

3. Проверить failed checks детально:
   ```bash
   gh pr checks <номер> | grep -i "fail\|error"
   ```

4. Если есть failed checks:
   - Проверить детали через `gh run view <run-id> --log-failed`
   - Исправить ошибки самостоятельно, если они очевидны (линтер, форматирование, битые ссылки)
   - Если ошибка требует решения пользователя — сообщить и не мерджить

5. Проверить mergeable статус:
   ```bash
   gh pr view <номер> --json mergeable,mergeStateStatus
   ```

**Что исправлять самостоятельно:**
- Ошибки линтера (lint:docs, lint:terms)
- Битые ссылки (link regression)
- Проблемы форматирования
- Конфликты при мердже с main (разрешать автоматически)
- Проблемы с кодировкой

**Что НЕ исправлять самостоятельно:**
- Архитектурные решения
- Изменения в бизнес-логике
- Вопросы, требующие обсуждения с пользователем

### Последовательность мерджа PR:

При работе с несколькими PR из одного блока задач:
1. Мерджить PR по порядку создания (старые → новые)
2. После каждого мерджа обновлять локальный main: `git checkout main && git pull`
3. Если следующий PR имеет конфликты — обновить его ветку с main перед мерджем

## Создание Pull Request

**КРИТИЧЕСКИ ВАЖНО**: При создании PR ВСЕГДА используйте скрипт `create-pr-safe.mjs` вместо прямого вызова `gh pr create`.

### Правильный способ создания PR:

1. Создайте файл с описанием PR:
   ```bash
   echo "Описание PR" > tmp-pr-body.txt
   ```

2. Используйте безопасный скрипт:
   ```bash
   npm run pr:create-safe -- --title "Заголовок PR" --body-file tmp-pr-body.txt
   ```

3. Удалите временный файл после создания PR:
   ```bash
   rm tmp-pr-body.txt
   ```

### НЕПРАВИЛЬНО:
```bash
gh pr create --title "Заголовок" --body "Описание"
```

### Почему это важно:
- Скрипт гарантирует правильную кодировку UTF-8 через временные файлы
- Обеспечивает корректную обработку многострочного текста и специальных символов

## Кодировка файлов

Все файлы должны быть в кодировке UTF-8 без BOM. Перед коммитом проверьте кодировку в статус-баре редактора.

## Коммит-сообщения

Коммит-сообщения должны быть на русском языке, UTF-8. Используйте:
```bash
git commit -m "feat: описание изменений"
```

## Автоматический мердж PR

**ВАЖНО**: Агент должен самостоятельно мерджить PR после успешных проверок, не спрашивая разрешения у пользователя.

### Процесс автоматического мерджа:

1. Выполнить все проверки ботов (см. выше)
2. Если все проверки прошли или есть только non-blocking warnings:
   ```bash
   gh pr merge <номер> --squash --delete-branch
   ```
3. Если есть blocking errors — исправить и повторить проверку
4. После мерджа обновить локальный main для следующего PR

### Исключения:

- Не мерджить, если пользователь явно просит подождать
- Не мерджить, если есть архитектурные вопросы в комментариях
- Сообщать пользователю о мердже после факта (если он не отслеживает сам)
