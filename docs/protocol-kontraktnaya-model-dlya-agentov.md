---
title: Protocol — Контрактная модель для агентов
slug: protocol-kontraktnaya-model-dlya-agentov
summary: '# Protocol — Контрактная модель для агентов'
tags: []
machine_tags: []
---
# Protocol — Контрактная модель для агентов

Контрактная модель определяет правила взаимодействия агентов с репозиторием, входные/выходные данные, запреты и QA-ворота.

## Вход агента

### Источник задачи
- **Notion Briefs**: карточка в статусе `Ready` с полями `Brief`, `Scope`, `Deliverables`
- **GitHub Issues**: опционально, для трекинга и связи с PR

### Контекст проекта
- `/.codegpt/context.md` — общий контекст (источник истины, ветви, линтеры, CI, lanes)
- `docs/protocol-kontraktnaya-model-dlya-agentov.md` — этот документ (правила работы)
- `CONTRIBUTING.md` — процесс работы с репозиторием
- `README.md` — структура и команды

## Выход агента

### Обязательные артефакты
1. **Ветка**: `{type}/{short-description}` (например, `chore/stories-pause-note`)
2. **Коммиты**: Conventional Commits (`feat:`, `fix:`, `chore:`, `docs:`, `refactor:`)
3. **Pull Request**: с описанием изменений, ссылкой на задачу в Briefs и секцией Deliverables
4. **Deliverables**: соответствие списку из Briefs, оформленное по стандартному шаблону

### Формат Deliverables в PR

Каждый PR должен содержать секцию `## Deliverables` со следующей структурой:

```markdown
## Deliverables

**Executor**: {Имя агента или исполнителя}  
**Status**: ✅ Completed | ⏳ In Progress | ❌ Blocked  
**Task**: {Ссылка на задачу в Notion Briefs или Issue}

### Completed
- [x] {Пункт 1 из списка Deliverables}
- [x] {Пункт 2 из списка Deliverables}

### Changes
- {Описание изменений 1}
- {Описание изменений 2}

### Files Changed
- `path/to/file1.md` — {описание изменений}
- `path/to/file2.js` — {описание изменений}

### PRs Created
- #{номер} — {название PR} (если создавались связанные PR)

### Metrics
- {Метрика 1, если применимо}
- {Метрика 2, если применимо}

### Problems Encountered
- {Проблема 1, если была}
- {Проблема 2, если была}

### Proposals
- {Предложение по улучшению, если есть}
```

**Обязательные поля**: Executor, Status, Task, Completed  
**Опциональные поля**: Changes, Files Changed, PRs Created, Metrics, Problems Encountered, Proposals

### Формат коммитов
```
{type}: {краткое описание}

- Деталь 1
- Деталь 2
- Деталь 3
```

Типы: `feat`, `fix`, `chore`, `docs`, `refactor`

## Запреты

### Структурные запреты
- ❌ Не менять файлы в `scripts/`, `.github/workflows/` без явного указания в Briefs
- ❌ Не создавать файлы вне `docs/`, `prototype/`, `templates/` без согласования
- ❌ Не удалять файлы с `notion_page_id` без `git mv` (см. `check-import-safety.mjs`)

### Процессные запреты
- ❌ Не мерджить PR без зелёного CI (`Docs CI` должен быть успешным)
- ❌ Не создавать несколько PR из одной ветки (см. Lanes policy)
- ❌ Не коммитить напрямую в `main` (только через PR)

### Контентные запреты
- ❌ Не добавлять PII (пути пользователей, имена, email, телефоны) — см. `scripts/pii-scan.mjs`
- ❌ Не использовать первое лицо в Stories (`я`, `мы` разрешены, но не личные имена)
- ❌ Не создавать файлы без front matter (title, slug, summary)

## QA-ворота

### Перед созданием PR
1. ✅ Запустить `npm run normalize:dry` — проверить изменения
2. ✅ Запустить `npm run lint:docs` — проверить качество контента
3. ✅ Запустить `npm run check:pr-size` — проверить размер PR
4. ✅ Запустить `npm run check:lanes` — проверить соответствие Lanes policy
5. ✅ Проверить соответствие Deliverables из Briefs
6. ✅ Убедиться, что ветка соответствует Lanes policy (один PR на lane)

### В PR
1. ✅ Описание изменений соответствует Brief
2. ✅ Ссылка на задачу в Notion Briefs (если есть)
3. ✅ CI зелёный (`Docs CI` должен пройти)

### После мерджа
1. ✅ Обновить статус задачи в Notion Briefs (если доступен API)
2. ✅ Удалить ветку (если не `notion-sync/*`)

## Lanes Policy

**Один PR на lane** — правило предотвращает конфликты и упрощает ревью.

### Lanes (типы веток)
- `chore/*` — инфраструктура, документация, процессы
- `feat/*` — новые возможности, разделы
- `fix/*` — исправления, багфиксы
- `docs/*` — текстовые правки без изменения логики
- `refactor/*` — структурные изменения без фич
- `notion-sync/*` — импорт из Notion (автоматика)

### Lane Labels (для группировки и проверки)

Для автоматической проверки политики "один PR на lane" используются GitHub labels формата `lane:*`:

- `lane:docs` — работа с документацией (`docs/*`, `docs/**`)
- `lane:infra` — инфраструктура (`chore/*`, workflows, scripts)
- `lane:stories` — эпизоды Stories (`docs/stories/**`)
- `lane:characters` — работа с персонажами и контентом
- `lane:qa` — проверки качества, линтинг, тесты
- `lane:refactor` — рефакторинг кода и структуры
- `lane:fix` — исправления и багфиксы
- `lane:feat` — новые возможности
- `lane:composer` — задачи, выполняемые через Composer (изолированная дорожка)

**Маппинг префиксов веток → labels:**
- `chore/*` → `lane:infra`
- `feat/*` → `lane:feat`
- `fix/*` → `lane:fix`
- `docs/*` → `lane:docs`
- `refactor/*` → `lane:refactor`
- `composer/*` → `lane:composer` (задачи Composer)
- `notion-sync/*` → обычно без label (автоматика)

### Правила
- Одна ветка = один PR = одна задача из Briefs
- Если нужно сделать несколько связанных изменений — объединить в одну задачу или создать последовательные PR
- После мерджа PR ветку можно удалить (кроме `notion-sync/*`)
- **При создании PR добавляйте соответствующий label `lane:*`** для автоматической проверки конфликтов
- CI автоматически проверяет наличие других открытых PR с тем же `lane:*` label и **блокирует PR при конфликтах**
- Ветки `notion-sync/*` автоматически пропускают проверку lanes
- **Задачи Composer (`lane:composer`) изолированы** — только один активный PR на этой lane в любой момент времени

### Size Guard v2

CI автоматически проверяет размер PR для упрощения ревью:

**Лимиты (настраиваемые через GitHub Variables):**
- Максимальное количество файлов: **50** (по умолчанию)
- Максимальное количество добавлений: **2000 строк** (по умолчанию)
- Максимальное количество удалений: **1000 строк** (по умолчанию)

**Исключения:**
- Автоматически генерируемые файлы (`prototype/page/*.html`, `prototype/data/*.json`) не учитываются
- Временные файлы (`tmp-*`) исключаются из подсчёта

**Поведение:**
- Превышение лимитов на 50%+ → ошибка (блокирует PR)
- Превышение лимитов менее 50% → предупреждение (не блокирует)
- Проверка неблокирующая, но рекомендуется разбивать большие PR на несколько меньших

**Команды:**
- `npm run check:pr-size` — локальная проверка размера PR
- `npm run check:lanes` — локальная проверка lanes policy
- `node scripts/test-guardrails.mjs` — тестирование guardrails (эмуляция нарушений)

### Content Lint Thresholds

Линтер проверяет качество контента с настраиваемыми порогами:

**Пороги для summary:**
- Пустой summary → предупреждение (ошибка в строгом режиме `--strict`)
- Длина summary > 300 символов → предупреждение

**Пороги для контента:**
- Длина контента > 50,000 символов → предупреждение
- Длина контента > 100,000 символов → ошибка (блокирует)

**Проверки PII (персональные данные):**
- Пути пользователей (`C:\Users\...`, `/home/...`) → ошибка для stories, предупреждение для других
- Email адреса → ошибка для stories, предупреждение для других
- Телефонные номера → ошибка для stories, предупреждение для других

**Команды:**
- `npm run lint:docs` — стандартная проверка (предупреждения не блокируют)
- `npm run lint:docs:strict` — строгая проверка (предупреждения блокируют)

### Очереди ревью и SLA

Для обеспечения предсказуемости процесса ревью и управления нагрузкой используются очереди ревью с фиксированными SLA.

#### Очереди ревью

**Composer Queue (`lane:composer`):**
- Изолированная очередь для задач, выполняемых через Composer
- Максимум **1 активный PR** в любой момент времени
- Приоритет: высокий (изоляция предотвращает конфликты)
- Статусы в Briefs: `Ready` → `In Progress` → `Review` → `Done`

**Стандартные очереди:**
- `lane:docs` — документация (до 3 активных PR)
- `lane:infra` — инфраструктура (до 2 активных PR)
- `lane:feat` — новые возможности (до 2 активных PR)
- `lane:fix` — исправления (до 3 активных PR)
- `lane:stories` — эпизоды Stories (до 2 активных PR)
- Остальные lanes: до 2 активных PR

#### SLA (Service Level Agreement)

**Время ревью:**
- **Composer PR**: до 24 часов с момента создания PR
- **Стандартные PR**: до 48 часов с момента создания PR
- **Срочные PR** (label `urgent`): до 12 часов

**Метрики:**
- Время от создания PR до первого комментария ревьюера
- Время от создания PR до мерджа
- Процент PR, закрытых в рамках SLA

**Эскалация:**
- Если PR не получил ревью в течение SLA + 50% времени → ping в комментариях
- Если PR заблокирован более 72 часов → автоматический комментарий с предложением разбить на меньшие PR

#### Статусы в Briefs

Для отслеживания прогресса задач используются следующие статусы:

- `Ready` — задача готова к выполнению
- `In Progress` — задача выполняется (ветка создана, PR в работе)
- `Review` — PR создан, ожидает ревью
- `Done` — PR смерджен, задача завершена
- `Blocked` — задача заблокирована (требуется дополнительная информация или внешние зависимости)

**Маппинг статусов → этапы:**
- `Ready` → агент берёт задачу, создаёт ветку
- `In Progress` → агент работает над задачей
- `Review` → PR создан, CI проходит, ожидается ревью
- `Done` → PR смерджен, ветка удалена, deliverables обновлены

### Тестирование Guardrails

Для проверки корректности работы guardrails используется скрипт `scripts/test-guardrails.mjs`:

**Тесты:**
- `--test-lanes` — тестирование Lanes Policy (one-PR-per-lane)
- `--test-size` — тестирование Size Guard
- `--test-lint` — тестирование Lint Thresholds

**Пример использования:**
```bash
# Запустить все тесты
node scripts/test-guardrails.mjs

# Запустить только тест lanes
node scripts/test-guardrails.mjs --test-lanes

# Запустить тесты size и lint
node scripts/test-guardrails.mjs --test-size --test-lint
```

**Тестовые файлы с плохими примерами:**
- `test-guardrails/bad-examples/` — примеры нарушений для проверки линтера

## Процесс работы агента

1. **Чтение задачи**: получить Brief из Notion или Issue
2. **Подготовка**: прочитать контекст (`/.codegpt/context.md`, `docs/protocol-kontraktnaya-model-dlya-agentov.md`)
3. **Выполнение**: создать ветку, внести изменения, проверить локально
4. **Проверка перед PR**:
   - `npm run normalize:dry` — проверить изменения нормализации
   - `npm run lint:docs` — проверить качество контента
   - `npm run check:pr-size` — проверить размер PR
   - `npm run check:lanes` — проверить соответствие Lanes policy
   - Проверить соответствие Deliverables из Briefs
5. **PR**: создать Pull Request с описанием, секцией Deliverables и соответствующим `lane:*` label
6. **Ожидание**: дождаться зелёного CI (`Docs CI` должен пройти)
7. **Мердж**: после одобрения смерджить PR
8. **Завершение**: обновить статус в Briefs, удалить ветку (если не `notion-sync/*`)

## Связано с

- `CONTRIBUTING.md` — процесс работы с репозиторием
- `/.codegpt/context.md` — контекст проекта
- `docs/rfcs/rfc-xxxx-nazvanie-rfc.md` — шаблон для RFC (для крупных изменений)

