---
title: CONCEPT — Dual-story формат (spec + пример)
slug: concept-stories-dual
summary: >-
  Спецификация формата dual-story: две параллельные линии (авторская рефлексия + машинный отчёт) в одном эпизоде Stories
tags:
  - Story
  - Проектирование
machine_tags:
  - content/story
  - theme/design
status: ready
---

# CONCEPT — Dual-story формат (spec + пример)

## TL;DR

- **Dual-story** — формат эпизода Stories с двумя параллельными линиями: авторской рефлексией и машинным отчётом
- Авторская линия — художественная рефлексия, нейтральный голос, избегает личных имён
- Машинная линия — фактический отчёт, привязан к PR/commits/ADR, структурирован по шаблону
- Обе линии публикуются вместе в одном Markdown-файле и визуально различаются

## Философия dual-story

### Зачем нужен dual-story формат

1. **Два взгляда на одно событие**: авторская рефлексия даёт эмоциональный и философский контекст, машинный отчёт — факты и технические детали
2. **Баланс искусства и точности**: художественная часть привлекает внимание и объясняет "почему", техническая часть — "что" и "как"
3. **Историческая ценность**: через годы можно увидеть и эмоциональный контекст решения, и технические детали реализации
4. **Гибкость публикации**: можно публиковать обе линии вместе или раздельно в зависимости от аудитории

### Принципы

- **Авторская линия**: нейтральный голос, без персоналий, художественная рефлексия, избегает технических деталей
- **Машинная линия**: структурированный отчёт по шаблону Stories (что произошло → зачем → что получилось → тех-вставка → что дальше)
- **Визуальное различие**: обе линии должны визуально отличаться при рендеринге (разные стили, иконки, цвета)
- **Связь через front matter**: обе линии связаны через `machine_report_refs` (PR, commits, issues)

## Спецификация формата

### Front matter

```yaml
---
title: "XXX — Название эпизода"
slug: "XXX-kratkoe-opisanie"
summary: "Краткая аннотация, описывающая обе линии"
tags: [Story]
machine_tags: [content/story]
status: draft | review | ready
story_type: dual
last_edited_time: null
author_block:
  teaser: "Короткая аннотация авторской части для индексирования"
machine_report_refs:
  prs: [123, 456]
  commits: ["a1b2c3d", "e4f5g6h"]
  issues: [789]
visuals:
  author_prompt: "описание промпта для генерации изображения авторской части"
  report_prompt: "описание промпта для генерации изображения машинного отчёта"
  assets: []  # пути к сохранённым изображениям
links:
  related_adr: ["adr-slug"]
  related_brief: ["brief-page-id"]
metrics:
  impact_estimate: "высокий | средний | низкий"
  time_saved: 120  # минуты
  files_changed: 15
---
```

### Обязательные поля

- `title` — название эпизода
- `slug` — kebab-case идентификатор
- `summary` — краткая аннотация
- `tags` — массив тегов (минимум `[Story]`)
- `machine_tags` — массив машинных тегов (минимум `[content/story]`)
- `status` — статус эпизода (`draft`, `review`, `ready`)
- `story_type: dual` — указание на dual-story формат

### Опциональные поля

- `author_block.teaser` — аннотация авторской части для индексирования
- `machine_report_refs` — ссылки на PR, commits, issues
- `visuals` — промпты и пути к изображениям
- `links` — связанные ADR и Briefs
- `metrics` — метрики влияния и изменений

### Структура контента

```markdown
# TL;DR

- Краткое резюме обеих линий (3–5 пунктов)
- Что произошло: краткое описание события
- Зачем: мотивация
- Что получилось: результаты
- Что дальше: следующие шаги

<!-- AUTHOR_BLOCK START -->
Авторская рефлексия

Художественный текст, описывающий эмоциональный и философский контекст события.
Нейтральный голос, без персоналий, избегает технических деталей.
Может быть поэтическим, метафорическим, рефлексивным.
<!-- AUTHOR_BLOCK END -->

<!-- MACHINE_REPORT START -->
Что произошло: [структурированное описание события]

Зачем это делали: [мотивация и цели]

Что получилось: [результаты и артефакты]

Тех-вставка: [технические детали, 2–3 предложения]

Что дальше: [следующие шаги или планы]
<!-- MACHINE_REPORT END -->
```

### Правила оформления

1. **Разделители блоков**: использовать HTML-комментарии `<!-- AUTHOR_BLOCK START -->` и `<!-- MACHINE_REPORT START -->`
2. **Авторская линия**: должна быть заключена между `<!-- AUTHOR_BLOCK START -->` и `<!-- AUTHOR_BLOCK END -->`
3. **Машинная линия**: должна быть заключена между `<!-- MACHINE_REPORT START -->` и `<!-- MACHINE_REPORT END -->`
4. **TL;DR**: общий для обеих линий, размещается в начале документа
5. **Структура машинного отчёта**: должна следовать стандартному шаблону Stories

## Пример: dual-story эпизод

```markdown
---
title: "001 — Когда CI молчит, а мысль кричит"
slug: 001-kogda-ci-molchit
summary: "Короткая рефлексия автора и машинный отчёт о недавнем обновлении normalize"
tags: [Story]
machine_tags: [content/story]
status: draft
story_type: dual
machine_report_refs:
  prs: [123]
  commits: ["a1b2c3d"]
visuals:
  author_prompt: "surreal collage: a lone thinker in a server room, soft chiaroscuro, paper maps turning into code, cinematic"
  report_prompt: "documentary scene: engineers merging PR, terminal windows, green CI badge, muted palette"
  assets: []
---

# TL;DR

- Авторская мысль: порядок кода и беспокойство мысли — парадокс развития.
- Что произошло: вмержен PR #123, добавлен скрипт normalize.
- Зачем: упростить импорт из Notion и стабилизировать slug.
- Что получилось: сборка превью обновлена, линт — зелёный.
- Что дальше: добавить тесты на slug-normalization.

<!-- AUTHOR_BLOCK START -->
В коридорах, где свет от экранов стал мерцанием времени, возникло ощущение контраста: гладкий порядок логических цепочек и неукротимый шум мысли. Код шёл по рельсам — аккуратно, машинно — а внутри продолжали рождаться вопросы без ответа: зачем упорядочивать, если порядок лишь временный фасад, за которым притаилась новая непонятая ситуация? Это не жалоба — это попытка слушать, как идея становится инструментом и как инструмент учит нас смотреть по‑новому.
<!-- AUTHOR_BLOCK END -->

<!-- MACHINE_REPORT START -->
Что произошло: Вмержен PR #123 — добавлен `scripts/normalize` и исправлены percent-encoded ссылки.

Зачем это делали: Упростить импорт из Notion, стандартизировать slug и уменьшить ручные исправления.

Что получилось: Скрипт успешно нормализует slug, CI показал зелёный прогон линтеров; превью сайта обновлено автоматом.

Тех-вставка: `scripts/fix-links.mjs` использует map-slug и регулярные выражения для замены percent-encoded символов. Тестовый набор содержит 12 кейсов для различных языков и спецсимволов.

Что дальше: добавить unit-tests для slug-normalization и мониторинг ошибок импорта; план — покрыть edge-cases и запустить nightly-check.
<!-- MACHINE_REPORT END -->
```

## Процесс создания dual-story

### Ручное создание

1. Используйте шаблон `templates/story.md` как основу
2. Добавьте `story_type: dual` в front matter
3. Заполните `machine_report_refs` (PR, commits, issues)
4. Напишите авторскую рефлексию между `<!-- AUTHOR_BLOCK START -->` и `<!-- AUTHOR_BLOCK END -->`
5. Заполните машинный отчёт между `<!-- MACHINE_REPORT START -->` и `<!-- MACHINE_REPORT END -->`
6. Проверьте соответствие формату и линтерам

### Автоматическая генерация

Генератор `scripts/generate-stories.mjs` может создавать машинный отчёт автоматически:

1. Читает CHANGELOG.md, ADR, stats.json и Briefs
2. Извлекает факты и события
3. Создаёт машинный отчёт по шаблону
4. Авторская часть добавляется вручную или через human-in-the-loop процесс

### Workflow для dual-story

1. **Триггер**: merge PR, milestone, или ручной запуск
2. **Генерация машинного отчёта**: `scripts/generate-stories.mjs` создаёт `MACHINE_REPORT` блок
3. **Авторская часть**: автор пишет рефлексию вручную или через OPUS4/агента
4. **Визуальные промпты**: генерируются на основе обеих линий, сохраняются в `visuals`
5. **Проверки**: `npm run pii:scan`, `npm run lint:docs`, `npm run normalize:dry`
6. **Публикация**: создание PR с меткой `content/story`

## Визуализация

### Рендеринг dual-story

При рендеринге dual-story на сайте:

- **Авторская линия**: отображается с особым стилем (курсив, другой цвет, иконка пера)
- **Машинная линия**: отображается с техническим стилем (моноширинный шрифт, иконка кода)
- **Изображения**: авторская часть использует `visuals.author_prompt`, машинная — `visuals.report_prompt`
- **Ссылки**: PR, commits, issues автоматически линкуются из `machine_report_refs`

### Пример CSS-стилей

```css
.author-block {
  font-style: italic;
  color: #6b7280;
  border-left: 3px solid #9ca3af;
  padding-left: 1rem;
}

.machine-report {
  font-family: 'Courier New', monospace;
  background-color: #f3f4f6;
  border-left: 3px solid #3b82f6;
  padding-left: 1rem;
}
```

## Правила работы

### Safety Rails

- ❌ Не использовать первое лицо с именами реальных людей в авторской части
- ✅ Использовать анонимные плейсхолдеры: `[Имя]`, `[Email]`
- ✅ Авторская часть должна быть нейтральной, без персоналий
- ✅ Машинная часть должна быть фактологической и структурированной
- ✅ Проверка PII обязательна перед PR (`npm run pii:scan`)

### QA-ворота

Перед PR:
1. ✅ Обе линии заполнены (AUTHOR_BLOCK и MACHINE_REPORT)
2. ✅ Front matter содержит `story_type: dual`
3. ✅ `machine_report_refs` заполнены (если применимо)
4. ✅ Проверка формата (700–1200 знаков для машинной части)
5. ✅ Проверка PII (`npm run pii:scan`)
6. ✅ Проверка линтинга (`npm run lint:docs`)

## Интеграция в проект

### Explorer

Dual-story эпизоды интегрированы в Explorer через `prototype/build-index.mjs`:

- Поле `collection: "stories"` в front matter
- Поле `story_type: dual` для фильтрации
- Поле `story_order` из slug для сортировки
- Отображение в ленте Stories на сайте

### Навигация

- Лента Stories: https://utemix-lab.github.io/vovaipetrova-core/#stories-panel
- Все эпизоды: `docs/stories/`
- Пример dual-story: `docs/stories/001-opus4-example-dual.md`
- Шаблон: `templates/story.md`

## Связанные документы

- [Stories — Концепция и принципы](./CONCEPT.md) — общая концепция Stories
- [CONCEPT — Opus4 notes](./CONCEPT.opus4-notes.md) — рабочие заметки по dual-story
- [Шаблон story.md](../../templates/story.md) — шаблон для создания эпизодов
 - [JSON Schema для Story](./models/story.schema.json) — схема для валидации

