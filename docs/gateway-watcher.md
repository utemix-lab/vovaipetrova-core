---
title: Gateway Watcher — валидация контента из inbox/author
slug: gateway-watcher
summary: >-
  Автоматическая валидация и обработка файлов из inbox/author с проверкой PII,
  длины и тона
status: ready
tags:
  - Автоматизация
  - Валидация
machine_tags:
  - action/build
  - theme/automation
---

# Gateway Watcher — валидация контента из inbox/author

## TL;DR

Gateway Watcher мониторит папку `inbox/author` на наличие новых файлов Markdown, валидирует их по трём критериям (PII, длина, тон) и при успешной валидации добавляет идеи в очередь `tmp/ideas.json` для дальнейшей обработки через Author Gateway.

## Назначение

Gateway Watcher автоматизирует процесс валидации контента от авторов перед добавлением в очередь генерации Stories:

1. **Захват файлов** из папки `inbox/author`
2. **Валидация PII** — проверка на наличие персональных данных (пути пользователей, email, телефоны, имена)
3. **Валидация длины** — проверка минимальной (50 символов) и максимальной (100,000 символов) длины контента
4. **Валидация тона** — проверка на запрещённые фразы для Stories (личные местоимения "я", "мне", "мой" и т.д.)

## Использование

### Разовое сканирование

```bash
npm run gateway:scan
```

Сканирует папку `inbox/author` и обрабатывает все найденные `.md` файлы.

### Обработка конкретного файла

```bash
node scripts/gateway-watcher.mjs --file=path/to/file.md
```

### Dry-run (проверка без добавления в очередь)

```bash
node scripts/gateway-watcher.mjs --dry-run
```

### Режим постоянного мониторинга

Для режима watch требуется установка `chokidar`:

```bash
npm install chokidar
npm run gateway:watch
```

## Формат файлов

Файлы в `inbox/author` должны быть в формате Markdown с фронт-маттером:

```yaml
---
title: "Название идеи"
author: "автор"
---

Содержимое идеи для генерации Story...
```

## Процесс валидации

### 1. Проверка PII

Watcher проверяет контент на наличие:
- Путей пользователей (`C:\Users\...`, `/home/...`)
- Email адресов
- Телефонных номеров
- Полных имён (русских и английских)
- API ключей и токенов
- Номеров кредитных карт
- IP адресов

**Ошибка блокирует добавление в очередь.**

### 2. Проверка длины

- **Минимум**: 50 символов (ошибка)
- **Рекомендуемый максимум**: 50,000 символов (предупреждение)
- **Критический максимум**: 100,000 символов (ошибка)

**Ошибка блокирует добавление в очередь.**

### 3. Проверка тона

Проверка на запрещённые фразы для Stories:
- "я ", "я,", "мне", "меня", "мой", "моя", "мои"
- "я считаю", "я думаю", "я хочу"
- "по-моему", "по моему"
- "дмитрий"

**Предупреждение не блокирует, но логируется.**

## Результат валидации

### Успешная валидация

При успешной валидации файл:
1. Добавляется в очередь `tmp/ideas.json` со статусом `approved`
2. Перемещается в `inbox/author/.processed/` с временной меткой
3. Оригинальный файл удаляется (можно отключить в коде)

Структура добавленной идеи:

```json
{
  "id": "idea-1234567890",
  "status": "approved",
  "title": "Название идеи",
  "seed_text": "Первые 500 символов контента...",
  "created_at": "2025-11-24T10:00:00.000Z",
  "author": "автор",
  "source_file": "inbox/author/file.md",
  "content_length": 1234
}
```

### Ошибки валидации

При ошибках валидации:
- Файл остаётся в `inbox/author`
- Ошибки логируются в консоль
- Файл не добавляется в очередь

## Интеграция с Author Gateway

После успешной валидации идеи попадают в очередь `tmp/ideas.json` и могут быть обработаны через Author Gateway:

```bash
node scripts/author-gateway.mjs --mode=auto
```

Author Gateway автоматически берёт первую идею со статусом `approved` из очереди и использует её для генерации Story.

## Примеры использования

### Пример 1: Добавление идеи в inbox

1. Создайте файл `inbox/author/my-idea.md`:

```markdown
---
title: "Идея для Story"
author: "автор"
---

Короткое описание идеи для генерации контента...
```

2. Запустите watcher:

```bash
npm run gateway:scan
```

3. Проверьте очередь:

```bash
cat tmp/ideas.json
```

### Пример 2: Проверка перед добавлением

```bash
node scripts/gateway-watcher.mjs --file=inbox/author/test.md --dry-run
```

Это покажет результаты валидации без добавления в очередь.

## Настройка порогов

Пороги валидации можно изменить в `scripts/gateway-watcher.mjs`:

```javascript
const CONTENT_MIN_LENGTH = 50;        // Минимум
const CONTENT_MAX_LENGTH = 50000;     // Предупреждение
const CONTENT_CRITICAL_LENGTH = 100000; // Ошибка
```

## Логирование

Watcher выводит подробные логи:
- `✅` — успешная обработка
- `⚠️` — предупреждения (не блокируют)
- `ERROR:` — ошибки (блокируют добавление)

## Связанные компоненты

- **Author Gateway** (`scripts/author-gateway.mjs`) — обработка очереди идей
- **PII Scanner** (`scripts/pii-scan.mjs`) — сканирование репозитория на PII
- **Docs Linter** (`scripts/lint-docs.mjs`) — валидация документации

## Troubleshooting

### Файлы не обрабатываются

- Убедитесь, что файлы имеют расширение `.md`
- Проверьте, что файлы не начинаются с `.` (скрытые файлы игнорируются)
- Убедитесь, что файлы находятся в `inbox/author/`, а не в подпапках

### Ошибки валидации PII

Если валидация PII срабатывает на ложные срабатывания:
- Используйте плейсхолдеры: `<user>`, `<email>`, `<phone>`
- Проверьте список исключений в коде (технические термины автоматически исключаются)

### Файлы не удаляются после обработки

По умолчанию файлы перемещаются в `.processed/`, но не удаляются. Чтобы включить удаление, раскомментируйте строку `unlinkSync(filePath)` в коде.

