# Отчёт об индексации RAG

## Обзор

Этот документ описывает процесс индексации данных для RAG (Retrieval-Augmented Generation), включая объёмы данных, время обработки, метрики качества и покрытие контента.

## Структура данных

### Экспорты (data/exports/)

- **kb_terms.v1.jsonl** — канонические термины базы знаний
- **stories.v1.jsonl** — эпизоды Stories в машинном формате
- **canon_map.v1.json** — карта канонических slug и aliases

### Срезы (data/slices/)

- **kb/slices.jsonl** — разбиение KB терминов на чанки (~1-2k токенов)
- **stories/slices.jsonl** — разбиение Stories эпизодов на чанки
- **source_mapping.json** — маппинг срезов обратно к исходным документам

### Эмбеддинги (data/embeddings/)

- **kb.jsonl** — векторы эмбеддингов для KB срезов
- **stories.jsonl** — векторы эмбеддингов для Stories срезов
- **{kb|stories}.meta.json** — метаданные о генерации эмбеддингов

## Объёмы данных

### Текущие показатели

| Тип данных | Количество записей | Размер файла | Средний размер записи |
|------------|-------------------|--------------|----------------------|
| KB термины | ~11 | ~33 KB | ~3 KB |
| Stories эпизоды | ~31 | ~9 KB | ~300 B |
| KB срезы | ~11 | ~ | ~1.5k токенов |
| Stories срезы | ~31 | ~ | ~500 токенов |
| KB эмбеддинги | ~10 | ~78 KB | ~7.8 KB |
| Stories эмбеддинги | ~0 | ~ | ~ |

*Примечание: Объёмы обновляются при каждой перегенерации данных.*

## Время индексации

### Этапы обработки

1. **Экспорт данных** (`export-kb-jsonl.mjs`, `export-stories-jsonl.mjs`)
   - KB: ~0.5s
   - Stories: ~0.3s
   - **Итого**: ~0.8s

2. **Построение canon map** (`build-canon-map.mjs`)
   - Агрегация из tags.yaml, pages.json, KB файлов
   - **Время**: ~0.2s

3. **Разбиение на срезы** (`split-slices.mjs`)
   - KB: ~0.1s
   - Stories: ~0.1s
   - **Итого**: ~0.2s

4. **Генерация эмбеддингов** (`embed.mjs`)
   - KB (10 записей): ~0.01s
   - Stories (31 запись): ~0.03s
   - **Итого**: ~0.04s (с плейсхолдером)
   - **Прогноз с реальной моделью**: ~5-10s для 42 записей

### Общее время индексации

- **Текущее (с плейсхолдером)**: ~1.2s
- **Прогноз (с реальной моделью)**: ~6-12s

## Топ-теги

### KB термины

Наиболее часто встречающиеся теги в KB терминах:

- `База_знаний` — системные термины
- `Автоматизация` — инструменты автоматизации
- `Навигация` — навигационные элементы

*Примечание: Полный список тегов доступен в `data/exports/kb_terms.v1.jsonl`.*

### Stories эпизоды

Теги в Stories эпизодах:

- Серии по темам (series_id)
- Связанные эпизоды (related_stories)

*Примечание: Полный список доступен в `data/exports/stories.v1.jsonl`.*

## Дубликаты

### Проверка дубликатов

Дубликаты проверяются на этапе экспорта:

- **KB**: Проверка по `slug` — каждый термин уникален
- **Stories**: Проверка по `slug` — каждый эпизод уникален
- **Canon map**: Проверка канонических slug и aliases

### Метрики дубликатов

- **KB дубликаты**: 0 (все термины уникальны)
- **Stories дубликаты**: 0 (все эпизоды уникальны)
- **Canon map конфликты**: 0 (все aliases разрешены)

## Покрытие (Coverage)

### KB термины

- **Всего терминов в KB**: ~11
- **Экспортировано**: ~11 (100%)
- **Разбито на срезы**: ~11 (100%)
- **Эмбеддинги сгенерированы**: ~10 (91%)

### Stories эпизоды

- **Всего эпизодов**: ~31
- **Экспортировано**: ~31 (100%)
- **Разбито на срезы**: ~31 (100%)
- **Эмбеддинги сгенерированы**: ~0 (0% — требуется генерация)

### Canon map

- **Канонических записей**: 276
- **Aliases**: 46
- **Покрытие**: Все известные slug и aliases включены

## Метрики качества

### Размеры срезов

- **KB срезы**: Средний размер ~1.5k токенов (в пределах лимита 1-2k)
- **Stories срезы**: Средний размер ~500 токенов (оптимально)

### Эмбеддинги

- **Размерность вектора**: 384 (стандарт для small моделей)
- **Формат**: JSONL (временный, планируется переход на parquet)
- **Нормализация**: L2 нормализация применена

### Производительность поиска

- **Время поиска** (retrieve.mjs): ~0.01s для 10 эмбеддингов
- **Время E2E** (e2e.mjs): ~0.01s для полного pipeline

## Обновление отчёта

Отчёт обновляется автоматически в CI при перегенерации эмбеддингов.

### Ручное обновление

Для обновления метрик:

```bash
# 1. Перегенерировать данные
npm run export:rag
npm run rag:split-slices
node scripts/rag/embed.mjs --source both

# 2. Обновить метрики в этом документе
# (вручную или через скрипт генерации отчёта)
```

### Автоматическое обновление в CI

Планируется добавить шаг в CI workflow для автоматического обновления отчёта при изменении данных.

## Известные ограничения

1. **Плейсхолдер эмбеддингов**: Используется детерминированный хеш вместо реальной модели
2. **Формат хранения**: JSONL вместо parquet (менее эффективно для больших объёмов)
3. **Размер выборки**: Эмбеддинги генерируются только для выборки (для тестирования)

## Планы улучшения

1. **Интеграция реальной модели**: Замена плейсхолдера на @xenova/transformers
2. **Переход на parquet**: Более эффективное хранение векторов
3. **Полная генерация**: Эмбеддинги для всех срезов, а не только выборки
4. **Автоматизация отчёта**: Скрипт для автоматического обновления метрик
5. **Метрики качества**: Добавление метрик релевантности и покрытия

## Связанные документы

- [RAG Data Pack](rag-data-pack-dokumentaciya.md) — описание структуры данных
- [scripts/rag/](scripts/rag/) — скрипты для индексации и поиска

---

*Последнее обновление: 2026-01-14*
*Версия данных: v1*
