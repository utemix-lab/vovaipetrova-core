/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

var j=Object.defineProperty;var K=Object.getOwnPropertyDescriptor;var X=Object.getOwnPropertyNames;var Z=Object.prototype.hasOwnProperty;var ee=(w,x)=>{for(var e in x)j(w,e,{get:x[e],enumerable:!0})},te=(w,x,e,t)=>{if(x&&typeof x=="object"||typeof x=="function")for(let n of X(x))!Z.call(w,n)&&n!==e&&j(w,n,{get:()=>x[n],enumerable:!(t=K(x,n))||t.enumerable});return w};var ne=w=>te(j({},"__esModule",{value:!0}),w);var ae={};ee(ae,{LETTA_CHAT_VIEW_TYPE:()=>$,LETTA_MEMORY_VIEW_TYPE:()=>F,RATE_LIMIT_MESSAGE:()=>P,default:()=>D});module.exports=ne(ae);var g=require("obsidian"),$="letta-chat-view",F="letta-memory-view",P={TITLE:"Rate Limit Exceeded - You've reached the rate limit for your account. Please wait a moment before sending another message.",UPGRADE_TEXT:"Need more? Letta Cloud offers Pro, Scale, and Enterprise plans:",BILLING_URL:"https://app.letta.com/settings/organization/billing",CUSTOM_KEYS_TEXT:"Or bring your own inference provider:",CUSTOM_KEYS_URL:"https://docs.letta.com/guides/cloud/custom-keys",create:w=>`${P.TITLE}

Reason: ${w}

${P.UPGRADE_TEXT}
${P.BILLING_URL}

${P.CUSTOM_KEYS_TEXT}
${P.CUSTOM_KEYS_URL}`},se={lettaApiKey:"",lettaBaseUrl:"https://api.letta.com",lettaProjectSlug:"",agentId:"",agentName:"Obsidian Assistant",sourceName:"obsidian-vault-files",autoSync:!0,syncOnStartup:!0,embeddingModel:"letta/letta-free",showReasoning:!0,enableStreaming:!0,focusMode:!1,allowAgentCreation:!0},D=class extends g.Plugin{constructor(){super(...arguments);this.agent=null;this.source=null;this.statusBarItem=null;this.uploadQueue=[];this.uploadsInLastMinute=[];this.isProcessingQueue=!1}async onload(){await this.loadSettings(),this.registerView($,e=>new R(e,this)),this.registerView(F,e=>new q(e,this)),this.addRibbonIcon("bot","Open Letta Chat",e=>{this.openChatView()}),this.addRibbonIcon("brain-circuit","Open Letta Memory Blocks",e=>{this.openMemoryView()}),this.statusBarItem=this.addStatusBarItem(),this.updateStatusBar("Disconnected"),this.addCommand({id:"open-letta-chat",name:"Open Letta Chat",callback:()=>{this.openChatView()}}),this.addCommand({id:"open-letta-memory",name:"Open Letta Memory Blocks",callback:()=>{this.openMemoryView()}}),this.addCommand({id:"sync-vault-to-letta",name:"Sync Vault to Letta",callback:async()=>{await this.syncVaultToLetta()}}),this.addCommand({id:"sync-current-file-to-letta",name:"Sync Current File to Letta",editorCallback:async(e,t)=>{await this.syncCurrentFile(t.file)}}),this.addCommand({id:"open-block-folder",name:"Open Letta Memory Blocks Folder",callback:async()=>{let e=this.app.vault.getAbstractFileByPath("Letta Memory Blocks");e&&e instanceof g.TFolder?(this.app.workspace.leftSplit.expand(),new g.Notice("\u{1F4C1} Letta Memory Blocks folder is now visible in the file explorer")):new g.Notice('Letta Memory Blocks folder not found. Use "Open Memory Block Files" to create it.')}}),this.addCommand({id:"connect-to-letta",name:"Connect to Letta",callback:async()=>{if(this.agent&&this.source){new g.Notice("Already connected to Letta");return}await this.connectToLetta()}}),this.addCommand({id:"disconnect-from-letta",name:"Disconnect from Letta",callback:()=>{this.agent=null,this.source=null,this.updateStatusBar("Disconnected"),new g.Notice("Disconnected from Letta")}}),this.addSettingTab(new U(this.app,this)),this.settings.lettaApiKey&&this.settings.syncOnStartup&&await this.connectToLetta(),this.settings.autoSync&&(this.registerEvent(this.app.vault.on("create",e=>{e instanceof g.TFile&&this.onFileChange(e)})),this.registerEvent(this.app.vault.on("modify",e=>{e instanceof g.TFile&&this.onFileChange(e)})),this.registerEvent(this.app.vault.on("delete",e=>{e instanceof g.TFile&&this.onFileDelete(e)}))),this.registerEvent(this.app.workspace.on("active-leaf-change",e=>{var n;let t=this.app.workspace.getActiveFile();console.log("[LETTA DEBUG] active-leaf-change event triggered"),console.log("[LETTA DEBUG] - focusMode:",this.settings.focusMode),console.log("[LETTA DEBUG] - leaf type:",(n=e==null?void 0:e.getViewState())==null?void 0:n.type),console.log("[LETTA DEBUG] - active file:",(t==null?void 0:t.path)||"null"),this.settings.focusMode&&this.onActiveFileChange()})),this.registerEvent(this.app.workspace.on("file-open",e=>{console.log("[LETTA DEBUG] file-open event:",(e==null?void 0:e.path)||"null"),this.settings.focusMode&&e&&e.path.endsWith(".md")&&(console.log("[LETTA DEBUG] file-open triggering focus mode update"),this.onActiveFileChange())})),this.registerEvent(this.app.workspace.on("layout-change",()=>{let e=this.app.workspace.getActiveFile();console.log("[LETTA DEBUG] layout-change event, active file:",(e==null?void 0:e.path)||"null")})),this.registerEvent(this.app.workspace.on("file-menu",(e,t)=>{t instanceof g.TFile&&t.path.endsWith(".md")&&e.addItem(n=>{n.setTitle("Sync to Letta").setIcon("bot").onClick(async()=>{await this.syncCurrentFile(t)})})}))}onunload(){this.agent=null,this.source=null}async loadSettings(){this.settings=Object.assign({},se,await this.loadData())}async saveSettings(){await this.saveData(this.settings)}getConnectionStatusText(){return this.settings.lettaBaseUrl.includes("api.letta.com")?`Connected to Letta Cloud${this.settings.lettaProjectSlug?` \u2022 ${this.settings.lettaProjectSlug}`:""}`:`Connected to ${this.settings.lettaBaseUrl}`}updateStatusBar(e){this.statusBarItem&&(e==="Connected"?this.statusBarItem.setText(""):this.statusBarItem.setText(e));let t=this.app.workspace.getLeavesOfType($)[0];t&&t.view instanceof R&&t.view.updateChatStatus()}async makeRequest(e,t={}){return this.makeRequestWithRetry(e,t,3)}async makeRequestWithRetry(e,t={},n=3){let s;for(let o=0;o<=n;o++)try{return await this.executeSingleRequest(e,t)}catch(a){if(s=a,a.isRateLimit&&o<n){let i=a.retryAfter?a.retryAfter*1e3:Math.pow(2,o)*1e3;console.log(`[Letta Plugin] Rate limited, waiting ${i}ms before retry ${o+1}/${n}`),await new Promise(l=>setTimeout(l,i));continue}throw a}throw s}async executeSingleRequest(e,t={}){var o,a,i,l,r;let n=`${this.settings.lettaBaseUrl}${e}`,s={...t.headers};this.settings.lettaApiKey&&(s.Authorization=`Bearer ${this.settings.lettaApiKey}`),t.isFileUpload||(s["Content-Type"]="application/json");try{let c;t.body&&typeof t.body=="string"&&((o=s["Content-Type"])!=null&&o.includes("multipart/form-data"))?c=t.body:t.isFileUpload&&t.formData?(c=t.formData,delete s["Content-Type"]):t.body&&(c=JSON.stringify(t.body));let d=await(0,g.requestUrl)({url:n,method:t.method||"GET",headers:s,body:c,throw:!1}),u=null;try{d.text&&(d.text.trim().startsWith("{")||d.text.trim().startsWith("["))&&(u=JSON.parse(d.text))}catch(h){}if(d.status>=400){let h=`HTTP ${d.status}: ${d.text}`;if(d.status===404)e==="/v1/models/embedding"?h=`Cannot connect to Letta API. Please verify:
\u2022 Base URL is correct
\u2022 Letta service is running
\u2022 Network connectivity is available`:e.includes("/v1/sources")?h=`Source not found. This may indicate:
\u2022 Invalid project configuration
\u2022 Missing permissions
\u2022 Source was deleted externally`:e==="/v1/agents"&&t.method==="POST"?h=`Failed to create agent. This may indicate:
\u2022 Invalid project ID
\u2022 Missing permissions
\u2022 API endpoint has changed
\u2022 Server configuration issue`:e.includes("/v1/agents")?h=`Agent not found. This may indicate:
\u2022 Invalid project configuration
\u2022 Missing permissions
\u2022 Agent was deleted externally`:e.includes("/v1/models/embedding")?h=`Embedding models endpoint not found. This may indicate:
\u2022 Outdated Letta API version
\u2022 Server configuration issue
\u2022 Invalid base URL`:h=`Endpoint not found (${e}). This may indicate:
\u2022 Incorrect base URL configuration
\u2022 Outdated plugin version
\u2022 API endpoint has changed`;else if(d.status===401)this.settings.lettaBaseUrl.includes("api.letta.com")&&!this.settings.lettaApiKey?h="Authentication required for Letta Cloud. Please provide an API key in settings.":this.settings.lettaApiKey?h="Authentication failed. Please verify your API key is correct and has proper permissions.":h="Authentication failed. If using a self-hosted instance with auth enabled, please provide an API key in settings.";else if(d.status===405)h=`Method not allowed for ${e}. This may indicate:
\u2022 Incorrect HTTP method
\u2022 API endpoint has changed
\u2022 Feature not supported in this Letta version`;else if(d.status===429){let y=((a=d.headers)==null?void 0:a["retry-after"])||((i=d.headers)==null?void 0:i["Retry-After"]),f=((l=d.headers)==null?void 0:l["x-ratelimit-reset"])||((r=d.headers)==null?void 0:r["X-RateLimit-Reset"]);if(h=`Rate limit exceeded. ${(u==null?void 0:u.detail)||d.text||"Please wait before making more requests."}`,y&&(h+=`
Retry after: ${y} seconds`),f)try{let v=new Date(parseInt(f)*1e3);h+=`
Rate limit resets at: ${v.toLocaleTimeString()}`}catch(v){h+=`
Rate limit reset: ${f}`}let m=new Error(h);throw m.isRateLimit=!0,m.retryAfter=y?parseInt(y):null,m}let p=new Error(h);throw p.status=d.status,p.responseText=d.text,p.responseJson=u,p}return u}catch(c){throw c.message&&(c.message.includes("fetch")||c.message.includes("network")||c.message.includes("ECONNREFUSED"))&&e==="/v1/models/embedding"?new Error(`Cannot connect to Letta API. Please verify:
\u2022 Base URL is correct
\u2022 Letta service is running
\u2022 Network connectivity is available`):(console.error("[Letta Plugin] Letta API request failed:",c),c)}}async getAgentCount(){try{let e=await this.makeRequest("/v1/agents");return e?e.length:0}catch(e){return console.error("[Letta Plugin] Failed to get agent count:",e),0}}async connectToLetta(e=1){let n=this.settings.lettaBaseUrl.includes("api.letta.com");if(e===1){try{new URL(this.settings.lettaBaseUrl)}catch(s){return new g.Notice(`Invalid Base URL format: ${this.settings.lettaBaseUrl}. Please check your settings.`),this.updateStatusBar("Invalid URL"),!1}if(this.settings.lettaBaseUrl.includes("locahost"))return new g.Notice(`Potential typo in Base URL: Did you mean "localhost"? Current: ${this.settings.lettaBaseUrl}`),this.updateStatusBar("URL typo detected"),!1}if(n&&!this.settings.lettaApiKey)return new g.Notice("API key required for Letta Cloud. Please configure it in settings."),!1;try{if(this.updateStatusBar(e===1?"Connecting...":`Retrying... (${e}/${5})`),await this.makeRequest("/v1/models/embedding"),await this.setupSource(),this.settings.agentId)try{await this.setupAgent()}catch(s){console.error("[Letta Plugin] Agent setup failed:",s),this.settings.agentId="",this.settings.agentName="",await this.saveSettings()}return this.updateStatusBar("Connected"),e===1?new g.Notice("Successfully connected to Letta"):new g.Notice(`Connected to Letta after ${e} attempts`),this.settings.syncOnStartup&&await this.syncVaultToLetta(),!0}catch(s){if(console.error(`[Letta Plugin] Connection attempt ${e} failed:`,s),console.error("[Letta Plugin] Error details:",{message:s.message,stack:s.stack,name:s.name}),s.message.includes("ERR_NAME_NOT_RESOLVED")?e===1&&new g.Notice(`Cannot resolve hostname. Please check your Base URL: ${this.settings.lettaBaseUrl}`):s.message.includes("ECONNREFUSED")||s.message.includes("ERR_CONNECTION_REFUSED")?e===1&&new g.Notice(`Connection refused. Is your Letta server running on ${this.settings.lettaBaseUrl}?`):s.message.includes("ENOTFOUND")&&e===1&&new g.Notice(`Host not found. Please verify the URL spelling: ${this.settings.lettaBaseUrl}`),e<5){let o=Math.min(1e3*Math.pow(2,e-1),1e4);return this.updateStatusBar(`Retry in ${Math.ceil(o/1e3)}s...`),await new Promise(a=>setTimeout(a,o)),await this.connectToLetta(e+1)}else return this.updateStatusBar("Connection failed"),new g.Notice(`Failed to connect to Letta after ${5} attempts: ${s.message}`),!1}}async setupSource(){try{let t=(await this.makeRequest("/v1/sources")).find(n=>n.name===this.settings.sourceName);if(t)this.source={id:t.id,name:t.name};else{let n=await this.makeRequest("/v1/models/embedding"),s=n.find(l=>l.handle===this.settings.embeddingModel);s||(s=n.find(l=>l.handle==="letta/letta-free"||l.handle&&l.handle.includes("letta"))||n[0],console.warn(`[Letta Plugin] Selected embedding model "${this.settings.embeddingModel}" not found, using fallback: ${s==null?void 0:s.handle}`));let o=this.settings.lettaBaseUrl.includes("api.letta.com"),a={name:this.settings.sourceName,instructions:"A collection of markdown files from an Obsidian vault. Directory structure is preserved in filenames using '__' as path separators."};o||(a.embedding_config=s);let i=await this.makeRequest("/v1/sources",{method:"POST",body:a});this.source={id:i.id,name:i.name}}}catch(e){throw console.error("Failed to setup source:",e),e}}async setupAgent(){var e;if(!this.source)throw new Error("Source not set up");if(!this.settings.agentId){console.log("[Letta Plugin] No agent ID configured, skipping agent setup");return}try{let t=await this.makeRequest(`/v1/agents/${this.settings.agentId}`);if(t){this.agent={id:t.id,name:t.name},this.settings.agentName=t.name,await this.saveSettings();let n=t.sources||[];if(!n.some(o=>o.id===this.source.id)){let o=n.map(a=>a.id);o.push(this.source.id),await this.makeRequest(`/v1/agents/${(e=this.agent)==null?void 0:e.id}`,{method:"PATCH",body:{source_ids:o}})}}else console.log(`[Letta Plugin] Agent with ID ${this.settings.agentId} not found, clearing invalid ID`),this.settings.agentId="",this.settings.agentName="",await this.saveSettings()}catch(t){console.error("Failed to setup agent:",t),this.settings.agentId="",this.settings.agentName="",await this.saveSettings()}}encodeFilePath(e){return e.replace(/[\/\\]/g,"__")}decodeFilePath(e){return e.replace(/__/g,"/")}async addToUploadQueue(e){return new Promise((t,n)=>{this.uploadQueue.push(async()=>{try{await e(),t()}catch(s){n(s)}}),this.isProcessingQueue||this.processUploadQueue()})}async processUploadQueue(){if(!(this.isProcessingQueue||this.uploadQueue.length===0)){for(this.isProcessingQueue=!0;this.uploadQueue.length>0;){let e=Date.now()-6e4;if(this.uploadsInLastMinute=this.uploadsInLastMinute.filter(n=>n>e),this.uploadsInLastMinute.length>=10){let s=Math.min(...this.uploadsInLastMinute)+6e4-Date.now();await new Promise(o=>setTimeout(o,s));continue}let t=this.uploadQueue.shift();if(t)try{await t(),this.uploadsInLastMinute.push(Date.now())}catch(n){if(n.message&&n.message.includes("HTTP 429")){this.uploadQueue.unshift(t),await new Promise(s=>setTimeout(s,1e3));continue}else console.error("[Letta Plugin] Upload failed with non-rate-limit error:",n)}}this.isProcessingQueue=!1}}async syncVaultToLetta(){if(!((!this.source||!this.source.id)&&(new g.Notice("Connecting to Letta..."),!await this.connectToLetta())))try{if(!this.source||!this.source.id)throw new Error("Source not properly initialized for vault sync");this.updateStatusBar("Syncing...");let e=await this.makeRequest(`/v1/sources/${this.source.id}/files`),t=new Map;e.forEach(i=>{t.set(i.file_name,i)});let n=this.app.vault.getMarkdownFiles(),s=0,o=0,a=[];for(let i of n){let l=this.encodeFilePath(i.path),r=t.get(l),c=!0;if(r){let d=i.stat.size;if(r.file_size===d){let u=i.stat.mtime,h=r.updated_at?new Date(r.updated_at).getTime():0;u<=h&&(c=!1,o++)}}c&&a.push(i)}if(a.length>0){new g.Notice(`Uploading ${a.length} files with rate limiting...`);let i=0,l=a.map(async(r,c)=>{let d=this.encodeFilePath(r.path),u=t.get(d);return this.addToUploadQueue(async()=>{if(!this.source||!this.source.id)throw new Error("Source not properly initialized for upload");u&&await this.makeRequest(`/v1/sources/${this.source.id}/${u.id}`,{method:"DELETE"});let h=await this.app.vault.read(r);if(!h||h.trim().length===0){o++,i++,this.updateStatusBar(`Syncing (${i}/${a.length})`);return}let p="----formdata-obsidian-"+Math.random().toString(36).substr(2),y=[`--${p}`,`Content-Disposition: form-data; name="file"; filename="${d}"`,"Content-Type: text/markdown","",h,`--${p}--`].join(`\r
`);await this.makeRequest(`/v1/sources/${this.source.id}/upload`,{method:"POST",headers:{"Content-Type":`multipart/form-data; boundary=${p}`},body:y,isFileUpload:!0}),s++,i++,this.updateStatusBar(`Syncing (${i}/${a.length})`)})});await Promise.all(l)}this.updateStatusBar("Connected"),new g.Notice(`Sync complete: ${s} files uploaded, ${o} files skipped`)}catch(e){console.error("Failed to sync vault:",e),this.updateStatusBar("Error"),new g.Notice(`Sync failed: ${e.message}`)}}async syncCurrentFile(e){if(!e){new g.Notice("No active file to sync");return}if(!e.path.endsWith(".md")){new g.Notice("Only markdown files can be synced to Letta");return}if(!((!this.source||!this.source.id)&&(new g.Notice("Connecting to Letta..."),!await this.connectToLetta())))try{this.updateStatusBar(`Syncing ${e.name}...`);let t=this.encodeFilePath(e.path);await this.addToUploadQueue(async()=>{if(!this.source||!this.source.id)throw new Error("Source not properly initialized for upload");let n=await this.app.vault.read(e),o=(await this.makeRequest(`/v1/sources/${this.source.id}/files`)).find(r=>r.file_name===t),a="uploaded";o&&(await this.makeRequest(`/v1/sources/${this.source.id}/${o.id}`,{method:"DELETE"}),a="updated");let i="----formdata-obsidian-"+Math.random().toString(36).substr(2),l=[`--${i}`,`Content-Disposition: form-data; name="file"; filename="${t}"`,"Content-Type: text/markdown","",n,`--${i}--`].join(`\r
`);await this.makeRequest(`/v1/sources/${this.source.id}/upload`,{method:"POST",headers:{"Content-Type":`multipart/form-data; boundary=${i}`},body:l,isFileUpload:!0}),this.updateStatusBar(`Synced ${e.name}`),setTimeout(()=>this.updateStatusBar("Connected"),5e3)})}catch(t){console.error("Failed to sync current file:",t),this.updateStatusBar("Error"),new g.Notice(`Failed to sync file: ${t.message}`)}}async onFileChange(e){if(!e.path.includes("Letta Memory Blocks/")&&e.path.endsWith(".md")){if(!this.source||!this.source.id)try{await this.connectToLetta()}catch(t){return}try{let t=this.encodeFilePath(e.path);await this.addToUploadQueue(async()=>{if(!this.source||!this.source.id)throw new Error("Source not properly initialized for upload");let n=await this.app.vault.read(e);if(!n||n.trim().length===0)return;try{let i=(await this.makeRequest(`/v1/sources/${this.source.id}/files`)).find(l=>l.file_name===t);i&&await this.makeRequest(`/v1/sources/${this.source.id}/${i.id}`,{method:"DELETE"})}catch(a){}let s="----formdata-obsidian-"+Math.random().toString(36).substr(2),o=[`--${s}`,`Content-Disposition: form-data; name="file"; filename="${t}"`,"Content-Type: text/markdown","",n,`--${s}--`].join(`\r
`);await this.makeRequest(`/v1/sources/${this.source.id}/upload`,{method:"POST",headers:{"Content-Type":`multipart/form-data; boundary=${s}`},body:o,isFileUpload:!0})})}catch(t){console.error("Failed to sync file change:",t)}}}async onFileDelete(e){if(e.path.endsWith(".md")){if(!this.source||!this.source.id)try{await this.connectToLetta()}catch(t){return}try{if(!this.source||!this.source.id)throw new Error("Source not properly initialized for file deletion");let t=this.encodeFilePath(e.path),s=(await this.makeRequest(`/v1/sources/${this.source.id}/files`)).find(o=>o.file_name===t);s&&await this.makeRequest(`/v1/sources/${this.source.id}/${s.id}`,{method:"DELETE"})}catch(t){console.error("Failed to delete file from Letta:",t)}}}async openFileInAgent(e){if(console.log("[LETTA DEBUG] openFileInAgent called with file:",e.path),!this.agent||!this.source){console.log("[LETTA DEBUG] openFileInAgent - early return: agent =",!!this.agent,"source =",!!this.source);return}try{let t=this.encodeFilePath(e.path);console.log("[LETTA DEBUG] openFileInAgent - encoded path:",t);let s=(await this.makeRequest(`/v1/sources/${this.source.id}/files`)).find(o=>o.file_name===t);if(s)console.log("[LETTA DEBUG] openFileInAgent - opening file with ID:",s.id),await this.makeRequest(`/v1/agents/${this.agent.id}/files/${s.id}/open`,{method:"PATCH"}),console.log("[LETTA DEBUG] openFileInAgent - successfully opened file:",e.path);else{console.log("[LETTA DEBUG] openFileInAgent - file not found in source, syncing:",t),this.updateStatusBar(`Syncing ${e.name} for focus...`);try{await this.syncCurrentFile(e),console.log("[LETTA DEBUG] openFileInAgent - file synced successfully");let o=null,a=0,i=5,l=1e3;for(;!o&&a<i;){if(a>0){let c=l*Math.pow(1.5,a-1);console.log(`[LETTA DEBUG] openFileInAgent - retrying file lookup in ${c}ms, attempt:`,a+1),await new Promise(d=>setTimeout(d,c))}o=(await this.makeRequest(`/v1/sources/${this.source.id}/files`)).find(c=>c.file_name===t),a++}o?(await this.makeRequest(`/v1/agents/${this.agent.id}/files/${o.id}/open`,{method:"PATCH"}),console.log("[LETTA DEBUG] openFileInAgent - successfully opened synced file:",e.path),this.updateStatusBar("Connected")):(console.error("[LETTA DEBUG] openFileInAgent - file still not found after sync and retries"),this.updateStatusBar("Sync failed"),setTimeout(()=>this.updateStatusBar("Connected"),3e3))}catch(o){console.error("Failed to sync file:",o),this.updateStatusBar("Sync failed"),setTimeout(()=>this.updateStatusBar("Connected"),3e3)}}}catch(t){console.error("Failed to open file in agent:",t),this.updateStatusBar("Error"),setTimeout(()=>this.updateStatusBar("Connected"),3e3)}}async closeFileInAgent(e){if(!(!this.agent||!this.source))try{let t=this.encodeFilePath(e.path),s=(await this.makeRequest(`/v1/sources/${this.source.id}/files`)).find(o=>o.file_name===t);s&&await this.makeRequest(`/v1/agents/${this.agent.id}/files/${s.id}/close`,{method:"PATCH"})}catch(t){console.error("Failed to close file in agent:",t)}}async closeAllFilesInAgent(){if(console.log("[LETTA DEBUG] closeAllFilesInAgent called"),!this.agent){console.log("[LETTA DEBUG] closeAllFilesInAgent - early return: no agent");return}try{console.log("[LETTA DEBUG] closeAllFilesInAgent - making API request to close all files"),await this.makeRequest(`/v1/agents/${this.agent.id}/files/close-all`,{method:"PATCH"}),console.log("[LETTA DEBUG] closeAllFilesInAgent - successfully closed all files")}catch(e){console.error("Failed to close all files in agent:",e)}}async onActiveFileChange(){if(console.log("[LETTA DEBUG] onActiveFileChange called"),console.log("[LETTA DEBUG] onActiveFileChange - focusMode:",this.settings.focusMode,"agent:",!!this.agent),!this.settings.focusMode||!this.agent){console.log("[LETTA DEBUG] onActiveFileChange - early return");return}let e=this.app.workspace.getActiveFile();if(console.log("[LETTA DEBUG] onActiveFileChange - activeFile:",(e==null?void 0:e.path)||"null"),!e||!e.path.endsWith(".md")){console.log("[LETTA DEBUG] onActiveFileChange - early return: no file or not markdown");return}try{console.log("[LETTA DEBUG] onActiveFileChange - applying focus mode for file:",e.path),await this.closeAllFilesInAgent(),await this.openFileInAgent(e),console.log("[LETTA DEBUG] onActiveFileChange - focus mode applied successfully")}catch(t){console.error("Failed to apply focus mode on active file change:",t)}}async applyFocusMode(){if(this.agent)try{await this.closeAllFilesInAgent();let e=this.app.workspace.getActiveFile();e&&e.path.endsWith(".md")&&await this.openFileInAgent(e)}catch(e){console.error("Failed to apply focus mode:",e)}}async openChatView(){if(console.log("[LETTA DEBUG] openChatView called"),!this.source&&(console.log("[LETTA DEBUG] openChatView - connecting to Letta"),new g.Notice("Connecting to Letta..."),!await this.connectToLetta())){console.log("[LETTA DEBUG] openChatView - failed to connect");return}let{workspace:e}=this.app,t=e.getActiveFile();console.log("[LETTA DEBUG] openChatView - activeFileBeforeChat:",(t==null?void 0:t.path)||"null");let n=null,s=e.getLeavesOfType($);if(s.length>0?(console.log("[LETTA DEBUG] openChatView - using existing leaf"),n=s[0]):(console.log("[LETTA DEBUG] openChatView - creating new leaf"),n=e.getRightLeaf(!1),n&&await n.setViewState({type:$,active:!0})),n&&(console.log("[LETTA DEBUG] openChatView - revealing leaf"),e.revealLeaf(n)),this.settings.focusMode&&t&&t.path.endsWith(".md")){console.log("[LETTA DEBUG] openChatView - applying focus mode for file:",t.path);try{await this.closeAllFilesInAgent(),await this.openFileInAgent(t),console.log("[LETTA DEBUG] openChatView - focus mode applied successfully")}catch(o){console.error("Failed to apply focus mode after opening chat:",o)}}else console.log("[LETTA DEBUG] openChatView - not applying focus mode: focusMode =",this.settings.focusMode,"activeFile =",!!t)}async openMemoryView(){if(!this.source&&(new g.Notice("Connecting to Letta..."),!await this.connectToLetta()))return;let{workspace:e}=this.app,t=null,n=e.getLeavesOfType(F);n.length>0?t=n[0]:(t=e.getRightLeaf(!1),t&&await t.setViewState({type:F,active:!0})),t&&e.revealLeaf(t)}async sendMessageToAgent(e){var n;if(!this.agent)throw new Error("Agent not connected");return(await this.makeRequest(`/v1/agents/${(n=this.agent)==null?void 0:n.id}/messages`,{method:"POST",body:{messages:[{role:"user",content:[{type:"text",text:e}]}]}})).messages||[]}async sendMessageToAgentStream(e,t,n,s){var l;if(!this.agent)throw new Error("Agent not connected");let o=`${this.settings.lettaBaseUrl}/v1/agents/${(l=this.agent)==null?void 0:l.id}/messages/stream`,a={"Content-Type":"application/json"};this.settings.lettaApiKey&&(a.Authorization=`Bearer ${this.settings.lettaApiKey}`);let i={messages:[{role:"user",content:[{type:"text",text:e}]}],stream_steps:this.settings.enableStreaming,stream_tokens:this.settings.enableStreaming};try{let r=await fetch(o,{method:"POST",headers:a,body:JSON.stringify(i)});if(!r.ok){if(r.status===429){let u="HTTP 429: Rate limit exceeded";try{let h=await r.text();if(h)try{let m=JSON.parse(h);m.detail?u=`HTTP 429: ${m.detail}`:m.message&&(u=`HTTP 429: ${m.message}`)}catch(m){u=`HTTP 429: ${h}`}let p=r.headers.get("Retry-After"),y=r.headers.get("X-RateLimit-Reset"),f=r.headers.get("X-RateLimit-Remaining");if(p&&(u+=` | Retry after: ${p} seconds`),y){let m=new Date(parseInt(y)*1e3);u+=` | Rate limit resets at: ${m.toLocaleTimeString()}`}f&&(u+=` | Remaining requests: ${f}`)}catch(h){console.error("[Letta Plugin] Error reading rate limit response body:",h)}throw new Error(u)}throw new Error(`HTTP ${r.status}: ${r.statusText}`)}if(!r.body)throw new Error("No response body available for streaming");let c=r.body.getReader(),d=new TextDecoder;try{for(;;){let{done:u,value:h}=await c.read();if(u)break;let y=d.decode(h,{stream:!0}).split(`
`);for(let f of y)if(f.trim()!==""&&f.startsWith("data: ")){let m=f.slice(6);if(m==="[DONE]"){s();return}try{let v=JSON.parse(m);t(v)}catch(v){console.warn("[Letta Plugin] Failed to parse streaming message:",m)}}}}finally{c.releaseLock()}}catch(r){n(r)}}},R=class extends g.ItemView{constructor(e,t){super(e);this.heartbeatTimeout=null;this.currentReasoningContent="";this.currentAssistantContent="";this.currentAssistantMessageEl=null;this.currentReasoningMessageEl=null;this.currentToolMessageEl=null;this.currentToolCallId=null;this.currentToolCallArgs="";this.currentToolCallName="";this.plugin=t}getViewType(){return $}getDisplayText(){return"Letta Chat"}getIcon(){return"bot"}async onOpen(){let e=this.containerEl.children[1];e.empty(),e.addClass("letta-chat-view");let t=e.createEl("div",{cls:"letta-chat-header"}),s=t.createEl("div",{cls:"letta-chat-title-section"}).createEl("div",{cls:"letta-title-container"});this.agentNameElement=s.createEl("h3",{text:this.plugin.agent?this.plugin.settings.agentName:"No Agent",cls:this.plugin.agent?"letta-chat-title":"letta-chat-title no-agent"}),this.agentNameElement.style.cursor="pointer",this.agentNameElement.title="Click to edit agent name",this.agentNameElement.addEventListener("click",()=>this.editAgentName());let o=s.createEl("span",{text:"Config"});o.title="Configure agent properties",o.style.cssText="cursor: pointer; opacity: 0.7; padding: 2px 6px; margin: 0 4px; font-size: 0.8em;",o.addEventListener("mouseenter",()=>{o.style.opacity="1"}),o.addEventListener("mouseleave",()=>{o.style.opacity="0.7"}),o.addEventListener("click",()=>this.openAgentConfig());let a=s.createEl("span",{text:"Memory"});a.title="Open memory blocks panel",a.style.cssText="cursor: pointer; opacity: 0.7; padding: 2px 6px; margin: 0 4px; font-size: 0.8em;",a.addEventListener("mouseenter",()=>{a.style.opacity="1"}),a.addEventListener("mouseleave",()=>{a.style.opacity="0.7"}),a.addEventListener("click",()=>this.plugin.openMemoryView());let i=s.createEl("span",{text:"Agent"});i.title="Switch to different agent",i.style.cssText="cursor: pointer; opacity: 0.7; padding: 2px 6px; margin: 0 4px; font-size: 0.8em;",i.addEventListener("mouseenter",()=>{i.style.opacity="1"}),i.addEventListener("mouseleave",()=>{i.style.opacity="0.7"}),i.addEventListener("click",()=>this.openAgentSwitcher());let l=s.createEl("span",{text:"ADE"});l.title="Open in Letta Agent Development Environment",l.style.cssText="cursor: pointer; opacity: 0.7; padding: 2px 6px; margin: 0 4px; font-size: 0.8em;",l.addEventListener("mouseenter",()=>{l.style.opacity="1"}),l.addEventListener("mouseleave",()=>{l.style.opacity="0.7"}),l.addEventListener("click",()=>this.openInADE());let r=t.createEl("div",{cls:"letta-status-indicator"});this.statusDot=r.createEl("span",{cls:"letta-status-dot"}),this.statusText=r.createEl("span",{cls:"letta-status-text"}),this.updateChatStatus(),this.chatContainer=e.createEl("div",{cls:"letta-chat-container"}),this.typingIndicator=this.chatContainer.createEl("div",{cls:"letta-typing-indicator"}),this.typingIndicator.style.display="none";let c=this.typingIndicator.createEl("span",{cls:"letta-typing-text",text:`${this.plugin.settings.agentName} is thinking`}),d=this.typingIndicator.createEl("span",{cls:"letta-typing-dots"});d.createEl("span",{text:"."}),d.createEl("span",{text:"."}),d.createEl("span",{text:"."}),this.updateChatStatus(),this.inputContainer=e.createEl("div",{cls:"letta-input-container"}),this.messageInput=this.inputContainer.createEl("textarea",{cls:"letta-message-input",attr:{placeholder:"Ask about your vault...",rows:"2"}});let u=this.inputContainer.createEl("div",{cls:"letta-button-container"});this.modelButton=u.createEl("button",{text:"Loading...",cls:"letta-model-button",attr:{"aria-label":"Switch model"}}),this.modelButton.addEventListener("click",()=>this.openModelSwitcher());let h=u.createEl("div",{cls:"letta-button-group-right"});this.sendButton=h.createEl("button",{cls:"letta-send-button",attr:{"aria-label":"Send message"}}),this.sendButton.createEl("span",{text:"Send"}),this.sendButton.addEventListener("click",()=>this.sendMessage()),this.updateChatStatus(),this.messageInput.addEventListener("keydown",p=>{p.key==="Enter"&&!p.shiftKey&&(p.preventDefault(),this.sendMessage())}),this.messageInput.addEventListener("input",()=>{this.messageInput.style.height="auto",this.messageInput.style.height=Math.min(this.messageInput.scrollHeight,80)+"px"})}async onClose(){this.heartbeatTimeout&&(clearTimeout(this.heartbeatTimeout),this.heartbeatTimeout=null)}addMessage(e,t,n,s){let o="";if(typeof t=="string"?o=t:Array.isArray(t)?o=t.map(r=>typeof r=="string"?r:r&&typeof r=="object"?r.text||r.content||r.message||r.value||JSON.stringify(r):String(r)).join(""):t&&typeof t=="object"?(o=t.text||t.content||t.message||t.value||"",!o&&t&&(console.warn("[Letta Plugin] Content object has no recognizable text field, using JSON fallback:",Object.keys(t)),o=JSON.stringify(t,null,2))):o=String(t||""),!o){console.warn("[Letta Plugin] No content to display");return}if(this.hideTypingIndicator(),e==="assistant"&&this.cleanupPreviousToolCalls(),o&&o.includes('"type": "system_alert"'))try{let r=JSON.parse(o);if(r.type==="system_alert")return this.addSystemMessage(r),null}catch(r){console.debug("[Letta Plugin] Failed to parse potential system_alert content:",r)}if(o&&(o.includes('"type": "heartbeat"')||o.includes("automated system message")||o.includes("Function call failed, returning control")||o.includes("request_heartbeat=true")))return null;let a=this.chatContainer.createEl("div",{cls:`letta-message letta-message-${e}`}),i=a.createEl("div",{cls:"letta-message-bubble"}),l=new Date().toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"});if(!(e==="tool-call"||e==="tool-result")){{if(e==="reasoning")return;{if(n&&e!=="user"){let c=i.createEl("div",{cls:"letta-message-header"}),d=c.createEl("div",{cls:"letta-message-header-left"}),u=n.replace(/ðŸ¤–|ðŸ‘¤|ðŸš¨|âœ…|âŒ|ðŸ”Œ/g,"").trim();if(d.createEl("span",{cls:"letta-message-title",text:u}),d.createEl("span",{cls:"letta-message-timestamp",text:l}),e==="assistant"&&s){let h=c.createEl("button",{cls:"letta-reasoning-btn letta-reasoning-collapsed",text:"\u22EF"});h.addEventListener("click",p=>{p.stopPropagation(),h.classList.contains("letta-reasoning-collapsed")?(h.removeClass("letta-reasoning-collapsed"),h.addClass("letta-reasoning-expanded")):(h.addClass("letta-reasoning-collapsed"),h.removeClass("letta-reasoning-expanded"));let f=i.querySelector(".letta-reasoning-content");f&&f.classList.toggle("letta-reasoning-visible")})}}if(e==="assistant"&&s){let c=i.createEl("div",{cls:"letta-reasoning-content"}),d=s.trim().replace(/\n{3,}/g,`

`).replace(/^### (.+)$/gm,"<h3>$1</h3>").replace(/^## (.+)$/gm,"<h2>$1</h2>").replace(/^# (.+)$/gm,"<h1>$1</h1>").replace(/\*\*(.*?)\*\*/g,"<strong>$1</strong>").replace(/\*(.*?)\*/g,"<em>$1</em>").replace(/`([^`]+)`/g,"<code>$1</code>").replace(/^(\d+)\.\s+(.+)$/gm,'<li class="numbered-list">$2</li>').replace(/^[â€¢*-]\s+(.+)$/gm,"<li>$1</li>").replace(/\n\n/g,"</p><p>").replace(/\n/g,"<br>");d=d.replace(/(<li class="numbered-list">.*?<\/li>)(\s*<br>\s*<li class="numbered-list">.*?<\/li>)*/g,u=>"<ol>"+u.replace(/<br>\s*/g,"")+"</ol>"),d=d.replace(/(<li>(?!.*class="numbered-list").*?<\/li>)(\s*<br>\s*<li>(?!.*class="numbered-list").*?<\/li>)*/g,u=>"<ul>"+u.replace(/<br>\s*/g,"")+"</ul>"),d.includes("</p><p>")&&!d.startsWith("<")&&(d="<p>"+d+"</p>"),c.innerHTML=d}let r=o.trim().replace(/\n{3,}/g,`

`).replace(/^### (.+)$/gm,"<h3>$1</h3>").replace(/^## (.+)$/gm,"<h2>$1</h2>").replace(/^# (.+)$/gm,"<h1>$1</h1>").replace(/\*\*(.*?)\*\*/g,"<strong>$1</strong>").replace(/\*(.*?)\*/g,"<em>$1</em>").replace(/`([^`]+)`/g,"<code>$1</code>").replace(/^(\d+)\.\s+(.+)$/gm,'<li class="numbered-list">$2</li>').replace(/^[â€¢*-]\s+(.+)$/gm,"<li>$1</li>").replace(/\n\n/g,"</p><p>").replace(/\n/g,"<br>");if(r=r.replace(/(<li class="numbered-list">.*?<\/li>)(\s*<br>\s*<li class="numbered-list">.*?<\/li>)*/g,c=>"<ol>"+c.replace(/<br>\s*/g,"")+"</ol>"),r=r.replace(/(<li>(?!.*class="numbered-list").*?<\/li>)(\s*<br>\s*<li>(?!.*class="numbered-list").*?<\/li>)*/g,c=>"<ul>"+c.replace(/<br>\s*/g,"")+"</ul>"),r.includes("</p><p>")&&!r.startsWith("<")&&(r="<p>"+r+"</p>"),e==="user"&&o.length>200){let c=i.createEl("div",{cls:"letta-user-message-container"}),d=o.substring(0,200).trim()+"...",u=c.createEl("div",{cls:"letta-message-content letta-user-message-preview"});u.textContent=d;let h=c.createEl("div",{cls:"letta-message-content letta-user-message-full letta-user-message-collapsed"});h.innerHTML=r;let p=c.createEl("button",{cls:"letta-user-message-toggle",text:"See more"});p.addEventListener("click",y=>{y.stopPropagation(),h.classList.contains("letta-user-message-collapsed")?(u.style.display="none",h.removeClass("letta-user-message-collapsed"),p.textContent="See less"):(u.style.display="block",h.addClass("letta-user-message-collapsed"),p.textContent="See more")})}else{let c=i.createEl("div",{cls:"letta-message-content"});c.innerHTML=r}}}a.style.opacity="0",a.style.transform="translateY(10px)",setTimeout(()=>{a.style.transition="opacity 0.3s ease, transform 0.3s ease",a.style.opacity="1",a.style.transform="translateY(0)"},50),setTimeout(()=>{this.chatContainer.scrollTo({top:this.chatContainer.scrollHeight,behavior:"smooth"})},100)}}async clearChat(){this.chatContainer.empty(),await this.updateChatStatus()}async loadHistoricalMessages(){var t;if(!(!this.plugin.agent||!this.chatContainer||this.chatContainer.querySelectorAll(".letta-message").length>0))try{let n=await this.plugin.makeRequest(`/v1/agents/${(t=this.plugin.agent)==null?void 0:t.id}/messages?limit=50`);if(!n||n.length===0)return;let s=n.filter(a=>a?a.message_type||a.type?!0:(console.warn("[Letta Plugin] Message missing type field:",a),!1):!1);if(s.length===0)return;let o=s.sort((a,i)=>new Date(a.date).getTime()-new Date(i.date).getTime());this.processMessagesInGroups(o)}catch(n){console.error("[Letta Plugin] Failed to load historical messages:",n),n.message&&n.message.includes("missing message argument")&&this.addMessage("assistant","Some messages in your conversation history could not be loaded due to data issues. New messages will work normally.","System")}}filterSystemPromptContent(e){if(!e)return e;let t=[/<control_flow>/i,/<basic_functions>/i,/<context_instructions>/i,/<memory_editing>/i,/<memory_tools>/i,/program again after the function completes/i,/inner monologue.*private to you only/i,/Older AI models had no concept of persistent memory/i,/conversation with a user.*their.*acti/i,/active memory/i,/persistent memory/i,/context window/i,/overflow.*old messages.*permanently lost/i,/sentient being/i,/real-time.*conscious awareness/i,/\*\*Currently Open Files.*Based on my current system access/i,/\*\*Available Directories:\*\*/i,/obsidian-vault-files.*directory structure preserved/i,/using '__' as path separa/i,/\*\*File System Notes:\*\*/i,/I can open up to \d+ files/i,/(.*)\1{2,}/s];if(e.includes("**Currently Open Files")&&e.includes("Based on my current system access")){let s=e.match(/\*\*Currently Open Files.*?(?=\*\*Currently Open Files|\*\*Available Directories|$)/gs);if(s&&s.length>1)return"I can see your vault files and am ready to help with your question."}if(t.some(s=>s.test(e))){let a=e.split(`
`).filter(i=>{let l=i.trim();return l?!t.some(c=>{let d=c.test(l);return d})&&!l.includes("<")&&!l.includes(">"):!1}).join(`
`).trim();return!a||a.length<10?e:a}return e}formatToolResult(e){if(!e)return e;try{let t=JSON.parse(e);return JSON.stringify(t,null,2)}catch(t){let n=e;if(n.startsWith('"')&&n.endsWith('"'))try{n=JSON.parse(n)}catch(s){n=n.slice(1,-1),n=n.replace(/\\n/g,`
`),n=n.replace(/\\"/g,'"'),n=n.replace(/\\\\/g,"\\")}else n=n.replace(/\\n/g,`
`),n=n.replace(/\\"/g,'"'),n=n.replace(/\\\\/g,"\\");return n=n.replace(/={10,}/g,`---
`),n=n.replace(/^===+\s*/,"").replace(/\s*===+$/,""),n=n.replace(/\n{3,}/g,`

`),n.trim()}}addRateLimitMessage(e){let t=this.chatContainer.createEl("div",{cls:"letta-rate-limit-message"}),n=new Date().toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}),s=t.createEl("div",{cls:"letta-rate-limit-timestamp",text:n}),o=t.createEl("div",{cls:"letta-rate-limit-content"}),a=e.split(`
`),i="",l="",r="";for(let c of a)c.includes("https://app.letta.com/settings/organization/billing")?l=c.trim():c.includes("https://docs.letta.com/guides/cloud/custom-keys")?r=c.trim():c.trim()&&!c.includes("Need more?")&&!c.includes("Or bring your own")&&(i&&(i+=" "),i+=c.replace(/[âš ï¸*]/g,"").trim());if(i){let c=o.createEl("div",{cls:"letta-rate-limit-main",text:i})}if(l&&o.createEl("div",{cls:"letta-rate-limit-link"}).createEl("a",{href:l,text:"Upgrade to Pro, Scale, or Enterprise",cls:"letta-rate-limit-upgrade-link"}).setAttribute("target","_blank"),l&&r){let c=o.createEl("div",{cls:"letta-rate-limit-separator",text:"or"});c.style.cssText="text-align: center; margin: 8px 0; color: var(--text-muted); font-size: 0.9em;"}r&&o.createEl("div",{cls:"letta-rate-limit-link"}).createEl("a",{href:r,text:"Learn about bringing your own inference provider",cls:"letta-rate-limit-upgrade-link"}).setAttribute("target","_blank"),this.chatContainer.scrollTop=this.chatContainer.scrollHeight}processMessagesInGroups(e){let t="",n=null,s="",o=null;for(let a of e)try{if(a.message_type==="system_message"||a.type==="system_message")continue;if(a.type==="system_alert"||a.message&&typeof a.message=="string"&&a.message.includes("prior messages have been hidden")){this.addSystemMessage(a);continue}if(a.type==="heartbeat"||a.message_type==="heartbeat"||a.type==="login"||a.message_type==="login")continue;if(a.message_type==="user_message"&&a.content&&typeof a.content=="string")try{if(JSON.parse(a.content.trim()).type==="login")continue}catch(l){}let i=a.message_type||a.type;if(!this.validateMessageStructure(a,i)){console.warn("[Letta Plugin] Skipping malformed message:",a),this.addErrorMessage(`Malformed ${i||"unknown"} message`,a);continue}switch(i){case"user_message":(a.content||a.text)&&this.addMessage("user",a.text||a.content||"");break;case"reasoning_message":a.reasoning&&(t+=a.reasoning);break;case"tool_call_message":a.tool_call&&(s=a.tool_call.name||a.tool_call.function&&a.tool_call.function.name||"",o=a.tool_call,n=this.addToolInteractionMessage(t,JSON.stringify(a.tool_call,null,2)),t="");break;case"tool_return_message":a.tool_return&&n&&(this.addToolResultToMessage(n,JSON.stringify(a.tool_return,null,2),s,o),n=null,s="",o=null);break;case"assistant_message":if(a.content||a.text){let l=a.content||a.text||"",r=this.filterSystemPromptContent(l);this.addMessage("assistant",r,this.plugin.settings.agentName,t||void 0),t=""}break;default:}}catch(i){console.error("[Letta Plugin] Error processing message:",i,a),this.addErrorMessage(`Error processing ${(a==null?void 0:a.message_type)||(a==null?void 0:a.type)||"unknown"} message`,{error:i.message,message:a})}}validateMessageStructure(e,t){if(!e)return!1;switch(t){case"user_message":return!!(e.content||e.text);case"assistant_message":return!!(e.content||e.text);case"reasoning_message":return!!e.reasoning;case"tool_call_message":return!!e.tool_call;case"tool_return_message":return!!e.tool_return;default:return!0}}addErrorMessage(e,t){let n=`${e} - This message had invalid data and was skipped.`;this.addMessage("assistant",n,"System")}displayHistoricalMessage(e){let t=e.type||e.message_type,n=e.role,s=e.reason||"",o=s.includes("automated system message")||s.includes("Function call failed, returning control")||s.includes("request_heartbeat=true");if(t==="system_alert"||e.message&&typeof e.message=="string"&&e.message.includes("prior messages have been hidden")){this.addSystemMessage(e);return}if(!(t==="heartbeat"||e.message_type==="heartbeat"||n==="heartbeat"||o||e.content&&typeof e.content=="string"&&(e.content.includes("automated system message")||e.content.includes("Function call failed, returning control")||e.content.includes("request_heartbeat=true"))||e.text&&typeof e.text=="string"&&(e.text.includes("automated system message")||e.text.includes("Function call failed, returning control")||e.text.includes("request_heartbeat=true")))&&!(t==="login"||e.message_type==="login"||n==="login")){if(e.message_type==="user_message"&&e.content&&typeof e.content=="string")try{if(JSON.parse(e.content.trim()).type==="login")return}catch(a){}switch(e.message_type){case"user_message":(e.text||e.content)&&this.addMessage("user",e.text||e.content||"");break;case"reasoning_message":break;case"tool_call_message":break;case"tool_return_message":break;case"assistant_message":if(e.content||e.text){let a=e.content||e.text||"",i=this.filterSystemPromptContent(a);this.addMessage("assistant",i,this.plugin.settings.agentName)}break;case"system_message":break;case"heartbeat":this.handleHeartbeat();break;default:break}}}addMessageSeparator(e){this.chatContainer.createEl("div",{cls:"letta-message-separator"}).createEl("span",{text:e,cls:"letta-separator-text"})}addSystemMessage(e){let n=this.chatContainer.createEl("div",{cls:"letta-message-separator letta-system-message-separator"}).createEl("span",{text:"memory update",cls:"letta-separator-text letta-system-separator-text"});n.style.cursor="pointer",n.style.userSelect="none";let s=this.chatContainer.createEl("div",{cls:"letta-system-expanded-content"});if(s.style.cssText="display: none; background: var(--background-secondary); border: 1px solid var(--background-modifier-border); border-radius: 4px; padding: 12px; margin: 8px 0; font-size: 12px; line-height: 1.4;",e.type==="system_alert"&&e.message){let i=s.createEl("div",{text:e.message,cls:"letta-system-content"});i.style.cssText="color: var(--text-normal); white-space: pre-wrap; margin-bottom: 8px;"}let o=s.createEl("div",{text:'Click "System Message" above to collapse',cls:"letta-system-collapse-hint"});o.style.cssText="font-size: 10px; color: var(--text-muted); margin-top: 8px; font-style: italic;";let a=!1;n.addEventListener("click",()=>{a=!a,s.style.display=a?"block":"none",a&&s.scrollIntoView({behavior:"smooth",block:"nearest"})}),this.chatContainer.scrollTop=this.chatContainer.scrollHeight}showTypingIndicator(){this.typingIndicator&&(this.typingIndicator.style.display="block",this.chatContainer.scrollTop=this.chatContainer.scrollHeight)}hideTypingIndicator(){this.typingIndicator&&(this.typingIndicator.style.display="none")}handleHeartbeat(){this.showTypingIndicator(),this.heartbeatTimeout&&clearTimeout(this.heartbeatTimeout),this.heartbeatTimeout=setTimeout(()=>{this.hideTypingIndicator(),this.heartbeatTimeout=null},3e3)}async updateChatStatus(e=!0){let t=this.plugin.source;this.plugin.agent&&this.plugin.source?(this.statusDot.className="letta-status-dot letta-status-connected",this.statusText.textContent=this.plugin.getConnectionStatusText(),this.updateAgentNameDisplay(),this.modelButton&&this.updateModelButton(),this.removeDisconnectedMessage(),this.removeNoAgentMessage(),e&&this.loadHistoricalMessages()):t?(this.statusDot.className="letta-status-dot letta-status-connected",this.statusText.textContent=this.plugin.getConnectionStatusText(),this.updateAgentNameDisplay(),this.modelButton&&(this.modelButton.textContent="No Agent"),this.removeDisconnectedMessage(),await this.showNoAgentMessage()):(this.statusDot.className="letta-status-dot",this.statusDot.style.backgroundColor="var(--text-muted)",this.statusText.textContent="Disconnected",this.updateAgentNameDisplay(),this.modelButton&&(this.modelButton.textContent="N/A"),this.removeNoAgentMessage(),this.showDisconnectedMessage())}updateAgentNameDisplay(){this.plugin.agent?(this.agentNameElement.textContent=this.plugin.settings.agentName,this.agentNameElement.className="letta-chat-title"):(this.agentNameElement.textContent="No Agent",this.agentNameElement.className="letta-chat-title no-agent")}showDisconnectedMessage(){if(!this.chatContainer)return;this.removeDisconnectedMessage();let t=this.chatContainer.createEl("div",{cls:"letta-disconnected-container"}).createEl("div",{cls:"letta-disconnected-message"});t.createEl("h2",{text:"You are not connected to Letta",cls:"letta-disconnected-title"}),t.createEl("p",{text:"A server connection is required to use your stateful agent",cls:"letta-disconnected-subtitle"});let n=t.createEl("button",{text:"Connect to Letta",cls:"letta-connect-button"});n.addEventListener("click",async()=>{n.disabled=!0,n.textContent="Connecting...";try{await this.plugin.connectToLetta()||(n.disabled=!1,n.textContent="Connect to Letta")}catch(s){n.disabled=!1,n.textContent="Connect to Letta"}})}removeDisconnectedMessage(){if(!this.chatContainer)return;let e=this.chatContainer.querySelector(".letta-disconnected-container");e&&e.remove()}async showNoAgentMessage(){if(!this.chatContainer)return;this.removeNoAgentMessage();let t=this.chatContainer.createEl("div",{cls:"letta-no-agent-container"}).createEl("div",{cls:"letta-no-agent-content"});t.createEl("h3",{text:"No Agent Selected",cls:"letta-no-agent-title"}),t.createEl("p",{text:"You are connected to Letta, but no agent is selected. Choose an agent to start chatting.",cls:"letta-no-agent-description"});let n=t.createEl("div",{cls:"letta-no-agent-buttons"}),s=await this.plugin.getAgentCount(),o=n.createEl("button",{text:s>0?"Select Agent":"No Agents Available",cls:"mod-cta letta-select-agent-button"});s>0?o.addEventListener("click",async()=>{await new U(this.app,this.plugin).showAgentSelector()}):(o.disabled=!0,o.style.opacity="0.5",o.style.cursor="not-allowed");let a=n.createEl("button",{text:"Create New Agent",cls:"letta-create-agent-button"});a.style.cssText="opacity: 0.7; font-size: 0.9em;",a.addEventListener("mouseenter",()=>{a.style.opacity="1"}),a.addEventListener("mouseleave",()=>{a.style.opacity="0.7"}),a.addEventListener("click",async()=>{let i=new g.Modal(this.app);i.titleEl.setText("Create New Agent");let l=i.contentEl;l.createEl("p",{text:"Are you sure you want to create a new agent? This will open the agent configuration modal."});let r=l.createEl("div",{cls:"modal-button-container"});r.style.cssText="display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px;",r.createEl("button",{text:"Cancel"}).addEventListener("click",()=>i.close()),r.createEl("button",{text:"Create Agent",cls:"mod-cta"}).addEventListener("click",async()=>{i.close();let h=await new H(this.app,this.plugin).showModal();if(h)try{await this.createAgentFromConfig(h),new g.Notice("Agent created successfully!"),await this.showNoAgentMessage()}catch(p){console.error("[Letta Plugin] Failed to create agent:",p),new g.Notice(`Failed to create agent: ${p.message}`)}}),i.open()})}async createAgentFromConfig(e){if(!this.plugin.source)throw new Error("Source not set up");console.log("[Letta Plugin] Starting agent creation with config:",e);let t=this.plugin.settings.lettaBaseUrl.includes("api.letta.com"),n=null;if(t){console.log("[Letta Plugin] Cloud instance detected, checking projects...");try{let l=await this.plugin.makeRequest("/v1/projects");console.log("[Letta Plugin] Available projects response:",l);let r=l.projects||l;if(console.log("[Letta Plugin] Projects array:",r),this.plugin.settings.lettaProjectSlug&&(n=r.find(c=>c.slug===this.plugin.settings.lettaProjectSlug),n||console.warn(`[Letta Plugin] Configured project "${this.plugin.settings.lettaProjectSlug}" not found`)),!n&&r.length>0&&(n=r[0],console.log("[Letta Plugin] Using first available project:",n),console.log("[Letta Plugin] Project fields available:",Object.keys(n))),!n)throw new Error("No projects available. Please create a project first in your Letta instance.")}catch(l){throw console.error("[Letta Plugin] Project setup failed:",l),new Error(`Failed to setup project: ${l.message}`)}}console.log("[Letta Plugin] Fetching embedding models...");let s=await this.plugin.makeRequest("/v1/models/embedding");console.log("[Letta Plugin] Available embedding configs:",s);let o=s.find(l=>l.handle==="letta/letta-free"||l.handle&&l.handle.includes("letta"))||s[0];console.log("[Letta Plugin] Selected embedding config:",o);let a={name:e.name,agent_type:e.agent_type||"memgpt_v2_agent",description:e.description,model:e.model,include_base_tools:!1,include_multi_agent_tools:e.include_multi_agent_tools,include_default_source:e.include_default_source,tags:e.tags,memory_blocks:e.memory_blocks,source_ids:[this.plugin.source.id],tools:["memory_replace","memory_insert","memory_rethink"]};t||(a.embedding_config=o),t&&n&&(a.project=n.slug,console.log("[Letta Plugin] Using project for agent creation:",n.slug)),Object.keys(a).forEach(l=>{a[l]===void 0&&delete a[l]}),console.log("[Letta Plugin] Creating agent with config:",JSON.stringify(a,null,2));let i;try{i=await this.plugin.makeRequest("/v1/agents",{method:"POST",body:a}),console.log("[Letta Plugin] Agent created successfully:",i)}catch(l){throw console.error("[Letta Plugin] Agent creation failed with error:",l),console.error("[Letta Plugin] Error details:",{status:l.status,message:l.message,responseText:l.responseText,responseJson:l.responseJson,url:`${this.plugin.settings.lettaBaseUrl}/v1/agents`,method:"POST",body:a}),l}this.plugin.agent={id:i.id,name:i.name},this.plugin.settings.agentId=i.id,this.plugin.settings.agentName=e.name,n&&(this.plugin.settings.lettaProjectSlug=n.slug,console.log("[Letta Plugin] Updated project settings to:",n.slug)),await this.plugin.saveSettings()}removeNoAgentMessage(){if(!this.chatContainer)return;let e=this.chatContainer.querySelector(".letta-no-agent-container");e&&e.remove()}openInADE(){var t;if(!this.plugin.agent){new g.Notice("Please connect to Letta first");return}let e=`https://app.letta.com/agents/${(t=this.plugin.agent)==null?void 0:t.id}`;window.open(e,"_blank"),new g.Notice("Opening agent in Letta ADE...")}async updateModelButton(){var e;if(!this.plugin.agent){this.modelButton.textContent="N/A";return}try{let t=await this.plugin.makeRequest(`/v1/agents/${(e=this.plugin.agent)==null?void 0:e.id}`);if(t&&t.llm_config&&t.llm_config.model){let n=t.llm_config.model,s=t.llm_config.provider_name||"Unknown",o=t.llm_config.provider_category||"Unknown",a=o==="byok"?" (BYOK)":"";this.modelButton.textContent=`${s}/${n}${a}`,this.modelButton.title=`Current model: ${n}
Provider: ${s}
Category: ${o}
Click to change model`}else this.modelButton.textContent="Unknown"}catch(t){console.error("Error fetching agent model info:",t),this.modelButton.textContent="Error"}}openModelSwitcher(){if(!this.plugin.agent){new g.Notice("Please connect to Letta first");return}new G(this.app,this.plugin,this.plugin.agent).open()}async editAgentName(){var n;if(!this.plugin.agent){new g.Notice("Please connect to Letta first");return}let e=this.plugin.settings.agentName,t=await this.promptForAgentName(e);if(t&&t!==e)try{await this.plugin.makeRequest(`/v1/agents/${(n=this.plugin.agent)==null?void 0:n.id}`,{method:"PATCH",body:{name:t}}),this.plugin.settings.agentName=t,await this.plugin.saveSettings(),this.updateAgentNameDisplay(),this.plugin.agent.name=t,new g.Notice(`Agent name updated to: ${t}`)}catch(s){console.error("Failed to update agent name:",s),new g.Notice("Failed to update agent name. Please try again.")}}promptForAgentName(e){return new Promise(t=>{let n=new g.Modal(this.app);n.setTitle("Edit Agent Name");let{contentEl:s}=n;s.createEl("p",{text:"Enter a new name for your agent:"});let o=s.createEl("input",{type:"text",value:e,cls:"config-input"});o.style.width="100%",o.style.marginBottom="16px";let a=s.createEl("div");a.style.display="flex",a.style.gap="8px",a.style.justifyContent="flex-end";let i=a.createEl("button",{text:"Save",cls:"mod-cta"}),l=a.createEl("button",{text:"Cancel"});i.addEventListener("click",()=>{let r=o.value.trim();r&&(t(r),n.close())}),l.addEventListener("click",()=>{t(null),n.close()}),o.addEventListener("keydown",r=>{if(r.key==="Enter"){let c=o.value.trim();c&&(t(c),n.close())}r.key==="Escape"&&(t(null),n.close())}),n.open(),o.focus(),o.select()})}async openAgentConfig(){var s,o;if(!this.plugin.agent)try{if(await this.plugin.connectToLetta(),!this.plugin.agent){new g.Notice("Please configure your Letta connection first");return}}catch(a){new g.Notice("Failed to connect to Letta. Please check your settings.");return}let[e,t]=await Promise.all([this.plugin.makeRequest(`/v1/agents/${(s=this.plugin.agent)==null?void 0:s.id}`),this.plugin.makeRequest(`/v1/agents/${(o=this.plugin.agent)==null?void 0:o.id}/core-memory/blocks`)]);new V(this.app,e,t,async a=>{var i;try{let{blockUpdates:l,...r}=a;Object.keys(r).length>0&&await this.plugin.makeRequest(`/v1/agents/${(i=this.plugin.agent)==null?void 0:i.id}`,{method:"PATCH",body:r}),l&&l.length>0&&await Promise.all(l.map(async u=>{var h;await this.plugin.makeRequest(`/v1/agents/${(h=this.plugin.agent)==null?void 0:h.id}/core-memory/blocks/${u.label}`,{method:"PATCH",body:{value:u.value}})})),r.name&&r.name!==this.plugin.settings.agentName&&(this.plugin.settings.agentName=r.name,await this.plugin.saveSettings(),this.updateAgentNameDisplay(),this.plugin.agent&&(this.plugin.agent.name=r.name));let c=Object.keys(r).length>0,d=l&&l.length>0;c&&d?new g.Notice("Agent configuration and memory blocks updated successfully"):c?new g.Notice("Agent configuration updated successfully"):d&&new g.Notice("Memory blocks updated successfully")}catch(l){console.error("Failed to update agent configuration:",l),new g.Notice("Failed to update agent configuration. Please try again.")}}).open()}async sendMessage(){let e=this.messageInput.value.trim();if(e){if(!this.plugin.source&&(this.addMessage("assistant","Connecting to Letta...","System"),!await this.plugin.connectToLetta())){this.addMessage("assistant","**Connection failed**. Please check your settings and try again.","Error");return}if(!this.plugin.agent){this.addMessage("assistant","**No agent selected**. Please select an agent to start chatting.","System");return}this.messageInput.disabled=!0,this.sendButton.disabled=!0,this.sendButton.innerHTML="<span>Sending...</span>",this.sendButton.addClass("letta-button-loading"),this.addMessage("user",e),this.messageInput.value="",this.messageInput.style.height="auto";try{if(this.plugin.settings.enableStreaming)this.currentAssistantMessageEl&&(this.markStreamingComplete(),this.currentReasoningContent="",this.currentAssistantContent="",this.currentAssistantMessageEl=null,this.currentReasoningMessageEl=null,this.currentToolMessageEl=null,this.currentToolCallId=null,this.currentToolCallArgs="",this.currentToolCallName=""),this.resetStreamingState(),await this.plugin.sendMessageToAgentStream(e,t=>{this.processStreamingMessage(t)},t=>{console.error("Streaming error:",t),t.message&&t.message.includes("HTTP 429")?(console.log("[Letta Plugin] Rate limit error detected, showing specialized message"),this.addRateLimitMessage(P.create(t.message))):this.addMessage("assistant",`**Streaming Error**: ${t.message}`,"Error")},()=>{this.markStreamingComplete()});else{let t=await this.plugin.sendMessageToAgent(e);this.processNonStreamingMessages(t)}}catch(t){if(console.error("Failed to send message:",t),this.plugin.settings.enableStreaming&&(t.message.includes("stream")||t.message.includes("fetch")||t.message.includes("network")))try{let s=await this.plugin.sendMessageToAgent(e);this.processNonStreamingMessages(s);return}catch(s){console.error("Fallback also failed:",s),t=s}let n=`**Error**: ${t.message}`;if(t.message.includes("429")||t.message.includes("Rate limited")){let s=t.message.includes("model-unknown")?"Unknown model configuration":"Too many requests";this.addRateLimitMessage(P.create(s));return}else t.message.includes("401")||t.message.includes("Unauthorized")?n=`**Authentication Error**

Your API key may be invalid or expired. Please check your settings.

*${t.message}*`:t.message.includes("403")||t.message.includes("Forbidden")?n=`**Access Denied**

You don't have permission to access this resource. Please check your account permissions.

*${t.message}*`:t.message.includes("500")||t.message.includes("Internal Server Error")?n=`**Server Error**

Letta's servers are experiencing issues. Please try again in a few moments.

*${t.message}*`:n+=`

Please check your connection and try again.`;this.addMessage("assistant",n,"Error")}finally{this.messageInput.disabled=!1,this.sendButton.disabled=!1,this.sendButton.innerHTML="<span>Send</span>",this.sendButton.removeClass("letta-button-loading"),this.messageInput.focus()}}}cleanupPreviousToolCalls(){this.chatContainer.querySelectorAll(".letta-tool-curve").forEach(n=>n.remove()),this.chatContainer.querySelectorAll(".letta-tool-prominent").forEach(n=>n.removeClass("letta-tool-prominent"))}addToolInteractionMessage(e,t){this.cleanupPreviousToolCalls();let n="Tool Call";try{let E=JSON.parse(t);E.name?n=E.name:E.function&&E.function.name&&(n=E.function.name)}catch(E){}let s=this.chatContainer.createEl("div",{cls:"letta-message letta-message-tool-interaction"}),o=s.createEl("div",{cls:"letta-message-bubble"}),a=new Date().toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}),l=o.createEl("div",{cls:"letta-message-header"}).createEl("div",{cls:"letta-message-header-left"});if(l.createEl("span",{cls:"letta-message-title",text:"Tool Usage"}),l.createEl("span",{cls:"letta-message-timestamp",text:a}),e&&this.plugin.settings.showReasoning){let E=o.createEl("div",{cls:"letta-tool-reasoning"}),b=e.trim().replace(/\n{3,}/g,`

`).replace(/^### (.+)$/gm,"<h3>$1</h3>").replace(/^## (.+)$/gm,"<h2>$1</h2>").replace(/^# (.+)$/gm,"<h1>$1</h1>").replace(/\*\*(.*?)\*\*/g,"<strong>$1</strong>").replace(/\*(.*?)\*/g,"<em>$1</em>").replace(/`([^`]+)`/g,"<code>$1</code>").replace(/^(\d+)\.\s+(.+)$/gm,'<li class="numbered-list">$2</li>').replace(/^[â€¢*-]\s+(.+)$/gm,"<li>$1</li>").replace(/\n\n/g,"</p><p>").replace(/\n/g,"<br>");b=b.replace(/(<li class="numbered-list">.*?<\/li>)(\s*<br>\s*<li class="numbered-list">.*?<\/li>)*/g,T=>"<ol>"+T.replace(/<br>\s*/g,"")+"</ol>"),b=b.replace(/(<li>(?!.*class="numbered-list").*?<\/li>)(\s*<br>\s*<li>(?!.*class="numbered-list").*?<\/li>)*/g,T=>"<ul>"+T.replace(/<br>\s*/g,"")+"</ul>"),b.includes("</p><p>")&&!b.startsWith("<")&&(b="<p>"+b+"</p>"),E.innerHTML=b}let r=o.createEl("div",{cls:"letta-expandable-header letta-tool-section letta-tool-prominent"}),d=r.createEl("div",{cls:"letta-tool-left"}).createEl("span",{cls:"letta-expandable-title letta-tool-name",text:n}),u=r.createEl("div",{cls:"letta-tool-connection"});u.innerHTML=`
			<svg viewBox="0 0 400 12" class="letta-tool-curve" preserveAspectRatio="none">
				<path d="M 0,6 Q 12.5,2 25,6 Q 37.5,10 50,6 Q 62.5,2 75,6 Q 87.5,10 100,6 Q 112.5,2 125,6 Q 137.5,10 150,6 Q 162.5,2 175,6 Q 187.5,10 200,6 Q 212.5,2 225,6 Q 237.5,10 250,6 Q 262.5,2 275,6 Q 287.5,10 300,6 Q 312.5,2 325,6 Q 337.5,10 350,6 Q 362.5,2 375,6 Q 387.5,10 400,6 Q 412.5,2 425,6 Q 437.5,10 450,6" 
					  stroke="var(--interactive-accent)" 
					  stroke-width="1.5" 
					  fill="none" 
					  opacity="0.7"/>
			</svg>
		`;let p=r.createEl("div",{cls:"letta-tool-right"}).createEl("span",{cls:"letta-expandable-chevron letta-tool-circle",text:"\u25CB"}),y=o.createEl("div",{cls:"letta-expandable-content letta-expandable-collapsed"}),f=y.createEl("pre",{cls:"letta-code-block"}),m=t;try{let E=JSON.parse(t);if(E.arguments){let b=E.arguments;typeof b=="string"&&(b=JSON.parse(b)),m=JSON.stringify(b,null,2)}}catch(E){}f.createEl("code",{text:m}),r.addEventListener("click",()=>{y.classList.contains("letta-expandable-collapsed")?(y.removeClass("letta-expandable-collapsed"),p.textContent="\u25CF"):(y.addClass("letta-expandable-collapsed"),p.textContent="\u25CB")});let v=o.createEl("div",{cls:"letta-expandable-header letta-tool-section letta-tool-result-pending"});v.style.display="none";let C=v.createEl("span",{cls:"letta-expandable-title",text:"Tool Result"}),k=v.createEl("span",{cls:"letta-expandable-chevron letta-tool-circle",text:"\u25CB"}),A=o.createEl("div",{cls:"letta-expandable-content letta-expandable-collapsed"});return A.style.display="none",setTimeout(()=>{this.chatContainer.scrollTo({top:this.chatContainer.scrollHeight,behavior:"smooth"})},10),s}addToolResultToMessage(e,t,n,s){let o=e.querySelector(".letta-message-bubble");if(!o)return;let a=o.querySelector(".letta-tool-curve");a&&a.remove();let i=o.querySelector(".letta-tool-prominent");i&&i.removeClass("letta-tool-prominent");let l=!1,r=!1,c=s;if(n)l=n==="archival_memory_search",r=n==="archival_memory_insert";else try{let h=o.querySelector(".letta-code-block code");if(h){c=JSON.parse(h.textContent||"{}");let p=c.name||c.function&&c.function.name;l=p==="archival_memory_search",r=p==="archival_memory_insert"}}catch(h){}let d=o.querySelector(".letta-tool-result-pending"),u=o.querySelector(".letta-expandable-content:last-child");if(d&&u){let h=this.formatToolResult(t),p=d.querySelector(".letta-expandable-title");if(p&&(p.textContent="Tool Result"),d.style.display="flex",u.style.display="block",d.removeClass("letta-tool-result-pending"),l)this.createArchivalMemoryDisplay(u,t);else if(r)this.createArchivalMemoryInsertDisplay(u,c,t);else{let f=u.createEl("div",{cls:"letta-tool-result-text",text:h})}let y=d.querySelector(".letta-expandable-chevron");d.addEventListener("click",()=>{u.classList.contains("letta-expandable-collapsed")?(u.removeClass("letta-expandable-collapsed"),y&&(y.textContent="\u25CF")):(u.addClass("letta-expandable-collapsed"),y&&(y.textContent="\u25CB"))})}setTimeout(()=>{this.chatContainer.scrollTo({top:this.chatContainer.scrollHeight,behavior:"smooth"})},10)}createArchivalMemoryDisplay(e,t){try{let n,s=t.trim();if(s.startsWith('"')&&s.endsWith('"')){let o=JSON.parse(s);if(o.startsWith("(")&&o.endsWith(")")){let i=o.slice(1,-1).match(/^(.+),\s*(\d+)$/);if(i){let l=i[1],r=/\{'timestamp':\s*'([^']+)',\s*'content':\s*'((?:[^'\\]|\\.)*)'\}/g,c=[],d;for(;(d=r.exec(l))!==null;){let u=d[1],h=d[2].replace(/\\'/g,"'").replace(/\\n/g,`
`).replace(/\\t/g,"	").replace(/\\"/g,'"');c.push({timestamp:u,content:h})}n=c}else n=JSON.parse(o)}else n=JSON.parse(o)}else if(s.startsWith("(")&&s.endsWith(")")){let a=s.slice(1,-1).match(/^(.+),\s*(\d+)$/);if(a){let i=a[1];i=i.replace(/None/g,"null").replace(/True/g,"true").replace(/False/g,"false").replace(/'/g,'"'),n=JSON.parse(i)}else n=JSON.parse(s)}else n=JSON.parse(s);if(Array.isArray(n)&&n.length>0){let o=e.createEl("div",{cls:"letta-memory-list"}),a=n.filter(i=>typeof i=="object"&&i!==null&&(i.content||i.text||i.message));a.forEach((i,l)=>{let r=o.createEl("div",{cls:"letta-memory-item"}),c=i.content||i.text||i.message||"",d=i.timestamp||"",u=r.createEl("div",{cls:"letta-memory-item-header letta-expandable-header"}),h=u.createEl("span",{cls:"letta-expandable-chevron",text:"\u25CB"}),p="";u.createEl("span",{cls:"letta-memory-title",text:p});let y=c.length>80?c.substring(0,80).trim()+"...":c;u.createEl("span",{cls:"letta-memory-preview",text:y});let f=r.createEl("div",{cls:"letta-memory-content letta-expandable-content letta-expandable-collapsed"}),m=c.trim().replace(/\n{3,}/g,`

`).replace(/^### (.+)$/gm,"<h3>$1</h3>").replace(/^## (.+)$/gm,"<h2>$1</h2>").replace(/^# (.+)$/gm,"<h1>$1</h1>").replace(/\*\*(.*?)\*\*/g,"<strong>$1</strong>").replace(/\*(.*?)\*/g,"<em>$1</em>").replace(/`([^`]+)`/g,"<code>$1</code>").replace(/^[â€¢*-]\s+(.+)$/gm,"<li>$1</li>").replace(/\n/g,"<br>");m=m.replace(/(<li>.*?<\/li>)(?:\s*<li>.*?<\/li>)*/g,v=>"<ul>"+v+"</ul>"),f.innerHTML=m,u.addEventListener("click",()=>{f.classList.contains("letta-expandable-collapsed")?(f.removeClass("letta-expandable-collapsed"),h.textContent="\u25CF"):(f.addClass("letta-expandable-collapsed"),h.textContent="\u25CB")})}),a.length>0&&e.createEl("div",{cls:"letta-memory-summary"}).createEl("span",{text:`Found ${a.length} memory item${a.length===1?"":"s"}`})}else if(n&&typeof n=="object"){let o=e.createEl("div",{cls:"letta-memory-single"}),i=(n.content||n.text||n.message||JSON.stringify(n,null,2)).trim().replace(/\n{3,}/g,`

`).replace(/^### (.+)$/gm,"<h3>$1</h3>").replace(/^## (.+)$/gm,"<h2>$1</h2>").replace(/^# (.+)$/gm,"<h1>$1</h1>").replace(/\*\*(.*?)\*\*/g,"<strong>$1</strong>").replace(/\*(.*?)\*/g,"<em>$1</em>").replace(/`([^`]+)`/g,"<code>$1</code>").replace(/\n/g,"<br>");o.innerHTML=i}else{let o=e.createEl("div",{cls:"letta-tool-result-text"});o.textContent=t}}catch(n){let s=e.createEl("div",{cls:"letta-tool-result-text"});s.textContent=t}}createArchivalMemoryInsertDisplay(e,t,n){try{let s="";if(t){let o=null;if(t.arguments)if(typeof t.arguments=="string")try{o=JSON.parse(t.arguments)}catch(a){console.warn("[Letta Plugin] Failed to parse arguments string:",t.arguments)}else o=t.arguments;else if(t.function&&t.function.arguments)if(typeof t.function.arguments=="string")try{o=JSON.parse(t.function.arguments)}catch(a){console.warn("[Letta Plugin] Failed to parse function arguments string:",t.function.arguments)}else o=t.function.arguments;o&&o.content&&(s=o.content)}if(s){e.createEl("div",{cls:"letta-memory-insert-header"}).createEl("span",{cls:"letta-memory-insert-label",text:"Content stored in archival memory:"});let a=e.createEl("div",{cls:"letta-memory-insert-content"}),i=s.trim().replace(/\n{3,}/g,`

`).replace(/^### (.+)$/gm,"<h3>$1</h3>").replace(/^## (.+)$/gm,"<h2>$1</h2>").replace(/^# (.+)$/gm,"<h1>$1</h1>").replace(/\*\*(.*?)\*\*/g,"<strong>$1</strong>").replace(/\*(.*?)\*/g,"<em>$1</em>").replace(/`([^`]+)`/g,"<code>$1</code>").replace(/\n/g,"<br>");a.innerHTML=i}else{let o=e.createEl("div",{cls:"letta-tool-result-text"});o.textContent=`Memory insert completed. Result: ${n}`}}catch(s){console.error("[Letta Plugin] Error creating archival memory insert display:",s);let o=e.createEl("div",{cls:"letta-tool-result-text"});o.textContent=`Memory insert completed. Result: ${n}`}}processNonStreamingMessages(e){let t="",n=null;for(let s of e){if(s.type==="system_alert"||s.message&&typeof s.message=="string"&&s.message.includes("prior messages have been hidden")){this.addSystemMessage(s);continue}if(s.type==="heartbeat"||s.message_type==="heartbeat"||s.role==="heartbeat"||s.reason&&(s.reason.includes("automated system message")||s.reason.includes("Function call failed, returning control")||s.reason.includes("request_heartbeat=true"))){this.handleHeartbeat();continue}switch(s.message_type){case"reasoning_message":s.reasoning&&(t+=s.reasoning);break;case"usage_statistics":this.addUsageStatisticsToLastMessage(s);break;case"tool_call_message":s.tool_call&&(n=this.addToolInteractionMessage(t,JSON.stringify(s.tool_call,null,2)),t="");break;case"tool_return_message":s.tool_return&&n&&(this.addToolResultToMessage(n,JSON.stringify(s.tool_return,null,2)),n=null);break;case"assistant_message":let o=s.content||s.text||s.message;if(Array.isArray(o)&&(o=o.map(a=>typeof a=="string"?a:a&&typeof a=="object"?a.text||a.content||a.message||a.value||JSON.stringify(a):String(a)).join("")),o){let a=this.filterSystemPromptContent(o);this.addMessage("assistant",a,this.plugin.settings.agentName,t||void 0),t=""}else console.warn("[Letta Plugin] Assistant message has no recognizable content field:",Object.keys(s)),this.addMessage("assistant",`**Debug**: ${JSON.stringify(s,null,2)}`,"Debug");break;case"heartbeat":break;default:if(s.content||s.text||s.message){let a=s.content||s.text||s.message;Array.isArray(a)&&(a=a.map(l=>typeof l=="string"?l:l&&typeof l=="object"?l.text||l.content||l.message||l.value||JSON.stringify(l):String(l)).join(""));let i=this.filterSystemPromptContent(a);this.addMessage("assistant",i,this.plugin.settings.agentName)}else console.warn("[Letta Plugin] Message has no recognizable content, displaying as debug info"),this.addMessage("assistant",`**Debug**: Unknown message structure
\`\`\`json
${JSON.stringify(s,null,2)}
\`\`\``,"Debug");break}}}processStreamingMessage(e){if(e.type==="system_alert"||e.message&&typeof e.message=="string"&&e.message.includes("prior messages have been hidden")){this.addSystemMessage(e);return}if(e.type==="heartbeat"||e.message_type==="heartbeat"||e.role==="heartbeat"||e.reason&&(e.reason.includes("automated system message")||e.reason.includes("Function call failed, returning control")||e.reason.includes("request_heartbeat=true"))){this.handleHeartbeat();return}if(!(e.type==="login"||e.message_type==="login")){if(e.message_type==="user_message"&&e.content&&typeof e.content=="string")try{if(JSON.parse(e.content.trim()).type==="login")return}catch(t){}if(e.message_type==="usage_statistics"){this.addUsageStatistics(e);return}switch(e.message_type){case"reasoning_message":e.reasoning&&this.updateOrCreateReasoningMessage(e.reasoning);break;case"tool_call_message":e.tool_call&&this.handleStreamingToolCall(e.tool_call);break;case"tool_return_message":e.tool_return&&(this.updateStreamingToolResult(e.tool_return),this.currentToolCallId=null,this.currentToolCallArgs="",this.currentToolCallName="");break;case"assistant_message":let t=e.content||e.text||e.message||e.assistant_message;if(Array.isArray(t)&&(t=t.map(n=>typeof n=="string"?n:n&&typeof n=="object"?n.text||n.content||n.message||n.value||JSON.stringify(n):String(n)).join("")),t){let n=this.filterSystemPromptContent(t);this.updateOrCreateAssistantMessage(n)}else console.warn("[Letta Plugin] Streaming assistant message has no recognizable content field:",Object.keys(e));break;case"heartbeat":break;default:break}}}updateOrCreateReasoningMessage(e){this.currentReasoningContent+=e}updateOrCreateAssistantMessage(e){if(this.currentAssistantContent+=e,!this.currentAssistantMessageEl){this.currentAssistantMessageEl=this.chatContainer.createEl("div",{cls:"letta-message letta-message-assistant"});let n=this.currentAssistantMessageEl.createEl("div",{cls:"letta-message-bubble"}),o=n.createEl("div",{cls:"letta-message-header"}).createEl("div",{cls:"letta-message-header-left"});if(o.createEl("span",{cls:"letta-message-title",text:this.plugin.settings.agentName}),o.createEl("span",{cls:"letta-message-timestamp",text:new Date().toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}),this.currentReasoningContent&&this.plugin.settings.showReasoning){let a=n.createEl("div",{cls:"letta-tool-reasoning"}),i=this.currentReasoningContent.trim().replace(/\n{3,}/g,`

`).replace(/^### (.+)$/gm,"<h3>$1</h3>").replace(/^## (.+)$/gm,"<h2>$1</h2>").replace(/^# (.+)$/gm,"<h1>$1</h1>").replace(/\*\*(.*?)\*\*/g,"<strong>$1</strong>").replace(/\*(.*?)\*/g,"<em>$1</em>").replace(/`([^`]+)`/g,"<code>$1</code>").replace(/^(\d+)\.\s+(.+)$/gm,'<li class="numbered-list">$2</li>').replace(/^[â€¢*-]\s+(.+)$/gm,"<li>$1</li>").replace(/\n\n/g,"</p><p>").replace(/\n/g,"<br>");i=i.replace(/(<li class="numbered-list">.*?<\/li>)(\s*<br>\s*<li class="numbered-list">.*?<\/li>)*/g,l=>"<ol>"+l.replace(/<br>\s*/g,"")+"</ol>"),i=i.replace(/(<li>(?!.*class="numbered-list").*?<\/li>)(\s*<br>\s*<li>(?!.*class="numbered-list").*?<\/li>)*/g,l=>"<ul>"+l.replace(/<br>\s*/g,"")+"</ul>"),i.includes("</p><p>")&&!i.startsWith("<")&&(i="<p>"+i+"</p>"),a.innerHTML=i}n.createEl("div",{cls:"letta-message-content"})}let t=this.currentAssistantMessageEl.querySelector(".letta-message-content");if(t){let n=this.currentAssistantContent.trim().replace(/\n{3,}/g,`

`).replace(/^### (.+)$/gm,"<h3>$1</h3>").replace(/^## (.+)$/gm,"<h2>$1</h2>").replace(/^# (.+)$/gm,"<h1>$1</h1>").replace(/\*\*(.*?)\*\*/g,"<strong>$1</strong>").replace(/\*(.*?)\*/g,"<em>$1</em>").replace(/`([^`]+)`/g,"<code>$1</code>").replace(/^(\d+)\.\s+(.+)$/gm,'<li class="numbered-list">$2</li>').replace(/^[â€¢*-]\s+(.+)$/gm,"<li>$1</li>").replace(/\n\n/g,"</p><p>").replace(/\n/g,"<br>");n=n.replace(/(<li class="numbered-list">.*?<\/li>)(\s*<br>\s*<li class="numbered-list">.*?<\/li>)*/g,s=>"<ol>"+s.replace(/<br>\s*/g,"")+"</ol>"),n=n.replace(/(<li>(?!.*class="numbered-list").*?<\/li>)(\s*<br>\s*<li>(?!.*class="numbered-list").*?<\/li>)*/g,s=>"<ul>"+s.replace(/<br>\s*/g,"")+"</ul>"),n.includes("</p><p>")&&!n.startsWith("<")&&(n="<p>"+n+"</p>"),t.innerHTML=n}setTimeout(()=>{this.chatContainer.scrollTo({top:this.chatContainer.scrollHeight,behavior:"smooth"})},10)}createStreamingToolInteraction(e){this.cleanupPreviousToolCalls();let t="Tool Call";try{e.name?t=e.name:e.function&&e.function.name&&(t=e.function.name)}catch(y){}this.currentToolMessageEl=this.chatContainer.createEl("div",{cls:"letta-message letta-message-tool-interaction"});let n=this.currentToolMessageEl.createEl("div",{cls:"letta-message-bubble"}),s=new Date().toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}),a=n.createEl("div",{cls:"letta-message-header"}).createEl("div",{cls:"letta-message-header-left"});if(a.createEl("span",{cls:"letta-message-title",text:"Tool Usage"}),a.createEl("span",{cls:"letta-message-timestamp",text:s}),console.log("[Letta Plugin] Creating tool interaction with reasoning content:",this.currentReasoningContent),console.log("[Letta Plugin] showReasoning setting:",this.plugin.settings.showReasoning),this.currentReasoningContent&&this.plugin.settings.showReasoning){let y=n.createEl("div",{cls:"letta-tool-reasoning"}),f=this.currentReasoningContent.trim().replace(/\n{3,}/g,`

`).replace(/^### (.+)$/gm,"<h3>$1</h3>").replace(/^## (.+)$/gm,"<h2>$1</h2>").replace(/^# (.+)$/gm,"<h1>$1</h1>").replace(/\*\*(.*?)\*\*/g,"<strong>$1</strong>").replace(/\*(.*?)\*/g,"<em>$1</em>").replace(/`([^`]+)`/g,"<code>$1</code>").replace(/^(\d+)\.\s+(.+)$/gm,'<li class="numbered-list">$2</li>').replace(/^[â€¢*-]\s+(.+)$/gm,"<li>$1</li>").replace(/\n\n/g,"</p><p>").replace(/\n/g,"<br>");f=f.replace(/(<li class="numbered-list">.*?<\/li>)(\s*<br>\s*<li class="numbered-list">.*?<\/li>)*/g,m=>"<ol>"+m.replace(/<br>\s*/g,"")+"</ol>"),f=f.replace(/(<li>(?!.*class="numbered-list").*?<\/li>)(\s*<br>\s*<li>(?!.*class="numbered-list").*?<\/li>)*/g,m=>"<ul>"+m.replace(/<br>\s*/g,"")+"</ul>"),f.includes("</p><p>")&&!f.startsWith("<")&&(f="<p>"+f+"</p>"),y.innerHTML=f,console.log("[Letta Plugin] Successfully created reasoning element with content")}else console.log("[Letta Plugin] Not displaying reasoning content - either empty or setting disabled"),console.log("[Letta Plugin] Reasoning content length:",this.currentReasoningContent.length),console.log("[Letta Plugin] showReasoning setting:",this.plugin.settings.showReasoning);let i=n.createEl("div",{cls:"letta-expandable-header letta-tool-section letta-tool-prominent"});i.createEl("div",{cls:"letta-tool-left"}).createEl("span",{cls:"letta-expandable-title letta-tool-name",text:t});let r=i.createEl("div",{cls:"letta-tool-connection"});r.innerHTML=`
			<svg viewBox="0 0 400 12" class="letta-tool-curve" preserveAspectRatio="none">
				<path d="M 0,6 Q 12.5,2 25,6 Q 37.5,10 50,6 Q 62.5,2 75,6 Q 87.5,10 100,6 Q 112.5,2 125,6 Q 137.5,10 150,6 Q 162.5,2 175,6 Q 187.5,10 200,6 Q 212.5,2 225,6 Q 237.5,10 250,6 Q 262.5,2 275,6 Q 287.5,10 300,6 Q 312.5,2 325,6 Q 337.5,10 350,6 Q 362.5,2 375,6 Q 387.5,10 400,6 Q 412.5,2 425,6 Q 437.5,10 450,6" 
					  stroke="var(--interactive-accent)" 
					  stroke-width="1.5" 
					  fill="none" 
					  opacity="0.7"/>
			</svg>
		`,i.createEl("div",{cls:"letta-tool-right"}).createEl("span",{cls:"letta-expandable-chevron letta-tool-circle",text:"\u25CB"});let d=n.createEl("div",{cls:"letta-expandable-content letta-expandable-collapsed"});d.createEl("pre",{cls:"letta-code-block"}).createEl("code",{text:JSON.stringify(e,null,2)}),i.addEventListener("click",()=>{d.classList.contains("letta-expandable-collapsed")?(d.removeClass("letta-expandable-collapsed"),i.querySelector(".letta-expandable-chevron").textContent="\u25CF"):(d.addClass("letta-expandable-collapsed"),i.querySelector(".letta-expandable-chevron").textContent="\u25CB")});let h=n.createEl("div",{cls:"letta-expandable-header letta-tool-section letta-tool-result-pending"});h.style.display="none",h.createEl("span",{cls:"letta-expandable-title",text:"Tool Result"}),h.createEl("span",{cls:"letta-expandable-chevron letta-tool-circle",text:"\u25CB"});let p=n.createEl("div",{cls:"letta-expandable-content letta-expandable-collapsed"});p.style.display="none",setTimeout(()=>{this.chatContainer.scrollTo({top:this.chatContainer.scrollHeight,behavior:"smooth"})},10),this.currentReasoningContent="",console.log("[Letta Plugin] Cleared reasoning content after creating tool interaction")}updateStreamingToolResult(e){this.currentToolMessageEl&&(this.addToolResultToMessage(this.currentToolMessageEl,JSON.stringify(e,null,2)),setTimeout(()=>{this.chatContainer.scrollTo({top:this.chatContainer.scrollHeight,behavior:"smooth"})},10))}resetStreamingState(){this.currentAssistantMessageEl&&this.currentAssistantMessageEl.remove(),this.currentToolMessageEl&&this.currentToolMessageEl.remove(),this.currentReasoningContent="",this.currentAssistantContent="",this.currentAssistantMessageEl=null,this.currentReasoningMessageEl=null,this.currentToolMessageEl=null,this.currentToolCallId=null,this.currentToolCallArgs="",this.currentToolCallName=""}markStreamingComplete(){this.currentAssistantMessageEl&&this.currentAssistantMessageEl.classList.add("streaming-complete"),this.hideTypingIndicator()}addUsageStatistics(e){this.currentAssistantMessageEl&&this.addUsageStatsToElement(this.currentAssistantMessageEl,e)}addUsageStatisticsToLastMessage(e){let t=this.chatContainer.querySelectorAll(".letta-message-assistant");if(t.length===0)return;let n=t[t.length-1];this.addUsageStatsToElement(n,e)}addUsageStatsToElement(e,t){let n=e.querySelector(".letta-message-bubble");if(!n||n.querySelector(".letta-usage-stats"))return;let o=n.createEl("div",{cls:"letta-usage-stats"}),a=[];if(t.total_tokens)a.push(`${t.total_tokens.toLocaleString()} tokens`);else if(t.prompt_tokens||t.completion_tokens){let i=t.prompt_tokens||0,l=t.completion_tokens||0,r=i+l;a.push(`${r.toLocaleString()} tokens`)}t.step_count&&a.push(`${t.step_count} step${t.step_count===1?"":"s"}`),a.length>0&&(o.textContent=a.join(" \u2022 "))}handleStreamingToolCall(e){let t=e.tool_call_id||e.id,n=e.name||e.function&&e.function.name||"Tool Call",s=e.arguments||e.args||"";if(this.currentToolCallId!==t)console.log("[Letta Plugin] Creating new tool interaction with reasoning content:",this.currentReasoningContent),this.currentToolCallId=t,this.currentToolCallName=n,this.currentToolCallArgs=s,this.createStreamingToolInteraction(e);else if(this.currentToolCallArgs+=s,this.currentToolMessageEl){let o=this.currentToolMessageEl.querySelector(".letta-code-block code");if(o){let a={...e,arguments:this.currentToolCallArgs};o.textContent=JSON.stringify(a,null,2)}}console.log(`[Letta Plugin] Tool call chunk received: ${t}, args: "${s}" (accumulated: "${this.currentToolCallArgs}")`)}async openAgentSwitcher(){if(!this.plugin.settings.lettaApiKey){new g.Notice("Please configure your Letta API key first");return}if(this.plugin.settings.lettaBaseUrl.includes("api.letta.com")){let t=this.plugin.settings.lettaProjectSlug;if(!(t&&t!=="obsidian-vault"&&t!=="default-project"&&t!=="filesystem"&&t.includes("-")&&t.length>10)){new g.Notice("Please select a valid project first"),this.openProjectSelector();return}let s={id:t,name:t||"Current Project",slug:t};this.openAgentSelector(s,!0)}else this.openAgentSelector()}async openProjectSelector(){let e=new g.Modal(this.app);e.setTitle("Select Project");let{contentEl:t}=e;t.style.width="700px",t.style.height="500px";let n=t.createEl("div",{text:"Loading projects and counting agents...",cls:"letta-memory-empty"});try{console.log("[Letta Plugin] Making request to /v1/projects");let s=await this.plugin.makeRequest("/v1/projects");console.log("[Letta Plugin] Projects response:",s),n.remove();let o;if(Array.isArray(s)?o=s:s.projects?o=s.projects:o=[],!o||o.length===0){t.createEl("div",{text:"No projects found",cls:"letta-memory-empty"});return}let a=t.createEl("div");a.style.maxHeight="400px",a.style.overflowY="auto",console.log("[Letta Plugin] Fetching agent counts for projects:",o);let i=await Promise.all(o.map(async l=>{try{let r=await this.plugin.makeRequest(`/v1/agents?project_id=${l.id}`);return console.log(`[Letta Plugin] Project ${l.name} has ${(r==null?void 0:r.length)||0} agents:`,r),{...l,agentCount:(r==null?void 0:r.length)||0}}catch(r){return console.warn(`Failed to get agent count for project ${l.name}:`,r),{...l,agentCount:0}}}));console.log("[Letta Plugin] Projects with counts:",i);for(let l of i){let r=a.createEl("div");r.style.padding="12px",r.style.border="1px solid var(--background-modifier-border)",r.style.borderRadius="8px",r.style.marginBottom="8px",r.style.cursor="pointer",r.style.transition="background 0.2s ease",l.agentCount===0&&(r.style.opacity="0.6",r.style.cursor="not-allowed");let c=r.createEl("div");c.style.display="flex",c.style.justifyContent="space-between",c.style.alignItems="center",c.style.marginBottom="4px",c.style.gap="12px";let d=c.createEl("div",{text:l.name});d.style.fontWeight="600",d.style.flex="1",d.style.minWidth="0",d.style.overflow="hidden",d.style.textOverflow="ellipsis",d.style.whiteSpace="nowrap";let u=c.createEl("div",{text:`${l.agentCount||0} agent${(l.agentCount||0)!==1?"s":""}`});u.style.fontSize="0.8em",u.style.color=(l.agentCount||0)>0?"var(--color-green)":"var(--text-muted)",u.style.fontWeight="500",u.style.flexShrink="0",u.style.whiteSpace="nowrap",u.style.backgroundColor="var(--background-modifier-border)",u.style.padding="2px 6px",u.style.borderRadius="4px";let h=r.createEl("div",{text:l.slug});if(h.style.fontSize="0.9em",h.style.color="var(--text-muted)",l.agentCount===0){let p=r.createEl("div",{text:"No agents available"});p.style.fontSize="0.8em",p.style.color="var(--text-faint)",p.style.fontStyle="italic",p.style.marginTop="4px"}r.addEventListener("mouseenter",()=>{l.agentCount>0&&(r.style.backgroundColor="var(--background-modifier-hover)")}),r.addEventListener("mouseleave",()=>{r.style.backgroundColor=""}),r.addEventListener("click",()=>{l.agentCount>0?(console.log("[Letta Plugin] Project selected:",l),e.close(),this.openAgentSelector(l)):new g.Notice(`Project "${l.name}" has no agents available`)})}}catch(s){console.error("[Letta Plugin] Failed to load projects:",s),n.textContent=`Failed to load projects: ${s.message||"Please check your connection."}`}e.open()}async openAgentSelector(e,t){var i;let n=new g.Modal(this.app);n.setTitle(e?`Select Agent - ${e.name}`:"Select Agent");let{contentEl:s}=n;if(s.style.width="700px",s.style.height="600px",this.plugin.settings.lettaBaseUrl.includes("api.letta.com")&&this.plugin.settings.lettaApiKey){let l=s.createEl("div");l.style.display="flex",l.style.gap="8px",l.style.marginBottom="16px",e&&t?l.createEl("button",{text:"Change Project",cls:"letta-clear-button"}).addEventListener("click",()=>{n.close(),this.openProjectSelector()}):e&&!t?l.createEl("button",{text:"\u2190 Back to Projects",cls:"letta-clear-button"}).addEventListener("click",()=>{n.close(),this.openProjectSelector()}):l.createEl("button",{text:"Select Project",cls:"letta-clear-button"}).addEventListener("click",()=>{n.close(),this.openProjectSelector()})}let a=s.createEl("div",{text:"Loading agents...",cls:"letta-memory-empty"});try{let l=new URLSearchParams;e&&l.append("project_id",e.id);let r=l.toString(),c=`/v1/agents${r?"?"+r:""}`,d=await this.plugin.makeRequest(c);if(a.remove(),!d||d.length===0){let m=s.createEl("div",{cls:"letta-memory-empty"});if(m.style.textAlign="center",m.style.padding="40px",m.createEl("div",{text:e?`No agents found in "${e.name}"`:"No agents found",cls:"letta-memory-empty"}),e)if(t){m.createEl("p",{text:"Your current project doesn't have any agents yet. Try selecting a different project or create a new agent.",cls:"letta-memory-empty"});let v=m.createEl("button",{text:"Change Project",cls:"letta-clear-button"});v.style.marginTop="16px",v.addEventListener("click",()=>{n.close(),this.openProjectSelector()})}else{m.createEl("p",{text:"This project doesn't have any agents yet. Try selecting a different project or create a new agent.",cls:"letta-memory-empty"});let v=m.createEl("button",{text:"\u2190 Back to Projects",cls:"letta-clear-button"});v.style.marginTop="16px",v.addEventListener("click",()=>{n.close(),this.openProjectSelector()})}return}let u=s.createEl("div",{cls:"agent-selector-list"});u.style.maxHeight="450px",u.style.overflowY="auto",u.style.border="1px solid var(--background-modifier-border)",u.style.borderRadius="6px";let h=u.createEl("table",{cls:"model-table"}),y=h.createEl("thead").createEl("tr");y.createEl("th",{text:"Agent Name"}),y.createEl("th",{text:"Template"}),y.createEl("th",{text:"Agent ID"}),y.createEl("th",{text:"Status"});let f=h.createEl("tbody");for(let m of d){let v=f.createEl("tr",{cls:"model-table-row"});v.createEl("td",{cls:"model-cell-name"}).createEl("span",{text:m.name,cls:"model-name"}),v.createEl("td",{text:m.template_id||"Unknown",cls:"model-cell-provider"});let k=v.createEl("td",{cls:"model-cell-context"}),A=m.id.substring(0,8)+"...";k.createEl("span",{text:A,title:m.id});let E=v.createEl("td",{cls:"model-cell-status"});m.id===((i=this.plugin.agent)==null?void 0:i.id)?E.createEl("span",{text:"Current",cls:"model-current-badge"}):E.createEl("span",{text:"Available",cls:"model-available-badge"}),v.addEventListener("click",()=>{n.close(),this.switchToAgent(m,e)}),v.style.cursor="pointer",v.addEventListener("mouseenter",()=>{v.style.backgroundColor="var(--background-modifier-hover)"}),v.addEventListener("mouseleave",()=>{v.style.backgroundColor=""})}}catch(l){console.error("Failed to load agents:",l),a.remove();let r=s.createEl("div",{cls:"letta-memory-error"});if(r.style.textAlign="center",r.style.padding="40px",l.message&&(l.message.includes("Project not found")||l.message.includes("Agent not found")&&e)){let c=r.createEl("h3",{text:"Project Not Found"});c.style.cssText="margin-bottom: 16px; color: var(--text-error);";let d=r.createEl("p",{text:`The project "${(e==null?void 0:e.id)||"default-project"}" does not exist or you don't have access to it.`});if(d.style.cssText="margin-bottom: 16px;",this.plugin.settings.lettaBaseUrl.includes("api.letta.com")){let h=r.createEl("button",{text:"Select Different Project",cls:"letta-connect-button"});h.style.marginRight="12px",h.addEventListener("click",()=>{n.close(),this.openProjectSelector()})}r.createEl("button",{text:"Check Settings",cls:"letta-model-button"}).addEventListener("click",()=>{n.close(),this.app.setting.open(),this.app.setting.openTabById("letta-obsidian")})}else{let c=r.createEl("h3",{text:"Failed to Load Agents"});c.style.cssText="margin-bottom: 16px; color: var(--text-error);";let d=r.createEl("p",{text:"Please check your connection and try again."});d.style.cssText="margin-bottom: 16px;",r.createEl("button",{text:"Retry",cls:"letta-connect-button"}).addEventListener("click",()=>{n.close(),this.openAgentSelector(e,t)})}}n.open()}async switchToAgent(e,t){try{console.log(`[Letta Plugin] Switching to agent: ${e.name} (ID: ${e.id})`),this.chatContainer.empty(),this.plugin.settings.agentName=e.name,this.plugin.settings.agentId=e.id,t&&(this.plugin.settings.lettaProjectSlug=t.slug),await this.plugin.saveSettings(),this.plugin.agent={id:e.id,name:e.name,...e};let n=await this.plugin.makeRequest(`/v1/agents/${e.id}`);if(!n)throw new Error(`Cannot access agent ${e.id} - may not exist or lack permissions`);console.log(`[Letta Plugin] Successfully verified agent access: ${n.name}`),this.updateAgentNameDisplay(),await this.updateChatStatus(!1),this.addMessage("assistant",`Started fresh conversation with **${e.name}**${t?` (Project: ${t.name})`:""}`,"System"),new g.Notice(`Switched to agent: ${e.name}`)}catch(n){console.error("Failed to switch agent:",n),new g.Notice(`Failed to switch agent: ${n.message}`),this.addMessage("assistant",`**Error**: Failed to switch agent: ${n.message}`,"Error")}}},q=class extends g.ItemView{constructor(e,t){super(e);this.blocks=[];this.blockEditors=new Map;this.blockSaveButtons=new Map;this.blockDirtyStates=new Map;this.lastRefreshTime=new Date;this.plugin=t}getViewType(){return F}getDisplayText(){return"Memory Blocks"}getIcon(){return"brain-circuit"}async onOpen(){let e=this.containerEl.children[1];e.empty(),e.addClass("letta-memory-view");let t=e.createEl("div",{cls:"letta-memory-header"});t.createEl("h3",{text:"Memory",cls:"letta-memory-title"});let n=t.createEl("div");n.style.display="flex",n.style.gap="8px";let s=n.createEl("span",{text:"New"});s.style.cssText="cursor: pointer; opacity: 0.7; padding: 2px 6px; margin: 0 4px;",s.addEventListener("mouseenter",()=>{s.style.opacity="1"}),s.addEventListener("mouseleave",()=>{s.style.opacity="0.7"}),s.addEventListener("click",()=>this.createNewBlock());let o=n.createEl("span",{text:"Manage"});o.style.cssText="cursor: pointer; opacity: 0.7; padding: 2px 6px; margin: 0 4px;",o.addEventListener("mouseenter",()=>{o.style.opacity="1"}),o.addEventListener("mouseleave",()=>{o.style.opacity="0.7"}),o.addEventListener("click",()=>this.searchAndAttachBlocks()),this.refreshButton=n.createEl("span",{text:"Refresh"}),this.refreshButton.style.cssText="cursor: pointer; opacity: 0.7; padding: 2px 6px; margin: 0 4px;",this.refreshButton.addEventListener("mouseenter",()=>{this.refreshButton.style.opacity="1"}),this.refreshButton.addEventListener("mouseleave",()=>{this.refreshButton.style.opacity="0.7"}),this.refreshButton.addEventListener("click",()=>this.loadBlocks());let a=e.createEl("div",{cls:"letta-memory-content"});await this.loadBlocks()}async loadBlocks(){var e;try{if(!this.plugin.source&&(new g.Notice("Connecting to Letta..."),!await this.plugin.connectToLetta())){this.showError("Failed to connect to Letta");return}this.refreshButton.style.opacity="0.5",this.refreshButton.style.pointerEvents="none",this.refreshButton.textContent="Loading...",this.blocks=await this.plugin.makeRequest(`/v1/agents/${(e=this.plugin.agent)==null?void 0:e.id}/core-memory/blocks`),this.lastRefreshTime=new Date,this.renderBlocks()}catch(t){console.error("Failed to load memory blocks:",t),this.showError("Failed to load memory blocks")}finally{this.refreshButton.style.opacity="0.7",this.refreshButton.style.pointerEvents="auto",this.refreshButton.textContent="\u21BB Refresh"}}renderBlocks(){let e=this.containerEl.querySelector(".letta-memory-content");if(e.empty(),!this.blocks||this.blocks.length===0){e.createEl("div",{text:"No memory blocks found",cls:"letta-memory-empty"});return}this.blocks.forEach(t=>{let n=e.createEl("div",{cls:"letta-memory-block"}),s=n.createEl("div",{cls:"letta-memory-block-header"});s.createEl("div",{cls:"letta-memory-title-section"}).createEl("h4",{text:t.label||t.name||"Unnamed Block",cls:"letta-memory-block-title"});let a=s.createEl("div",{cls:"letta-memory-header-actions"}),i=a.createEl("span",{text:`${(t.value||"").length}/${t.limit||5e3}`,cls:"letta-memory-char-counter"}),l=a.createEl("button",{text:"Detach",cls:"letta-memory-action-btn letta-memory-detach-btn",attr:{title:"Detach block from agent (keeps block in system)"}}),r=a.createEl("button",{text:"Delete",cls:"letta-memory-action-btn letta-memory-delete-btn",attr:{title:"Permanently delete this block"}});l.addEventListener("click",()=>this.detachBlock(t)),r.addEventListener("click",()=>this.deleteBlock(t)),t.description&&n.createEl("div",{text:t.description,cls:"letta-memory-block-description"});let c=n.createEl("textarea",{cls:"letta-memory-block-editor",attr:{placeholder:"Enter block content...","data-block-label":t.label||t.name}});c.value=t.value||"",t.read_only&&(c.disabled=!0,c.style.opacity="0.6"),c.addEventListener("input",()=>{let u=c.value.length,h=t.limit||5e3;i.textContent=`${u}/${h}`,u>h?i.style.color="var(--text-error)":i.style.color="var(--text-muted)";let p=c.value!==(t.value||"");this.blockDirtyStates.set(t.label||t.name,p),this.updateSaveButton(t.label||t.name,p)});let d=n.createEl("button",{text:"Save Changes",cls:"letta-memory-save-btn"});d.disabled=!0,d.addEventListener("click",()=>this.saveBlock(t.label||t.name)),this.blockEditors.set(t.label||t.name,c),this.blockSaveButtons.set(t.label||t.name,d),this.blockDirtyStates.set(t.label||t.name,!1)})}updateSaveButton(e,t){let n=this.blockSaveButtons.get(e);n&&(n.disabled=!t,n.textContent=t?"Save Changes":"No Changes")}async saveBlock(e){var s,o,a,i;let t=this.blockEditors.get(e),n=this.blockSaveButtons.get(e);if(!(!t||!n))try{n.disabled=!0,n.textContent="Checking...";let l=await this.plugin.makeRequest(`/v1/agents/${(s=this.plugin.agent)==null?void 0:s.id}/core-memory/blocks/${e}`),r=this.blocks.find(h=>(h.label||h.name)===e);if(!r)throw new Error("Local block not found");let c=(l.value||"").trim(),d=(r.value||"").trim(),u=t.value.trim();if(c!==d){n.textContent="Conflict Detected";let h=await this.showConflictDialog(e,d,c,u);if(h==="cancel"){n.textContent="Save Changes";return}else if(h==="keep-server"){t.value=c,r.value=c,this.blockDirtyStates.set(e,!1),n.textContent="No Changes";let p=(a=(o=this.containerEl.querySelector(`[data-block-label="${e}"]`))==null?void 0:o.parentElement)==null?void 0:a.querySelector(".letta-memory-char-counter");if(p){let y=r.limit||5e3;p.textContent=`${c.length}/${y}`,c.length>y?p.style.color="var(--text-error)":p.style.color="var(--text-muted)"}new g.Notice(`Memory block "${e}" updated with server version`);return}}n.textContent="Saving...",await this.plugin.makeRequest(`/v1/agents/${(i=this.plugin.agent)==null?void 0:i.id}/core-memory/blocks/${e}`,{method:"PATCH",body:{value:u}}),r.value=u,this.blockDirtyStates.set(e,!1),n.textContent="Saved \u2713",setTimeout(()=>{n.textContent="No Changes"},2e3),new g.Notice(`Memory block "${e}" updated successfully`)}catch(l){console.error(`Failed to save block ${e}:`,l),new g.Notice(`Failed to save block "${e}". Please try again.`),n.textContent="Save Changes"}finally{n.disabled=this.blockDirtyStates.get(e)!==!0}}showConflictDialog(e,t,n,s){return new Promise(o=>{let a=new g.Modal(this.app);a.setTitle("Memory Block Conflict");let{contentEl:i}=a;i.createEl("div",{cls:"conflict-warning"}).createEl("p",{text:`The memory block "${e}" has been changed on the server since you started editing.`,cls:"conflict-message"});let r=i.createEl("div",{cls:"conflict-versions"}),c=r.createEl("div",{cls:"conflict-section"});c.createEl("h4",{text:"\u{1F310} Server Version (Current)",cls:"conflict-section-title"});let d=c.createEl("textarea",{cls:"conflict-textarea",attr:{readonly:"true",rows:"6"}});d.value=n;let u=r.createEl("div",{cls:"conflict-section"});u.createEl("h4",{text:"\u270F\uFE0F Your Changes",cls:"conflict-section-title"});let h=u.createEl("textarea",{cls:"conflict-textarea",attr:{readonly:"true",rows:"6"}});h.value=s;let p=i.createEl("p",{text:`Server version: ${n.length} characters`,cls:"conflict-char-count"}),y=i.createEl("p",{text:`Your version: ${s.length} characters`,cls:"conflict-char-count"}),f=i.createEl("div",{cls:"conflict-buttons"}),m=f.createEl("button",{text:"Keep Server Version",cls:"conflict-btn conflict-btn-server"}),v=f.createEl("button",{text:"Overwrite with My Changes",cls:"conflict-btn conflict-btn-overwrite"}),C=f.createEl("button",{text:"Cancel",cls:"conflict-btn conflict-btn-cancel"});m.addEventListener("click",()=>{o("keep-server"),a.close()}),v.addEventListener("click",()=>{o("overwrite"),a.close()}),C.addEventListener("click",()=>{o("cancel"),a.close()}),a.open()})}showError(e){let t=this.containerEl.querySelector(".letta-memory-content");t.empty(),t.createEl("div",{text:e,cls:"letta-memory-error"})}async createNewBlock(){var t,n,s;if(!this.plugin.agent){new g.Notice("Please connect to Letta first");return}let e=await this.promptForNewBlock();if(e)try{console.log("[Letta Plugin] Creating block with data:",e);let o=await this.plugin.makeRequest("/v1/blocks",{method:"POST",body:{label:e.label,description:e.description,value:e.value,limit:e.limit}});console.log("[Letta Plugin] Block created successfully:",o),console.log(`[Letta Plugin] Attaching block ${o.id} to agent ${(t=this.plugin.agent)==null?void 0:t.id}`);let a=await this.plugin.makeRequest(`/v1/agents/${(n=this.plugin.agent)==null?void 0:n.id}/core-memory/blocks/attach/${o.id}`,{method:"PATCH"});console.log("[Letta Plugin] Block attached successfully:",a),new g.Notice(`Created and attached memory block: ${e.label}`),await this.loadBlocks()}catch(o){console.error("Failed to create and attach memory block:",o);try{console.log("[Letta Plugin] Trying message approach as fallback");let a=await this.plugin.makeRequest(`/v1/agents/${(s=this.plugin.agent)==null?void 0:s.id}/messages`,{method:"POST",body:{messages:[{role:"user",content:[{type:"text",text:`Please create a new memory block with label "${e.label}", description "${e.description}", and initial content: "${e.value}". Use core_memory_append or appropriate memory tools to add this information to your memory.`}]}]}});console.log("[Letta Plugin] Message approach result:",a),new g.Notice(`Requested agent to create memory block: ${e.label}`),setTimeout(()=>this.loadBlocks(),2e3)}catch(a){console.error("Both creation approaches failed:",o,a),new g.Notice("Failed to create memory block. This feature may not be available in the current API version.")}}}promptForNewBlock(){return new Promise(e=>{let t=new g.Modal(this.app);t.setTitle("Create New Memory Block");let{contentEl:n}=t;n.style.width="500px",n.createEl("div",{text:"Block Label:",cls:"config-label"});let s=n.createEl("input",{type:"text",placeholder:"e.g., user_preferences, project_context",cls:"config-input"});s.style.marginBottom="16px",n.createEl("div",{text:"Description:",cls:"config-label"});let o=n.createEl("input",{type:"text",placeholder:"Brief description of what this block is for...",cls:"config-input"});o.style.marginBottom="16px",n.createEl("div",{text:"Initial Content (optional):",cls:"config-label"});let a=n.createEl("textarea",{placeholder:"Enter initial content for this memory block (can be left empty)...",cls:"config-textarea"});a.style.height="120px",a.style.marginBottom="16px",n.createEl("div",{text:"Character Limit:",cls:"config-label"});let i=n.createEl("input",{cls:"config-input"});i.type="number",i.value="2000",i.min="100",i.max="8000",i.style.marginBottom="16px";let l=n.createEl("div");l.style.display="flex",l.style.gap="8px",l.style.justifyContent="flex-end";let r=l.createEl("button",{text:"Create Block",cls:"mod-cta"}),c=l.createEl("button",{text:"Cancel"});r.addEventListener("click",()=>{let d=s.value.trim(),u=o.value.trim(),h=a.value,p=parseInt(i.value)||2e3;if(!d){new g.Notice("Please enter a block label"),s.focus();return}if(!u){new g.Notice("Please enter a description"),o.focus();return}e({label:d,description:u,value:h,limit:p}),t.close()}),c.addEventListener("click",()=>{e(null),t.close()}),t.open(),s.focus()})}async detachBlock(e){var t;if(!this.plugin.agent){new g.Notice("Please connect to Letta first");return}try{if(!await this.showConfirmDialog("Detach Memory Block",`Are you sure you want to detach "${e.label||e.name}" from this agent? The block will remain in the system but won't be accessible to this agent.`,"Detach","var(--color-orange)"))return;console.log("[Letta Plugin] Detaching block:",e.label||e.name),await this.plugin.makeRequest(`/v1/agents/${(t=this.plugin.agent)==null?void 0:t.id}/core-memory/blocks/detach/${e.id}`,{method:"PATCH"}),new g.Notice(`Memory block "${e.label||e.name}" detached successfully`),await this.loadBlocks()}catch(n){console.error("Failed to detach block:",n),new g.Notice(`Failed to detach block "${e.label||e.name}". Please try again.`)}}async deleteBlock(e){if(!this.plugin.agent){new g.Notice("Please connect to Letta first");return}try{if(!await this.showConfirmDialog("Delete Memory Block",`\u26A0\uFE0F Are you sure you want to PERMANENTLY DELETE "${e.label||e.name}"? This action cannot be undone and will remove the block from the entire system.`,"Delete Forever","var(--text-error)"))return;console.log("[Letta Plugin] Deleting block:",e.label||e.name),await this.plugin.makeRequest(`/v1/blocks/${e.id}`,{method:"DELETE"}),new g.Notice(`Memory block "${e.label||e.name}" deleted permanently`),await this.loadBlocks()}catch(t){console.error("Failed to delete block:",t),new g.Notice(`Failed to delete block "${e.label||e.name}". Please try again.`)}}showConfirmDialog(e,t,n,s){return new Promise(o=>{let a=new g.Modal(this.app);a.setTitle(e);let{contentEl:i}=a,l=i.createEl("p",{text:t});l.style.marginBottom="20px",l.style.lineHeight="1.4";let r=i.createEl("div");r.style.display="flex",r.style.gap="12px",r.style.justifyContent="flex-end";let c=r.createEl("button",{text:"Cancel",cls:"conflict-btn conflict-btn-cancel"}),d=r.createEl("button",{text:n,cls:"conflict-btn"});d.style.background=s,d.style.color="var(--text-on-accent)",c.addEventListener("click",()=>{o(!1),a.close()}),d.addEventListener("click",()=>{o(!0),a.close()}),a.open()})}async searchAndAttachBlocks(){var e;if(!this.plugin.agent){new g.Notice("Please connect to Letta first");return}try{let t=await this.plugin.makeRequest(`/v1/agents/${(e=this.plugin.agent)==null?void 0:e.id}/core-memory/blocks`),n=new Set(t.map(i=>i.id)),s="?limit=100";if(this.plugin.settings.lettaProjectSlug)try{let l=(await this.plugin.makeRequest("/v1/projects")).find(r=>r.slug===this.plugin.settings.lettaProjectSlug);l&&(s+=`&project_id=${l.id}`)}catch(i){console.warn("Could not get project ID for filtering blocks:",i)}let a=(await this.plugin.makeRequest(`/v1/blocks${s}`)).filter(i=>!n.has(i.id)&&!i.is_template);if(a.length===0){new g.Notice("No unattached blocks found in the current scope");return}this.showBlockSearchModal(a)}catch(t){console.error("Failed to search blocks:",t),new g.Notice("Failed to search for blocks. Please try again.")}}showBlockSearchModal(e){let t=new g.Modal(this.app);t.setTitle("Manage Memory Blocks");let{contentEl:n}=t;n.addClass("block-search-modal");let s=n.createEl("div",{cls:"block-search-content"}),o=s.createEl("input",{type:"text",placeholder:"Search blocks by label, description, or content...",cls:"block-search-input"}),a=s.createEl("div",{text:`Found ${e.length} available blocks`,cls:"block-search-results-info"}),i=s.createEl("div",{cls:"block-search-list"}),l=d=>{if(i.empty(),a.textContent=`Found ${d.length} available blocks`,d.length===0){i.createEl("div",{text:"No blocks match your search",cls:"block-search-empty"});return}d.forEach(u=>{let h=i.createEl("div",{cls:"block-search-item"}),p=h.createEl("div",{cls:"block-search-item-header"}),y=p.createEl("div",{cls:"block-search-item-title"});y.createEl("h4",{text:u.label||"Unnamed Block"}),u.description&&y.createEl("div",{text:u.description,cls:"block-search-item-description"}),p.createEl("span",{text:`${(u.value||"").length} chars`,cls:"block-search-item-chars"});let f=(u.value||"").slice(0,200),m=h.createEl("div",{cls:"block-search-item-preview"});m.textContent=f+(u.value&&u.value.length>200?"...":""),h.addEventListener("click",()=>{t.close(),this.attachBlock(u)})})};l(e),o.addEventListener("input",()=>{let d=o.value.toLowerCase(),u=e.filter(h=>{let p=(h.label||"").toLowerCase(),y=(h.description||"").toLowerCase(),f=(h.value||"").toLowerCase();return p.includes(d)||y.includes(d)||f.includes(d)});l(u)}),s.createEl("div",{cls:"block-search-buttons"}).createEl("button",{text:"Cancel",cls:"conflict-btn conflict-btn-cancel"}).addEventListener("click",()=>t.close()),t.open(),o.focus()}async attachBlock(e){var t,n,s,o,a;if(!this.plugin.agent){new g.Notice("Please connect to Letta first");return}try{console.log("[Letta Plugin] Attaching block:",e.label||"Unnamed","to agent:",(t=this.plugin.agent)==null?void 0:t.id);let i=await this.plugin.makeRequest(`/v1/agents/${(n=this.plugin.agent)==null?void 0:n.id}`),l=((s=i.memory)==null?void 0:s.blocks)||[];if(console.log("[Letta Plugin] Current blocks before attach:",l.map(c=>c.label||c.id)),l.some(c=>c.id===e.id)){new g.Notice(`Memory block "${e.label||"Unnamed"}" is already attached to this agent`);return}try{await this.plugin.makeRequest(`/v1/agents/${(o=this.plugin.agent)==null?void 0:o.id}/core-memory/blocks/attach/${e.id}`,{method:"PATCH"}),console.log("[Letta Plugin] Successfully attached block using attach endpoint"),new g.Notice(`Memory block "${e.label||"Unnamed"}" attached successfully`)}catch(c){console.warn("[Letta Plugin] Attach endpoint failed, trying alternative approach:",c);let d=[...l.map(u=>u.id),e.id];await this.plugin.makeRequest(`/v1/agents/${(a=this.plugin.agent)==null?void 0:a.id}`,{method:"PATCH",body:{memory:{...i.memory,blocks:d}}}),console.log("[Letta Plugin] Successfully attached block using agent update approach"),new g.Notice(`Memory block "${e.label||"Unnamed"}" attached successfully`)}await this.loadBlocks()}catch(i){console.error("Failed to attach block:",i),new g.Notice(`Failed to attach block "${e.label||"Unnamed"}". Please try again.`)}}async onClose(){}},H=class extends g.Modal{constructor(e,t){super(e);this.plugin=t,this.config={name:t.settings.agentName,agent_type:"memgpt_v2_agent",description:"An AI assistant for your Obsidian vault",include_base_tools:!1,include_multi_agent_tools:!1,include_default_source:!1,tags:["obsidian","assistant"],model:"letta/letta-free",memory_blocks:[{value:"You are an AI assistant integrated with an Obsidian vault. You have access to the user's markdown files and can help them explore, organize, and work with their notes. Be helpful, knowledgeable, and concise.",label:"system",limit:2e3,description:"Core system instructions"}]}}async showModal(){return new Promise((e,t)=>{this.resolve=e,this.reject=t,this.open()})}onOpen(){var Q,J,W,z,Y;let{contentEl:e}=this;e.empty(),e.addClass("agent-config-modal");let t=e.createEl("div",{cls:"agent-config-header"});t.createEl("h2",{text:"Configure New Agent"}),t.createEl("p",{text:"Set up your Letta AI agent with custom configuration",cls:"agent-config-subtitle"});let n=e.createEl("div",{cls:"agent-config-form"}),s=n.createEl("div",{cls:"config-section"});s.createEl("h3",{text:"Basic Configuration"});let o=s.createEl("div",{cls:"config-group"});o.createEl("label",{text:"Agent Name",cls:"config-label"});let a=o.createEl("input",{type:"text",value:this.config.name,cls:"config-input"});a.addEventListener("input",()=>{this.config.name=a.value});let i=s.createEl("div",{cls:"config-group"});i.createEl("label",{text:"Agent Type",cls:"config-label"});let l=i.createEl("select",{cls:"config-select"});[{value:"memgpt_v2_agent",label:"MemGPT v2 Agent (Recommended)"},{value:"memgpt_agent",label:"MemGPT v1 Agent"},{value:"react_agent",label:"ReAct Agent"},{value:"workflow_agent",label:"Workflow Agent"},{value:"sleeptime_agent",label:"Sleeptime Agent"}].forEach(I=>{let N=l.createEl("option",{value:I.value,text:I.label});I.value===this.config.agent_type&&(N.selected=!0)}),l.addEventListener("change",()=>{this.config.agent_type=l.value});let c=s.createEl("div",{cls:"config-group"});c.createEl("label",{text:"Description",cls:"config-label"});let d=c.createEl("textarea",{value:this.config.description||"",cls:"config-textarea",attr:{rows:"3"}});d.addEventListener("input",()=>{this.config.description=d.value});let u=n.createEl("div",{cls:"config-section"});u.createEl("h3",{text:"Advanced Configuration"});let h=u.createEl("div",{cls:"config-group"});h.createEl("label",{text:"Model (Optional)",cls:"config-label"});let p=h.createEl("div",{text:"Format: provider/model-name (default: letta/letta-free)",cls:"config-help"}),y=h.createEl("input",{type:"text",value:this.config.model||"letta/letta-free",cls:"config-input",attr:{placeholder:"letta/letta-free"}});y.addEventListener("input",()=>{this.config.model=y.value||void 0});let f=u.createEl("div",{cls:"config-subsection"});f.createEl("h4",{text:"Tool Configuration"});let m=f.createEl("div",{cls:"config-checkbox-group"}),v=m.createEl("input",{cls:"config-checkbox"});v.type="checkbox",v.checked=(Q=this.config.include_base_tools)!=null?Q:!0,m.createEl("label",{text:"Include Base Tools (Core memory functions)",cls:"config-checkbox-label"}),v.addEventListener("change",()=>{this.config.include_base_tools=v.checked});let C=f.createEl("div",{cls:"config-checkbox-group"}),k=C.createEl("input",{cls:"config-checkbox"});k.type="checkbox",k.checked=(J=this.config.include_multi_agent_tools)!=null?J:!1,C.createEl("label",{text:"Include Multi-Agent Tools",cls:"config-checkbox-label"}),k.addEventListener("change",()=>{this.config.include_multi_agent_tools=k.checked});let A=n.createEl("div",{cls:"config-section"});A.createEl("h3",{text:"System Prompt"});let E=A.createEl("div",{cls:"config-group"});E.createEl("label",{text:"System Instructions",cls:"config-label"});let b=E.createEl("div",{text:"These instructions define how the agent behaves and responds",cls:"config-help"}),T=E.createEl("textarea",{value:((z=(W=this.config.memory_blocks)==null?void 0:W[0])==null?void 0:z.value)||"",cls:"config-textarea",attr:{rows:"6"}});T.addEventListener("input",()=>{this.config.memory_blocks||(this.config.memory_blocks=[]),this.config.memory_blocks.length===0&&this.config.memory_blocks.push({value:"",label:"system",limit:2e3,description:"Core system instructions"}),this.config.memory_blocks[0].value=T.value});let L=A.createEl("div",{cls:"config-group"});L.createEl("label",{text:"Tags (Optional)",cls:"config-label"});let B=L.createEl("div",{text:"Comma-separated tags for organizing agents",cls:"config-help"}),S=L.createEl("input",{type:"text",value:((Y=this.config.tags)==null?void 0:Y.join(", "))||"",cls:"config-input",attr:{placeholder:"obsidian, assistant, helpful"}});S.addEventListener("input",()=>{let I=S.value.split(",").map(N=>N.trim()).filter(N=>N.length>0);this.config.tags=I.length>0?I:void 0});let M=e.createEl("div",{cls:"agent-config-buttons"});M.createEl("button",{text:"Create Agent",cls:"mod-cta agent-config-create-btn"}).addEventListener("click",()=>{this.resolve(this.config),this.close()}),M.createEl("button",{text:"Cancel",cls:"agent-config-cancel-btn"}).addEventListener("click",()=>{this.resolve(null),this.close()}),a.focus()}onClose(){let{contentEl:e}=this;e.empty(),this.resolve&&this.resolve(null)}},G=class extends g.Modal{constructor(e,t,n){super(e);this.models=[];this.filteredModels=[];this.plugin=t,this.currentAgent=n}async onOpen(){var b,T,L;let{contentEl:e}=this;e.empty(),e.addClass("model-switcher-modal");let t=e.createEl("div",{cls:"agent-config-header"});t.createEl("h2",{text:"Select Model"}),t.createEl("p",{text:`Choose a model for agent: ${this.currentAgent.name}`,cls:"agent-config-subtitle"});let n=e.createEl("div",{cls:"agent-config-form"}),s=n.createEl("div",{cls:"config-section"});s.createEl("h3",{text:"Current Model"});let o=((b=this.currentAgent.llm_config)==null?void 0:b.model)||"Unknown",a=((T=this.currentAgent.llm_config)==null?void 0:T.provider_name)||"Unknown",i=((L=this.currentAgent.llm_config)==null?void 0:L.provider_category)||"Unknown";s.createEl("p",{text:`Model: ${o}`,cls:"config-help"}),s.createEl("p",{text:`Provider: ${a} (${i})`,cls:"config-help"});let l=n.createEl("div",{cls:"config-section"}),r=l.createEl("div",{cls:"filters-header"});r.createEl("h3",{text:"Filter Models"}),r.createEl("button",{text:"Clear Filters",cls:"clear-filters-btn"}).addEventListener("click",()=>this.clearFilters());let d=l.createEl("div",{cls:"filters-grid"}),u=d.createEl("div",{cls:"config-group"});u.createEl("label",{text:"Provider Category:",cls:"config-label"}),this.providerCategorySelect=u.createEl("select",{cls:"config-select"}),this.providerCategorySelect.createEl("option",{text:"All Categories",value:""}),this.providerCategorySelect.createEl("option",{text:"Base (Letta-hosted)",value:"base"}),this.providerCategorySelect.createEl("option",{text:"BYOK (Bring Your Own Key)",value:"byok"});let h=d.createEl("div",{cls:"config-group"});h.createEl("label",{text:"Provider:",cls:"config-label"}),this.providerNameSelect=h.createEl("select",{cls:"config-select"}),this.providerNameSelect.createEl("option",{text:"All Providers",value:""});let p=d.createEl("div",{cls:"config-group"}),y=p.createEl("label",{text:"Search Models:",cls:"config-label"}),f=p.createEl("div",{cls:"search-input-container"});this.searchInput=f.createEl("input",{cls:"config-input search-input",attr:{type:"text",placeholder:"Search models..."}});let m=f.createEl("button",{cls:"search-clear-btn",attr:{type:"button",title:"Clear search"}});m.innerHTML="\xD7",m.addEventListener("click",()=>{this.searchInput.value="",this.filterModels()});let v=n.createEl("div",{cls:"config-section"}),C=v.createEl("div",{cls:"models-header"});C.createEl("h3",{text:"Available Models"});let k=C.createEl("span",{cls:"results-counter",text:"Loading..."});this.resultsCounter=k,this.modelList=v.createEl("div",{cls:"block-search-list"}),this.modelList.createEl("div",{text:"Loading models...",cls:"block-search-empty"}),e.createEl("div",{cls:"agent-config-buttons"}).createEl("button",{text:"Cancel",cls:"agent-config-cancel-btn"}).addEventListener("click",()=>this.close()),await this.loadModels(),this.setupEventListeners()}async loadModels(){try{let e=await this.plugin.makeRequest("/v1/models/");this.models=e||[],this.updateProviderOptions(),this.filterModels()}catch(e){console.error("Error loading models:",e),this.modelList.empty(),this.modelList.createEl("div",{text:"Error loading models. Please try again.",cls:"block-search-empty"})}}updateProviderOptions(){let e=[...new Set(this.models.map(t=>t.provider_name).filter(Boolean))];for(;this.providerNameSelect.children.length>1;)this.providerNameSelect.removeChild(this.providerNameSelect.lastChild);e.sort().forEach(t=>{this.providerNameSelect.createEl("option",{text:t,value:t})})}setupEventListeners(){this.providerCategorySelect.addEventListener("change",()=>this.filterModels()),this.providerNameSelect.addEventListener("change",()=>this.filterModels()),this.searchInput.addEventListener("input",()=>this.filterModels()),this.searchInput.addEventListener("keydown",e=>{e.key==="Escape"?(this.searchInput.value="",this.filterModels()):e.key==="Enter"&&this.filteredModels.length===1&&this.selectModel(this.filteredModels[0])}),setTimeout(()=>this.searchInput.focus(),100)}clearFilters(){this.providerCategorySelect.value="",this.providerNameSelect.value="",this.searchInput.value="",this.filterModels()}highlightSearchTerm(e,t){if(!t)return e;let n=new RegExp(`(${t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")})`,"gi");return e.replace(n,'<mark class="search-highlight">$1</mark>')}filterModels(){let e=this.providerCategorySelect.value,t=this.providerNameSelect.value,n=this.searchInput.value.toLowerCase();this.filteredModels=this.models.filter(s=>{let o=!e||s.provider_category===e,a=!t||s.provider_name===t,i=!n||s.model.toLowerCase().includes(n);return o&&a&&i}),this.renderModels()}renderModels(){this.modelList.empty();let e=this.models.length,t=this.filteredModels.length;if(this.resultsCounter.textContent=`${t} of ${e} models`,this.filteredModels.length===0){this.modelList.createEl("div",{text:"No models found matching the current filters.",cls:"block-search-empty"});return}let n=this.modelList.createEl("table",{cls:"model-table"}),o=n.createEl("thead").createEl("tr");o.createEl("th",{text:"Model"}),o.createEl("th",{text:"Provider"}),o.createEl("th",{text:"Category"}),o.createEl("th",{text:"Context Window"}),o.createEl("th",{text:"Status"});let a=n.createEl("tbody");this.filteredModels.forEach(i=>{var m,v,C;let l=a.createEl("tr",{cls:"model-table-row"}),r=l.createEl("td",{cls:"model-cell-name"}),c=r.createEl("span",{cls:"model-name"}),d=this.searchInput.value.toLowerCase();c.innerHTML=this.highlightSearchTerm(i.model,d);let u=[`Provider: ${i.provider_name||"Unknown"}`,`Category: ${i.provider_category||"Unknown"}`,`Context: ${((m=i.context_window)==null?void 0:m.toLocaleString())||"Unknown"} tokens`,i.model_endpoint?`Endpoint: ${i.model_endpoint}`:null].filter(Boolean).join(`
`);r.setAttribute("title",u),l.createEl("td",{text:i.provider_name||"Unknown",cls:"model-cell-provider"});let p=l.createEl("td",{cls:"model-cell-category"}).createEl("span",{text:i.provider_category||"Unknown",cls:`model-category-badge model-category-${i.provider_category||"unknown"}`});l.createEl("td",{text:((v=i.context_window)==null?void 0:v.toLocaleString())||"Unknown",cls:"model-cell-context"});let y=l.createEl("td",{cls:"model-cell-status"}),f=(C=this.currentAgent.llm_config)==null?void 0:C.model;f===i.model?(y.createEl("span",{text:"\u2713 Current",cls:"model-current-badge"}).setAttribute("title","This model is currently selected for your agent"),l.classList.add("model-current-row")):y.createEl("span",{text:"Select",cls:"model-available-badge"}).setAttribute("title","Click to select this model"),f!==i.model?(l.addEventListener("click",()=>this.selectModel(i)),l.style.cursor="pointer",l.addEventListener("mouseenter",()=>{l.style.backgroundColor="var(--background-modifier-hover)"}),l.addEventListener("mouseleave",()=>{l.style.backgroundColor=""})):(l.style.cursor="default",l.style.opacity="0.7")})}async selectModel(e){try{let t={llm_config:{...this.currentAgent.llm_config,model:e.model,model_endpoint_type:e.model_endpoint_type,provider_name:e.provider_name,provider_category:e.provider_category,context_window:e.context_window,model_endpoint:e.model_endpoint,model_wrapper:e.model_wrapper}};await this.plugin.makeRequest(`/v1/agents/${this.currentAgent.id}`,{method:"PATCH",body:t}),new g.Notice(`Model updated to ${e.model}`),this.currentAgent.llm_config=t.llm_config;let n=this.app.workspace.getLeavesOfType($)[0];n&&n.view instanceof R&&n.view.updateModelButton(),this.close()}catch(t){console.error("Error updating model:",t),new g.Notice("Failed to update model. Please try again.")}}onClose(){let{contentEl:e}=this;e.empty()}},V=class extends g.Modal{constructor(e,t,n,s){super(e);this.agent=t,this.blocks=n,this.onSave=s}onOpen(){let{contentEl:e}=this;e.addClass("agent-property-modal");let t=e.createEl("div",{cls:"agent-config-header"});t.createEl("h2",{text:"Agent Configuration"}),t.createEl("p",{text:"Customize your agent's properties and behavior",cls:"agent-config-subtitle"});let n=e.createEl("div",{cls:"agent-config-form"}),s=n.createEl("div",{cls:"config-section"});s.createEl("h3",{text:"Basic Information"});let o=s.createEl("div",{cls:"config-group"});o.createEl("label",{text:"Agent Name",cls:"config-label"});let a=o.createEl("input",{type:"text",cls:"config-input",value:this.agent.name||""}),i=s.createEl("div",{cls:"config-group"});i.createEl("label",{text:"Description",cls:"config-label"}),i.createEl("div",{text:"Optional description for your agent",cls:"config-help"});let l=i.createEl("textarea",{cls:"config-textarea",attr:{rows:"3"}});l.value=this.agent.description||"";let r=n.createEl("div",{cls:"config-section"});r.createEl("h3",{text:"System Prompt"});let c=r.createEl("div",{cls:"config-group"});c.createEl("label",{text:"System Instructions",cls:"config-label"}),c.createEl("div",{text:"Instructions that define how your agent behaves and responds",cls:"config-help"});let d=c.createEl("textarea",{cls:"config-textarea",attr:{rows:"6"}});d.value=this.agent.system||"";let u=n.createEl("div",{cls:"config-section"});u.createEl("h3",{text:"Tags"});let h=u.createEl("div",{cls:"config-group"});h.createEl("label",{text:"Tags (comma-separated)",cls:"config-label"}),h.createEl("div",{text:"Organize your agent with tags for easy discovery",cls:"config-help"});let p=h.createEl("input",{type:"text",cls:"config-input",value:this.agent.tags?this.agent.tags.join(", "):""}),y=n.createEl("div",{cls:"config-section"});y.createEl("h3",{text:"Core Memory Blocks"}),this.blocks.forEach(E=>{var S;let b=y.createEl("div",{cls:"config-group"}),T=b.createEl("div",{cls:"block-header"});T.createEl("label",{text:`${E.label||E.name||"Unnamed Block"}`,cls:"config-label"});let L=T.createEl("span",{text:`${((S=E.value)==null?void 0:S.length)||0}/${E.limit||5e3} chars`,cls:"block-char-count"});E.description&&b.createEl("div",{text:E.description,cls:"config-help"});let B=b.createEl("textarea",{cls:"config-textarea block-editor",attr:{rows:"8","data-block-label":E.label||E.name}});B.value=E.value||"",E.read_only&&(B.disabled=!0,B.style.opacity="0.6"),B.addEventListener("input",()=>{let M=B.value.length,_=E.limit||5e3;L.textContent=`${M}/${_} chars`,M>_?L.style.color="var(--text-error)":L.style.color="var(--text-muted)"})});let f=n.createEl("div",{cls:"config-section"});f.createEl("h3",{text:"Memory Management"});let m=f.createEl("div",{cls:"config-checkbox-group"}),v=m.createEl("input",{type:"checkbox",cls:"config-checkbox"});v.checked=this.agent.message_buffer_autoclear||!1,m.createEl("label",{text:"Auto-clear message buffer (agent won't remember previous messages)",cls:"config-checkbox-label"});let C=e.createEl("div",{cls:"agent-config-buttons"}),k=C.createEl("button",{text:"Save Changes",cls:"agent-config-create-btn"}),A=C.createEl("button",{text:"Cancel",cls:"agent-config-cancel-btn"});k.addEventListener("click",async()=>{let E={},b=[];a.value.trim()!==this.agent.name&&(E.name=a.value.trim()),l.value.trim()!==(this.agent.description||"")&&(E.description=l.value.trim()||null),d.value.trim()!==(this.agent.system||"")&&(E.system=d.value.trim()||null);let T=p.value.trim()?p.value.split(",").map(S=>S.trim()).filter(S=>S):[],L=this.agent.tags||[];JSON.stringify(T)!==JSON.stringify(L)&&(E.tags=T),v.checked!==(this.agent.message_buffer_autoclear||!1)&&(E.message_buffer_autoclear=v.checked),n.querySelectorAll(".block-editor").forEach(S=>{let M=S.getAttribute("data-block-label"),_=this.blocks.find(O=>(O.label||O.name)===M);_&&S.value!==(_.value||"")&&b.push({label:M,value:S.value})}),(Object.keys(E).length>0||b.length>0)&&await this.onSave({...E,blockUpdates:b}),this.close()}),A.addEventListener("click",()=>{this.close()}),a.focus()}onClose(){let{contentEl:e}=this;e.empty()}},U=class extends g.PluginSettingTab{constructor(e,t){super(e,t);this.plugin=t}display(){let{containerEl:e}=this;e.empty(),e.createEl("h2",{text:"Letta AI Agent Settings"}),e.createEl("h3",{text:"API Configuration"}),new g.Setting(e).setName("Letta API Key").setDesc("Your Letta API key for authentication").addText(n=>n.setPlaceholder("sk-let-...").setValue(this.plugin.settings.lettaApiKey).onChange(async s=>{this.plugin.settings.lettaApiKey=s,await this.plugin.saveSettings()})),new g.Setting(e).setName("Letta Base URL").setDesc("Base URL for Letta API").addText(n=>n.setPlaceholder("https://api.letta.com").setValue(this.plugin.settings.lettaBaseUrl).onChange(async s=>{this.plugin.settings.lettaBaseUrl=s,await this.plugin.saveSettings()})),new g.Setting(e).setName("Project ID").setDesc("Current project identifier (automatically set when selecting agents)").addText(n=>n.setPlaceholder("Auto-detected from agent selection").setValue(this.plugin.settings.lettaProjectSlug).onChange(async s=>{this.plugin.settings.lettaProjectSlug=s,await this.plugin.saveSettings()})),e.createEl("h3",{text:"Agent Configuration"}),new g.Setting(e).setName("Agent ID").setDesc("ID of the agent to use with this vault. Leave empty to select an agent when starting chat.").addText(n=>n.setPlaceholder("Enter agent ID...").setValue(this.plugin.settings.agentId).onChange(async s=>{this.plugin.settings.agentId=s.trim(),s.trim()!==this.plugin.settings.agentId&&(this.plugin.settings.agentName=""),await this.plugin.saveSettings()})),new g.Setting(e).setName("Source Name").setDesc("Name for the Letta source containing your vault").addText(n=>n.setPlaceholder("obsidian-vault-files").setValue(this.plugin.settings.sourceName).onChange(async s=>{this.plugin.settings.sourceName=s,await this.plugin.saveSettings()}));let t=new g.Setting(e).setName("Embedding Model").setDesc("Model used for embedding vault files. Changing this requires re-embedding all files.");this.addEmbeddingModelDropdown(t),e.createEl("h3",{text:"Sync Configuration"}),new g.Setting(e).setName("Auto Sync").setDesc("Automatically sync file changes to Letta").addToggle(n=>n.setValue(this.plugin.settings.autoSync).onChange(async s=>{this.plugin.settings.autoSync=s,await this.plugin.saveSettings()})),new g.Setting(e).setName("Sync on Startup").setDesc("Sync vault to Letta when Obsidian starts").addToggle(n=>n.setValue(this.plugin.settings.syncOnStartup).onChange(async s=>{this.plugin.settings.syncOnStartup=s,await this.plugin.saveSettings()})),e.createEl("h3",{text:"Chat Configuration"}),new g.Setting(e).setName("Show Reasoning Messages").setDesc("Display AI reasoning messages in the chat (useful for debugging)").addToggle(n=>n.setValue(this.plugin.settings.showReasoning).onChange(async s=>{this.plugin.settings.showReasoning=s,await this.plugin.saveSettings()})),new g.Setting(e).setName("Enable Streaming").setDesc("Use streaming API for real-time responses (disable for slower but more stable responses)").addToggle(n=>n.setValue(this.plugin.settings.enableStreaming).onChange(async s=>{this.plugin.settings.enableStreaming=s,await this.plugin.saveSettings()})),new g.Setting(e).setName("Focus Mode").setDesc("When enabled, only the currently active file is opened in the agent context, all other files are closed").addToggle(n=>n.setValue(this.plugin.settings.focusMode).onChange(async s=>{this.plugin.settings.focusMode=s,await this.plugin.saveSettings(),s&&await this.plugin.applyFocusMode()})),e.createEl("h3",{text:"Actions"}),new g.Setting(e).setName("Connect to Letta").setDesc("Test connection and setup agent").addButton(n=>n.setButtonText("Connect").setCta().onClick(async()=>{await this.plugin.connectToLetta()})),new g.Setting(e).setName("Sync Vault").setDesc("Manually sync all vault files to Letta").addButton(n=>n.setButtonText("Sync Now").onClick(async()=>{await this.plugin.syncVaultToLetta()}))}async addEmbeddingModelDropdown(e){try{let t=await this.plugin.makeRequest("/v1/models/embedding");e.addDropdown(n=>{t.forEach(s=>{s.handle&&n.addOption(s.handle,s.handle)}),n.setValue(this.plugin.settings.embeddingModel),n.onChange(async s=>{s!==this.plugin.settings.embeddingModel&&(await this.showEmbeddingChangeConfirmation(s)?(this.plugin.settings.embeddingModel=s,await this.plugin.saveSettings(),await this.deleteSourceForReembedding()):n.setValue(this.plugin.settings.embeddingModel))})})}catch(t){console.error("Failed to fetch embedding models:",t),e.addText(n=>n.setPlaceholder("letta/letta-free").setValue(this.plugin.settings.embeddingModel).onChange(async s=>{this.plugin.settings.embeddingModel=s,await this.plugin.saveSettings()}))}this.containerEl.createEl("h3",{text:"Advanced Actions"}),new g.Setting(this.containerEl).setName("Delete and Recreate Source").setDesc("Delete the current source and recreate it. This will remove all synced files and require a fresh sync.").addButton(t=>t.setButtonText("Delete & Recreate Source").setClass("mod-warning").onClick(async()=>{await this.showDeleteSourceConfirmation()&&await this.deleteAndRecreateSource()}))}async showEmbeddingChangeConfirmation(e){return new Promise(t=>{let n=new g.Modal(this.app);n.setTitle("Change Embedding Model");let{contentEl:s}=n;s.createEl("p",{text:`Changing the embedding model from "${this.plugin.settings.embeddingModel}" to "${e}" requires re-embedding all vault files.`}),s.createEl("p",{text:"This will:",cls:"setting-item-description"});let o=s.createEl("ul");o.createEl("li",{text:"Delete the existing source and all embedded content"}),o.createEl("li",{text:"Re-upload and re-embed all vault files"}),o.createEl("li",{text:"Take some time depending on vault size"}),s.createEl("p",{text:"Do you want to proceed?",cls:"mod-warning"});let a=s.createEl("div",{cls:"modal-button-container"});a.createEl("button",{text:"Cancel"}).addEventListener("click",()=>{n.close(),t(!1)}),a.createEl("button",{text:"Proceed with Re-embedding",cls:"mod-cta mod-warning"}).addEventListener("click",()=>{n.close(),t(!0)}),n.open()})}async deleteSourceForReembedding(){try{this.plugin.source&&(await this.plugin.makeRequest(`/v1/sources/${this.plugin.source.id}`,{method:"DELETE"}),this.plugin.source=null,new g.Notice("Existing source deleted. Re-syncing vault with new embedding model..."),this.plugin.settings.autoSync&&setTimeout(()=>{this.plugin.syncVaultToLetta()},1e3))}catch(e){console.error("Failed to delete source for re-embedding:",e),new g.Notice("Failed to delete existing source. You may need to manually delete it.")}}async showDeleteSourceConfirmation(){return new Promise(e=>{let t=new g.Modal(this.app);t.setTitle("Delete and Recreate Source");let{contentEl:n}=t;n.createEl("p",{text:"This will permanently delete the current source and all synced files from Letta."}),n.createEl("p",{text:"This action will:",cls:"setting-item-description"});let s=n.createEl("ul");s.createEl("li",{text:"Delete the existing source and all embedded content"}),s.createEl("li",{text:"Create a new empty source"}),s.createEl("li",{text:"Require a fresh sync of all vault files"}),s.createEl("li",{text:"Remove all existing file associations"}),n.createEl("p",{text:"This action cannot be undone. Are you sure you want to proceed?",cls:"mod-warning"});let o=n.createEl("div",{cls:"modal-button-container"});o.createEl("button",{text:"Cancel"}).addEventListener("click",()=>{t.close(),e(!1)}),o.createEl("button",{text:"Delete & Recreate",cls:"mod-cta mod-warning"}).addEventListener("click",()=>{t.close(),e(!0)}),t.open()})}async deleteAndRecreateSource(){try{new g.Notice("Deleting existing source..."),this.plugin.source&&await this.plugin.makeRequest(`/v1/sources/${this.plugin.source.id}`,{method:"DELETE"}),this.plugin.source=null,new g.Notice("Creating new source...");let t=(await this.plugin.makeRequest("/v1/models/embedding")).find(a=>a.handle===this.plugin.settings.embeddingModel);if(!t)throw new Error(`Embedding model ${this.plugin.settings.embeddingModel} not found`);let n=this.plugin.settings.lettaBaseUrl.includes("api.letta.com"),s={name:this.plugin.settings.sourceName,instructions:"A collection of markdown files from an Obsidian vault. Directory structure is preserved in filenames using '__' as path separators."};n||(s.embedding_config=t);let o=await this.plugin.makeRequest("/v1/sources",{method:"POST",body:s});this.plugin.source={id:o.id,name:o.name},new g.Notice("Source recreated successfully. You can now sync your vault files.")}catch(e){console.error("Failed to delete and recreate source:",e),new g.Notice("Failed to delete and recreate source. Please check your connection and try again.")}}async showAgentSelector(){try{let e=await this.plugin.makeRequest("/v1/agents");if(!e||e.length===0){new g.Notice("No agents found. Please create an agent first.");return}return new Promise(t=>{let n=new g.Modal(this.app);n.setTitle("Select Agent");let{contentEl:s}=n;s.createEl("p",{text:"Choose an agent to use with this Obsidian vault:",cls:"setting-item-description"});let o=s.createEl("div",{cls:"letta-agent-list"});e.forEach(l=>{let r=o.createEl("div",{cls:"letta-agent-item"}),c=r.createEl("div",{cls:"letta-agent-info"});c.createEl("div",{text:l.name,cls:"letta-agent-item-name"}),c.createEl("div",{text:`ID: ${l.id}`,cls:"letta-agent-item-id"}),l.description&&c.createEl("div",{text:l.description,cls:"letta-agent-item-desc"}),r.createEl("button",{text:"Select",cls:"mod-cta"}).addEventListener("click",async()=>{this.plugin.settings.agentId=l.id,this.plugin.settings.agentName=l.name,await this.plugin.saveSettings();try{await this.plugin.setupAgent(),new g.Notice(`Selected and connected to agent: ${l.name}`);let u=this.app.workspace.getLeavesOfType($)[0];u&&u.view instanceof R&&await u.view.updateChatStatus()}catch(u){console.error("[Letta Plugin] Failed to connect to selected agent:",u),new g.Notice(`Selected agent ${l.name}, but failed to connect: ${u.message}`)}n.close(),this.display(),t()})}),s.createEl("div",{cls:"modal-button-container"}).createEl("button",{text:"Cancel"}).addEventListener("click",()=>{n.close(),t()}),n.open()})}catch(e){console.error("Failed to fetch agents:",e),new g.Notice("Failed to fetch agents. Please check your connection and try again.")}}};
