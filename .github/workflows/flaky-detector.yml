name: Flaky Tests Detector

on:
  schedule:
    # –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∫–∞–∂–¥—ã–π –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫ –≤ 10:00 UTC (–ø–æ—Å–ª–µ weekly-audit)
    - cron: '0 10 * * 1'
  workflow_dispatch: # –ü–æ–∑–≤–æ–ª—è–µ—Ç –∑–∞–ø—É—Å–∫–∞—Ç—å –≤—Ä—É—á–Ω—É—é

jobs:
  detect-flaky:
    runs-on: ubuntu-latest
    continue-on-error: true # –ù–µ –ø–∞–¥–∞–µ—Ç –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö, —Ç–æ–ª—å–∫–æ —Å–æ–±–∏—Ä–∞–µ—Ç –æ—Ç—á—ë—Ç—ã
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4.1.1
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4.0.2
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Collect CI metrics (if needed)
        id: collect
        continue-on-error: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "üìä Collecting CI metrics..."
          if [ ! -f ".ci-metrics/ci-metrics.json" ] || [ -z "$(cat .ci-metrics/ci-metrics.json 2>/dev/null)" ]; then
            echo "‚ö†Ô∏è  CI metrics not found, collecting recent runs..."
            # –°–æ–±–∏—Ä–∞–µ–º –º–µ—Ç—Ä–∏–∫–∏ –¥–ª—è –ø–æ—Å–ª–µ–¥–Ω–∏—Ö 10 workflow runs
            npm run ci:metrics:collect -- --workflow="Docs CI" || echo "‚ö†Ô∏è  Failed to collect metrics"
          else
            echo "‚úÖ CI metrics file exists"
          fi

      - name: Detect flaky tests
        id: detect
        continue-on-error: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NOTION_API_KEY: ${{ secrets.NOTION_API_KEY }}
        run: |
          echo "üîç Detecting flaky tests..."
          npm run flaky:detect -- --days=7 --threshold=30 || echo "‚ö†Ô∏è  Flaky detection completed with warnings"

      - name: Generate flaky report
        id: report
        continue-on-error: true
        run: |
          echo "üìÑ Generating flaky report..."
          npm run flaky:detect:report || echo "‚ö†Ô∏è  Report generation completed with warnings"

      - name: Upload flaky reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: flaky-tests-reports-${{ github.run_id }}
          path: |
            .flaky-reports/*.json
            .flaky-reports/*.md
          retention-days: 30

      - name: Comment on PR (if triggered by PR)
        if: github.event_name == 'pull_request'
        continue-on-error: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ -f ".flaky-reports/flaky-tests-report.md" ]; then
            echo "üí¨ Adding comment to PR..."
            REPORT=$(cat .flaky-reports/flaky-tests-report.md)
            gh pr comment ${{ github.event.pull_request.number }} --body "$REPORT" || echo "‚ö†Ô∏è  Failed to add comment"
          fi

