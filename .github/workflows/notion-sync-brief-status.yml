name: Notion Brief Status Sync

# –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å—Ç–∞—Ç—É—Å–æ–≤ Brief –≤ Notion –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∏ –º–µ—Ä–∂–µ PR

on:
  pull_request:
    types: [opened, closed]

jobs:
  sync-brief-on-pr-opened:
    if: github.event_name == 'pull_request' && github.event.action == 'opened'
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4.1.1
      
      - name: Setup Node
        uses: actions/setup-node@v4.0.2
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Sync Brief status (PR opened)
        env:
          NOTION_API_KEY: ${{ secrets.NOTION_API_KEY }}
          GITHUB_REPO: ${{ github.repository }}
        run: |
          PR_NUMBER="${{ github.event.pull_request.number }}"
          PR_TITLE="${{ github.event.pull_request.title }}"
          PR_URL="${{ github.event.pull_request.html_url }}"
          echo "üîÑ Syncing Brief status for PR #$PR_NUMBER (opened)"
          node scripts/sync-brief-status.mjs \
            --event=opened \
            --pr-number="$PR_NUMBER" \
            --pr-title="$PR_TITLE" \
            --pr-url="$PR_URL" || echo "‚ö†Ô∏è Brief status sync failed (non-blocking)"

  sync-brief-on-pr-merged:
    if: github.event_name == 'pull_request' && github.event.action == 'closed' && github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4.1.1
      
      - name: Setup Node
        uses: actions/setup-node@v4.0.2
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Sync Brief status (PR merged)
        env:
          NOTION_API_KEY: ${{ secrets.NOTION_API_KEY }}
          GITHUB_REPO: ${{ github.repository }}
        run: |
          PR_NUMBER="${{ github.event.pull_request.number }}"
          PR_TITLE="${{ github.event.pull_request.title }}"
          echo "üîÑ Syncing Brief status for PR #$PR_NUMBER (merged)"
          node scripts/sync-brief-status.mjs \
            --event=closed \
            --pr-number="$PR_NUMBER" \
            --pr-title="$PR_TITLE" \
            --merged=true || echo "‚ö†Ô∏è Brief status sync failed (non-blocking)"
