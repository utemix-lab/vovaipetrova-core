name: Notion import to docs

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  import:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Ensure unzip
        run: sudo apt-get update -y && sudo apt-get install -y unzip
      
      - name: Unzip export (fixed path)
        run: |
          set -e
          ZIP_PATH="uploads/notion_export.zip"
          if [ ! -f "$ZIP_PATH" ]; then
            echo "ZIP not found at $ZIP_PATH"; exit 1
          fi
          mkdir -p tmp/unzip docs
          unzip -q "$ZIP_PATH" -d tmp/unzip || true
          # Дополнительно распакуем возможные части
          find tmp/unzip -maxdepth 1 -type f -name 'ExportBlock--Part-*.zip' -print0 | xargs -0 -I{} unzip -q "{}" -d tmp/unzip || true
      
      - name: Copy raw export into docs
        run: |
          shopt -s dotglob
          cp -R tmp/unzip/* docs/ 2>/dev/null || true
      
      - name: Commit changes
        run: |
          git config user.name github-actions
          git config user.email actions@users.noreply.github.com
          git add docs
          if git diff --cached --quiet; then
            echo "No changes to commit."
          else
            git commit -m "chore: import Notion export (raw)"
            git push
          fi
