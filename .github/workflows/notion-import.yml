name: Notion Import (Safe PR)

on:
  workflow_dispatch:
    inputs:
      zip_path:
        description: 'Path to Notion export ZIP (relative to repo, e.g. uploads/notion_export.zip)'
        required: true
        default: 'uploads/notion_export.zip'
      branch_suffix:
        description: 'Suffix for notion-sync branch (YYYY-MM-DD или свободный текст)'
        required: true
        default: 'manual'
  push:
    branches:
      - 'notion-sync/**'
    paths:
      - 'docs/**/*.md'
      - 'uploads/**/*.zip'

jobs:
  import-check:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Resolve inputs
        id: inputs
        run: |
          ZIP_INPUT="${{ github.event.inputs.zip_path }}"
          if [ -z "$ZIP_INPUT" ]; then
            echo "zip_path input is required" >&2
            exit 1
          fi

          ABS_ZIP="$GITHUB_WORKSPACE/$ZIP_INPUT"
          if [ ! -f "$ABS_ZIP" ]; then
            echo "❌ ZIP not found at $ABS_ZIP" >&2
            exit 1
          fi

          SUFFIX_INPUT="${{ github.event.inputs.branch_suffix }}"
          if [ -z "$SUFFIX_INPUT" ]; then
            SUFFIX_INPUT="manual"
          fi

          SANITIZED_SUFFIX=$(echo "$SUFFIX_INPUT" | tr '[:upper:]' '[:lower:]' | tr -cs 'a-z0-9._-' '-' | sed 's/^-*//;s/-*$//')
          if [ -z "$SANITIZED_SUFFIX" ]; then
            SANITIZED_SUFFIX="manual"
          fi

          BRANCH_NAME="notion-sync/$SANITIZED_SUFFIX"

          echo "zip_abs=$ABS_ZIP" >> "$GITHUB_OUTPUT"
          echo "zip_rel=$ZIP_INPUT" >> "$GITHUB_OUTPUT"
          echo "branch_suffix=$SANITIZED_SUFFIX" >> "$GITHUB_OUTPUT"
          echo "branch_name=$BRANCH_NAME" >> "$GITHUB_OUTPUT"

      - name: Create working branch
        run: git switch -c "${{ steps.inputs.outputs.branch_name }}"

      - name: Unpack Notion export (if ZIP in uploads/)
        id: unpack
        run: |
          if [ -d "uploads" ] && [ -f "${{ steps.inputs.outputs.zip_abs }}" ]; then
            echo "has_zip=true" >> $GITHUB_OUTPUT
            NOTION_IMPORT_ZIP="${{ steps.inputs.outputs.zip_abs }}" npm run unpack:notion
          else
            echo "has_zip=false" >> $GITHUB_OUTPUT
            echo "ℹ️ No ZIP files in uploads/, skipping extraction"
          fi
        continue-on-error: false

      - name: Check import safety
        id: safety
        run: node scripts/check-import-safety.mjs
        continue-on-error: false

      - name: Import halted
        if: steps.safety.outputs.status == 'halt'
        run: |
          echo "Import halted: ${{ steps.safety.outputs.halt_reason }}"
          echo "Skipping normalization and PR creation."

      - name: Run normalize
        if: steps.safety.outputs.status != 'halt'
        id: normalize
        run: npm run normalize
        continue-on-error: false

      - name: Fix links
        if: steps.safety.outputs.status != 'halt'
        id: fixlinks
        run: npm run fix:links
        continue-on-error: false

      - name: Lint docs
        if: steps.safety.outputs.status != 'halt'
        id: lint
        run: npm run lint:docs || true  # Не валит, только предупреждения

      - name: Check for changes
        if: steps.safety.outputs.status != 'halt'
        id: changes
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi

      - name: Summarize changes
        if: steps.safety.outputs.status != 'halt' && steps.changes.outputs.has_changes == 'true'
        id: summary
        run: |
          node <<'EOF'
          const { execSync } = require('child_process');
          const { readFileSync, writeFileSync } = require('fs');
          const matter = require('gray-matter');

          const diffRaw = execSync('git diff --name-status --find-renames HEAD', { encoding: 'utf8' }).trim();
          if (!diffRaw) {
            writeFileSync('import-diff.md', 'No changes detected\n');
            process.exit(0);
          }

          const rows = [];
          const lines = diffRaw.split('\n').filter(Boolean);

          const getNotionId = (file) => {
            try {
              const content = readFileSync(file, 'utf8');
              return matter(content).data?.notion_page_id || '-';
            } catch {
              try {
                const content = execSync(`git show HEAD:${file}`, { encoding: 'utf8', stdio: ['ignore', 'pipe', 'ignore'] });
                return matter(content).data?.notion_page_id || '-';
              } catch {
                return '-';
              }
            }
          };

          for (const line of lines) {
            const parts = line.split('\t');
            const status = parts[0];
            if (status.startsWith('R')) {
              const from = parts[1];
              const to = parts[2];
              rows.push({
                file: to,
                action: 'move',
                reason: `Renamed from ${from}`,
                notion: getNotionId(to)
              });
            } else if (status === 'A') {
              const file = parts[1];
              rows.push({
                file,
                action: 'add',
                reason: 'Added file',
                notion: getNotionId(file)
              });
            } else if (status === 'M') {
              const file = parts[1];
              rows.push({
                file,
                action: 'update',
                reason: 'Updated content',
                notion: getNotionId(file)
              });
            } else if (status === 'D') {
              const file = parts[1];
              rows.push({
                file,
                action: 'delete',
                reason: 'Removed file',
                notion: getNotionId(file)
              });
            } else {
              const file = parts[parts.length - 1];
              rows.push({
                file,
                action: status,
                reason: 'Unhandled status',
                notion: getNotionId(file)
              });
            }
          }

          const header = '| File | Action | Reason | notion_page_id |\n| --- | --- | --- | --- |\n';
          const body = rows.map(row => {
            const fileCell = `\`${row.file}\``;
            const reasonCell = row.reason ? row.reason.replace(/\r?\n/g, ' ') : '-';
            const notionCell = row.notion || '-';
            return `| ${fileCell} | ${row.action} | ${reasonCell} | ${notionCell} |`;
          }).join('\n');

          writeFileSync('import-diff.md', header + body + '\n');
          console.log(`Generated import-diff.md with ${rows.length} entries`);
          EOF
          echo "summary_path=import-diff.md" >> "$GITHUB_OUTPUT"

      - name: Upload import diff
        if: steps.safety.outputs.status != 'halt' && steps.changes.outputs.has_changes == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: import-diff
          path: ${{ steps.summary.outputs.summary_path }}

      - name: Commit changes
        if: steps.safety.outputs.status != 'halt' && steps.changes.outputs.has_changes == 'true'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add -A
          git commit -m "chore: normalize imported Notion docs [skip ci]" || exit 0

      - name: Determine PR status
        if: steps.safety.outputs.status != 'halt'
        id: pr_status
        run: |
          if [ "${{ steps.safety.outcome }}" == "success" ] && [ "${{ steps.normalize.outcome }}" == "success" ] && [ "${{ steps.fixlinks.outcome }}" == "success" ]; then
            echo "status=ready" >> $GITHUB_OUTPUT
            echo "label=auto:ready-for-review" >> $GITHUB_OUTPUT
          else
            echo "status=needs-fixes" >> $GITHUB_OUTPUT
            echo "label=auto:needs-fixes" >> $GITHUB_OUTPUT
          fi

      - name: Push branch and open PR
        if: steps.safety.outputs.status != 'halt' && steps.changes.outputs.has_changes == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          BRANCH_NAME: ${{ steps.inputs.outputs.branch_name }}
          BRANCH_SUFFIX: ${{ steps.inputs.outputs.branch_suffix }}
          ZIP_REL: ${{ steps.inputs.outputs.zip_rel }}
          PR_LABEL: ${{ steps.pr_status.outputs.label }}
          IMPORT_DIFF_PATH: ${{ steps.summary.outputs.summary_path }}
          NEEDS_REVIEW: ${{ steps.safety.outputs.needs_review }}
        run: |
          git push -u origin "$BRANCH_NAME"

          TITLE="Notion Import (${BRANCH_SUFFIX})"
          BODY_FILE=$(mktemp)
          cat <<'EOF' > "$BODY_FILE"
Manual import via workflow_dispatch.

- zip_path: ZIP_PLACEHOLDER
- branch: BRANCH_PLACEHOLDER

This PR was created automatically by the Notion Import workflow.
EOF

          sed -i "s|ZIP_PLACEHOLDER|$ZIP_REL|g" "$BODY_FILE"
          sed -i "s|BRANCH_PLACEHOLDER|$BRANCH_NAME|g" "$BODY_FILE"

          if [ -n "$IMPORT_DIFF_PATH" ] && [ -f "$IMPORT_DIFF_PATH" ]; then
            {
              echo ""
              echo "---"
              echo "### Import diff"
              echo ""
              cat "$IMPORT_DIFF_PATH"
            } >> "$BODY_FILE"
          fi
          LABEL_FLAGS=(--label "auto:import")
          if [ -n "$PR_LABEL" ]; then
            LABEL_FLAGS+=(--label "$PR_LABEL")
          fi
          if [ "$NEEDS_REVIEW" = "true" ]; then
            LABEL_FLAGS+=(--label "auto:needs-review")
          fi

          if gh pr create --base main --head "$BRANCH_NAME" --title "$TITLE" --body-file "$BODY_FILE" "${LABEL_FLAGS[@]}"; then
            echo "PR created."
          else
            echo "PR already exists, attempting to update..."
            PR_NUMBER=$(gh pr list --head "$BRANCH_NAME" --json number --jq '.[0].number')
            if [ -z "$PR_NUMBER" ]; then
              echo "❌ Unable to create or locate PR for $BRANCH_NAME" >&2
              exit 1
            fi
            CURRENT_BODY=$(gh pr view "$PR_NUMBER" --json body --jq '.body')
            if [ -n "$CURRENT_BODY" ]; then
              printf "%s\n" "$CURRENT_BODY" > "$BODY_FILE"
            else
              cat <<'EOF' > "$BODY_FILE"
Manual import via workflow_dispatch.

- zip_path: ZIP_PLACEHOLDER
- branch: BRANCH_PLACEHOLDER

This PR was created automatically by the Notion Import workflow.
EOF
              sed -i "s|ZIP_PLACEHOLDER|$ZIP_REL|g" "$BODY_FILE"
              sed -i "s|BRANCH_PLACEHOLDER|$BRANCH_NAME|g" "$BODY_FILE"
            fi

            if [ -n "$IMPORT_DIFF_PATH" ] && [ -f "$IMPORT_DIFF_PATH" ]; then
              {
                echo ""
                echo "---"
                echo "### Import diff"
                echo ""
                cat "$IMPORT_DIFF_PATH"
              } >> "$BODY_FILE"
            fi

            ADD_LABELS="auto:import"
            if [ -n "$PR_LABEL" ]; then
              ADD_LABELS="$ADD_LABELS,$PR_LABEL"
            fi
            if [ "$NEEDS_REVIEW" = "true" ]; then
              ADD_LABELS="$ADD_LABELS,auto:needs-review"
            fi
            gh pr edit "$PR_NUMBER" --title "$TITLE" --body-file "$BODY_FILE" --add-label "$ADD_LABELS"
          fi
          rm -f "$BODY_FILE"

