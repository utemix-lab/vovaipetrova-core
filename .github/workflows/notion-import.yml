name: Notion Import (Safe PR)

on:
  workflow_dispatch:
    inputs:
      branch_name:
        description: 'Branch name for import (e.g., notion-sync/2025-01-15)'
        required: true
        default: 'notion-sync/YYYY-MM-DD'
  push:
    branches:
      - 'notion-sync/**'
    paths:
      - 'docs/**/*.md'

jobs:
  import-check:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Check import safety
        run: node scripts/check-import-safety.mjs

      - name: Run normalize
        run: npm run normalize

      - name: Fix links
        run: npm run fix:links

      - name: Lint docs
        run: npm run lint:docs || true  # Не валит, только предупреждения

      - name: Check for changes
        id: changes
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi

      - name: Create or update PR
        if: steps.changes.outputs.has_changes == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'chore: normalize imported Notion docs [skip ci]'
          title: 'Notion import: normalize and validate'
          body: |
            Автоматический импорт из Notion с нормализацией.
            
            - ✅ Проверка безопасности (deny_paths)
            - ✅ Нормализация front matter
            - ✅ Исправление ссылок
            - ✅ Линтинг документов
            
            **Проверь изменения перед merge!**
          branch: ${{ github.event.inputs.branch_name || github.ref_name }}
          delete-branch: true
