name: Notion import to docs

on:
  workflow_dispatch:
    inputs:
      zip_path:
        description: 'Path to Notion export zip inside repo (e.g., uploads/notion_export.zip)'
        required: true

jobs:
  import:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Prepare docs folder
        run: |
          rm -rf docs tmp_unzip
          mkdir -p docs

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Unpack with Python (Unicode-safe)
        run: |
          python3 << 'PYEOF'
          import zipfile
          import os
          import sys
          import shutil
          
          zip_path = "${{ github.event.inputs.zip_path }}"
          
          if not os.path.exists(zip_path):
              print(f"âŒ Error: {zip_path} not found!")
              sys.exit(1)
          
          print(f"ðŸ“¦ Unpacking: {zip_path}")
          
          # ÐŸÐµÑ€Ð²Ð°Ñ Ñ€Ð°ÑÐ¿Ð°ÐºÐ¾Ð²ÐºÐ°
          os.makedirs('tmp_unzip', exist_ok=True)
          with zipfile.ZipFile(zip_path, 'r') as zf:
              zf.extractall('tmp_unzip')
          print("âœ… First unpack done")
          
          # Ð˜Ñ‰ÐµÐ¼ Ð²Ð»Ð¾Ð¶ÐµÐ½Ð½Ñ‹Ð¹ ZIP
          inner_zip = None
          for root, dirs, files in os.walk('tmp_unzip'):
              for f in files:
                  if f.endswith('.zip'):
                      inner_zip = os.path.join(root, f)
                      break
              if inner_zip:
                  break
          
          # Ð Ð°ÑÐ¿Ð°ÐºÐ¾Ð²ÐºÐ° Ð² docs
          if inner_zip:
              print(f"ðŸ“¦ Found inner zip: {inner_zip}")
              with zipfile.ZipFile(inner_zip, 'r') as zf:
                  zf.extractall('docs')
              print("âœ… Inner zip unpacked to docs/")
          else:
              print("ðŸ“ No inner zip, moving tmp_unzip/* to docs/")
              for item in os.listdir('tmp_unzip'):
                  src = os.path.join('tmp_unzip', item)
                  dst = os.path.join('docs', item)
                  if os.path.exists(dst):
                      shutil.rmtree(dst) if os.path.isdir(dst) else os.remove(dst)
                  shutil.move(src, dst)
          
          print("âœ… Unpack complete!")
          PYEOF

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install normalizer deps
        run: |
          npm install gray-matter yaml glob slugify

      - name: Normalize front matter and filenames
        run: |
          node scripts/normalize.mjs

      - name: Commit normalized docs
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add docs
          git status
          git diff --cached --stat
          git commit -m "chore: import Notion export + normalize" || echo "No changes to commit"

      - name: Push changes
        run: |
          git push || echo "Nothing to push"
