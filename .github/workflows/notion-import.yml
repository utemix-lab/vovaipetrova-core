name: Notion import to docs

on:
  workflow_dispatch:
    inputs:
      zip_path:
        description: 'Path to Notion export zip inside repo (e.g., uploads/notion_export.zip)'
        required: true

jobs:
  import:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Prepare docs folder
        run: |
          rm -rf docs tmp_unzip
          mkdir -p docs

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Unpack with Python
        run: |
          python3 << 'PYEOF'
          import zipfile
          import os
          import sys
          import shutil
          
          zip_path = "${{ github.event.inputs.zip_path }}"
          
          if not os.path.exists(zip_path):
              print(f"Error: {zip_path} not found!")
              sys.exit(1)
          
          print(f"Unpacking: {zip_path}")
          
          os.makedirs('tmp_unzip', exist_ok=True)
          with zipfile.ZipFile(zip_path, 'r') as zf:
              zf.extractall('tmp_unzip')
          print("First unpack done")
          
          inner_zip = None
          for root, dirs, files in os.walk('tmp_unzip'):
              for f in files:
                  if f.endswith('.zip'):
                      inner_zip = os.path.join(root, f)
                      break
              if inner_zip:
                  break
          
          if inner_zip:
              print(f"Found inner zip: {inner_zip}")
              with zipfile.ZipFile(inner_zip, 'r') as zf:
                  zf.extractall('docs')
              print("Inner zip unpacked to docs")
          else:
              print("No inner zip, moving content to docs")
              for item in os.listdir('tmp_unzip'):
                  src = os.path.join('tmp_unzip', item)
                  dst = os.path.join('docs', item)
                  if os.path.exists(dst):
                      shutil.rmtree(dst) if os.path.isdir(dst) else os.remove(dst)
                  shutil.move(src, dst)
          
          print("Unpack complete")
          PYEOF

      - name: Commit changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add docs
          git commit -m "chore: import Notion export" || echo "No changes"

      - name: Push
        run: |
          git push || echo "Nothing to push"
