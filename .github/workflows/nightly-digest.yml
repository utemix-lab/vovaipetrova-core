name: Nightly Digest Episode

on:
  schedule:
    # 02:00 UTC = 05:00 Europe/Moscow
    - cron: "0 2 * * *"
  workflow_dispatch:

jobs:
  generate-digest:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - uses: actions/checkout@v4.1.1
        with:
          fetch-depth: 0

      - uses: actions/setup-node@v4.0.2
        with:
          node-version: 20
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Generate digest episode
        run: node scripts/generate-nightly-digest-episode.mjs

      - id: meta
        run: |
          if [ ! -f tmp/digest-episode-meta.json ]; then
            echo "created=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          node <<'EOF'
          const fs = require('fs');
          const meta = JSON.parse(fs.readFileSync('tmp/digest-episode-meta.json', 'utf8'));
          const output = fs.createWriteStream(process.env.GITHUB_OUTPUT, { flags: 'a' });
          output.write(`created=${meta.created}\n`);
          if (meta.file) output.write(`file=${meta.file}\n`);
          if (meta.title) output.write(`title=${meta.title}\n`);
          if (meta.sources) output.write(`sources=${meta.sources.join(', ')}\n`);
          output.end();
          EOF

      - name: Check for changes
        id: git_status
        run: |
          if git diff --quiet docs/stories; then
            echo "changed=false" >> "$GITHUB_OUTPUT"
          else
            echo "changed=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Prepare branch
        if: steps.meta.outputs.created == 'true' && steps.git_status.outputs.changed == 'true'
        run: |
          BRANCH="chore/digest-episode-$(date -u +%Y-%m-%d)"
          git checkout -b "$BRANCH"
          git add docs/stories
          git commit -m "chore: digest episode $(date -u +%Y-%m-%d) (draft)" || exit 0
          git push -u origin "$BRANCH" || exit 0
          echo "BRANCH_NAME=$BRANCH" >> "$GITHUB_ENV"

      - name: Create PR
        if: steps.meta.outputs.created == 'true' && steps.git_status.outputs.changed == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_BRANCH: ${{ env.BRANCH_NAME }}
          DIGEST_TITLE: ${{ steps.meta.outputs.title }}
          DIGEST_SOURCES: ${{ steps.meta.outputs.sources }}
        run: |
          BODY="Автогенерирован дайджест-эпизод: ${DIGEST_TITLE:-без названия}.

Источники: ${DIGEST_SOURCES:-CI metrics, Diagnostics}.
Workflow: nightly-digest.yml (02:00 UTC / 05:00 Europe/Moscow)."
          gh pr create \
            --base main \
            --head "$PR_BRANCH" \
            --title "chore: digest episode $(date -u +%Y-%m-%d) (draft)" \
            --body "$BODY" \
            --label auto:story \
            --label lane:stories || echo "PR already exists or failed"
